una de las primeras cosas que vamos a ver dentro de esta acción formativa que tiene que ver con dispositivos de cálculo y de computación dentro de cualquier tipo de máquina es la cantidad de cuatro núcleos de procesamiento esta gráfica puede encontrarse en prácticamente cualquier sistema operativo reciente cualquier sistema operativo moderno y básicamente esta gráfica nos dice Cuántos procesadores tenemos y además nos dice qué carga tenemos ahora mismo en cada uno de ellos bien en este caso antes de empezar a grabar Este vídeo pues tenía vamos a verlo por aquí tenía una cierta carga del sistema operativo pero a partir de que he empezado a grabar el vídeo pues evidentemente estoy usando un programa que eh distribuye la carga entre diferentes procesadores y por tanto veo como la carga pues ha subido bien en este caso por tanto nos dejamos este procesador aquí y o esta gráfica aquí y vamos a demostrar primero cuál es el problema y luego cuál es una de las soluciones es decir el problema es que cuando creamos un programa ese programa por regla general A menos que nosotros lo digamos no es capaz de distribuirse entre diferentes procesadores pero a continuación veremos la solución para este problema así que voy a sacar un editor de texto no importa cuál vamos a verlo voy a sacar un editor de texto con el que pueda escribir código en este caso voy a trabajar con javascript y lo que voy a hacer en este caso es que aquí por ejemplo voy a crear una carpeta llamada procesos y dentro de esta carpeta voy a guardar un archivo dentro de escritorio procesos llamado Index 1. html Así que lo que voy a hacer ahora Dentro de este documento vamos a hacerlo un poco más grande para que lo podamos ver mejor vamos a poner 16 píxeles de tamaño bien doc type html voy a crear la estructura básica para un documento vale Y ahora a continuación voy a abrir un pequeño javascript y ese javascript en esta ocasión quiero que haga una operación realmente Bueno más que compleja realmente que sea una operación costosa Así que voy a hacer lo siguiente bar número es igual a 0.000 y unos cuantos números vamos a ver qué pasa vamos a poner un punto y coma al final y ahora a continuación voy a hacer un bucle for largo voy a hacer bar iteraciones es igual a muchísimas iteraciones y digo for bar I es ig 0 Y es menor que iteraciones y más y por ejemplo quiero multiplicar número es igual a número multiplicado por 1. y unos cuantos números más La idea es que quiero realizar una serie de operaciones básicas una serie de operaciones Pues bueno digamos básicas pero complejas que sean muchas aciones Así que console pun log voy a poner aquí hecho y vamos a abrir este vamos a abrir este javascript vamos a abrirlo con el navegador y vamos a verlo vemos como el navegador está calculando y vemos como también la carga en las cpus en los cuatro núcleos de la cpu ha subido pero sin embargo Aunque ha subido vamos a esperar Aunque ha subido finalmente no ocupa los cuatro núcleos no ocupa Los Cuatro cores de procesamiento y por tanto digamos estoy infrautilizando el procesador lo que está ocurriendo es que vamos a esperar vamos a poner un poquito menos de iteraciones quizás me he pasado un poco vale vamos a verlo paramos al parar esperaremos el procesador vale Y ahora voy a ejecutarlo de nuevo vamos a ver se ha quedado un poco frito Vamos allá consola hecho bueno Vale parece que podemos ponerle unos pocos ceros más vamos a verlo ahí hecho un cero más y ahora sí vemos como tarda un momento y al final nos da el resultado Bueno nos dice hecho y de hecho si queremos Pues también podemos decirle que queremos ver el resultado Podríamos sacar por la consola el número vamos a verlo y hecho y número vamos a ver cuál es el número que ha salido entonces a continuación voy a querer saber cuánto tiempo ha tardado el programa en sacar la información Bueno Este es el número que tengo al final bien es un número perfectamente válido Bueno ahora quiero No ya calcular a Ojo el tiempo que ha pasado desde el principio hasta el final sino que lo que quiero es calcular con precisión cuánto tiempo ha tardado el programa para eso vamos a utilizar la librería de que tiene javascript y para eso lo que haré es comparar en un momento dado pues como digo el tiempo que ha pasado por ejemplo con Los Minis segundos de la época unix bien Así que ahora lo que voy a hacer en este caso es que voy a introducir voy a sacar primero Cuál es la fecha en este momento y a continuación voy a sacar Cuál es la fecha al final En cuanto a la fecha la voy a sacar en un formato un poco especial que es el número de milisegundos que han pasado desde el día 1 de enero de 1970 es una referencia es lo que se llama la época unix la era unix en la cual Pues digamos que el tiempo se mide a partir de ese momento Así que a continuación voy a hacer lo siguiente voy a decir eh creo una constante que se llama tiempo inicio y le voy a decir que es date punto Now Así que tengo por aquí el tiempo de inicio y quiero sacar console.log el tiempo inicio guardo y recargo el procesador como vemos empieza a funcionar el procesador como vemos intenta repartir la carga entre los diferentes núcleos esto lo hace directamente cada uno de los Eh bueno cada uno de los navegadores Y en este caso nos dice que el tiempo al inicio era este de aquí Este es el tiempo unix en este caso en milisegundos como digo es el número de milisegundos que han pasado desde el día 1 de enero de 1970 hasta ahora mismo bien Ahora lo que voy a hacer es decirle al sistema que quiero el tiempo final y por tanto al final voy a decir el tiempo requerido para usar o para digamos trabajar o para calcular Este programa ha sido de más y ahora evidentemente tiempo final menos tiempo inicio Así que si todo va bien Vamos allá guardamos recargamos y vamos a ver cuánto tiempo nos dice vamos a verlo bien y nos dice que el tiempo requerido para calcular Este programa ha sido de 16807 milisegundos o lo que es lo mismo eh 16 segundos vale pero con los milisegundos calculados bueno en este caso eh podemos observar como estamos infrautilizando los recursos de cálculo que tenemos en este ordenador ahora mismo tengo cuatro núcleos de cálculo pero da igual Aunque tuviera ocho núcleos de cálculo Aunque tuviera 16 núcleos de cálculo finalmente seguiría utilizando uno de estos núcleos de cálculo lo que quiero decir En definitiva es que Cuanto más potente sea mi ordenador más lo voy a infrautilizar si no aprendo a trabajar programando aprovechando los diferentes núcleos ahora vamos a hacer otra cosa vamos a indicarle al sistema que esto es el cálculo uno pero a continuación en este programa quiero hacer un cálculo dos un cálculo 3 y un cálculo 4 cálculo 3 y cálculo 4 vamos a poner un console punto log para saber qué es lo que está ocurriendo vamos con el cálculo un voy a ponerlo sin acentos cálculo 2 cálculo 3 cálculo 4 aquí es cuando llegamos a otro cuello de botella importante porque vamos con el cálculo un y el programa se queda detenido en el cálculo un Hasta que el programa no acaba el cálculo un no va a empezar el cálculo dos lo estamos viendo aquí en el monitor en el vamos a ver aquí voy hacerlo un poco más grande lo estamos viendo aquí ahora vemos Qué ha pasado con el cálculo dos vamos vemos que ha pasado al cálculo 2 una vez que acabe el cálculo 2 empezará el cálculo Y luego el cálculo cuat y el problema es que mientras tanto podemos observar fácilmente en la Gráfica de rendimiento como pues prácticamente tenemos la mitad de nuestro ordenador tenemos el 50% de nuestra capacidad de proceso sin utilizar Así que en este caso como nos podemos imaginar a continuación Nuestro objetivo va a ser utilizar aprender a utilizar esa Potencia de cálculo vamos a comprobar Cuál es el tiempo final para anotarlo más que nada vamos a por ello y nos dice que el tiempo requerido para calcular Este programa ha sido de 64171 milisegundos o lo que es lo mismo 64 segundos a continuación quedémonos con este número quedémonos con este valor quedémonos con este dato y lo que voy a hacer a continuación es empezar a trabajar distribuyendo la potencia entre varios procesadores para comprobar Cuál es nuestra ganancia de rendimiento para ello lo que voy a hacer Es que voy a guardar este Index como siguiente versión Index 2 y a continuación aquí me voy a ir a otro archivo Así que vengo por aquí abro Index 2 no quiero cambiar Index 1 Más que nada porque no quiero perder este dato de aquí porque luego lo quiero comparar evidentemente Así que ahora vengo por aquí y eh lo que voy a hacer es decir bar número de núcleos Quiero saber cuántos núcleos de procesador eh tengo ahora mismo en este ordenador entonces Digo e Navigator punto Hardware concurrency Así que vengo por aquí y digo console pun log el ordenador en el que estás ahora mismo tiene más número de núcleos para que no me aparezca error de javascript para que no me aparezca error de javascript eh voy a poner la etiqueta meta charset es igual utf8 para que los acentos se interpreten correctamente y vemos como para empezar este cu proviene de esta variable número de núcleos y vemos como efectivamente si aquí hay cuatro gráficas es decir si realmente el procesador tiene cuatro núcleos pues vemos como ahí indica que tiene realmente cuatro núcleos vemos como tiene cuatro núcleos para procesar bien pues ahora ación lo que quiero hacer es utilizar esos cuatro núcleos quiero decirle al programa que realmente quiero hacer uso de esos cuatro núcleos diferentes para eh para trabajar y esto lo voy a hacer evidentemente cada programa digamos cada lenguaje de programación tiene sus propias estrategi estrategias para trabajar con múltiples núcleos en mi caso voy a utilizar una estrategia que se llama eh workers los workers digamos los trabajadores son elementos que nos van a permitir trabajar con múltiples núcleos vamos a verlos bien a continuación vamos a hacer lo siguiente voy a crear vamos a verlo por aquí vamos a verlo voy a crear un archivo nuevo voy a copiar el anterior web voy a copiar la anterior lo voy a guardar como Index 3 bien y ahora voy a demostrar el uso de un worker Así que para ello voy a hacer lo siguiente voy a decir bara trabajador es igual a worker ya sabemos que si algo lo pongo en español es porque lo podemos cambiar es porque podemos poner lo que queramos pero si algo lo pongo en inglés es porque tiene que estar así que worker es una un objeto una clase que existe en el navegador web en cualquier navegador web moderno y digo tarea js es una tarea que va a llevar a cabo el worker entonces a continuación lo que voy a hacer es un poco estar pendiente de qué es lo que me dice este worker y voy a decir trabajador on message cuando el trabajador me envíe un mensaje de vuelta voy a decir function y console.log el trabajador ha dicho algo de momento no va a decir nada No creo que G nada vamos a verlo digo tres vale Y me dice en este caso me dice que yo he prometido que va a existir un archivo llamado tarea js pero no existe ese archivo tarea js Así que no pasa nada voy a crear un archivo llamado tarea js y ahora a continuación vamos a ver OK Vamos a recargar y vamos a ver bien en este caso dice que el origin es null Es decir que lo estoy intentando cargar directamente desde Bueno desde el sistema de archivos y lo que voy a hacer es decirle que lo voy a cargar desde un servidor web local entonces voy a pasarlo Aquí voy a pasarlo a htdocs aquí vale lo paso a procesos Lo abro desde ahí y ahora Lo único es que he tenido que cerrar el navegador No pasa nada acordémonos de que antes teníamos una marca de 64 segundos vale Y por tanto local Host procesos Index 3 html bien Vamos a inspeccionar okay vale vamos a consola y ya está Esto es lo que nos dice ahora ya no tenemos el error del servidor Esto es lo que nos dice el worker Y es que de momento no nos dice nada pero no pasa nada porque a continuación lo que vamos a hacer es que el worker realmente diga algo entonces vamos a por ello vamos a cargar mi tarea js y voy a hacer lo siguiente vamos a ver por una parte lo que voy a hacer es decirle Eh pues simplemente digamos al a la tarea que diga algo post message y te digo Hola desde la tarea Okay así que recargo y te digo el trabajador ha dicho algo el trabajador ha dicho algo qué ha dicho bueno fijémonos el message lo que hace es Escuchar qué es lo que dice el trabajador y el post message lo que hace es Elevar un mensaje desde el trabajador hasta la tarea principal ya tenemos un medio de comunicación unidireccional mediante el cual el trabajador es capaz de enviarle mensajes a la tarea principal o sea el trabajador dice cosas la tarea principal escucha vamos a ver qué dice datos entonces Quiero saber lo que ha dicho el trabajador ha dicho algo datos recargo me dice en este caso que ha dicho algo vamos a ver console.log datos Y así lo vemos en crudo y así el sistema no saca en crudo y nos dice como podemos ver en la pantalla nos dice datos. datata nos dice el trabajador ha dicho algo te digo Hola desde la tarea ya tenemos este medio de comunicación unidireccional pero ahora Quiero comunicarme también en la otra dirección quiero decirle al trabajador algo entonces vamos a hacer lo siguiente vamos a hacer lo siguiente voy a decirle trabajador postmessage con esto le digo algo Hola y entonces a la tarea le puedo decir que on message en este caso va en minúsculas curiosamente es igual a function y te digo Hola desde la tarea Qué es lo que ocurre aquí pues lo que ocurre aquí es que solo se envía un post message cuando se recibe un on message es decir la tarea Está quieta esperando a que le den un mensaje y cuando le dan un mensaje entonces es cuando dice hola desde la tarea recargamos y en este caso dice Exactamente lo mismo voy a hacer una cosa voy a quitar el post message y comprobaremos que no ocurre nada Es decir el post message desde la tarea principal lo que hace es enviarle un mensaje al trabajador el trabajador lo que hace es Escuchar si alguien le envía un mensaje y si alguien le envía un mensaje de vuelta y por tanto la tarea principal escucha un mensaje de vuelta puede parecer un poco complejo realmente tiene mucha lógica Pero lo importante es que ya tenemos por aquí un medio de comunicación multidireccional ya tenemos por aquí un medio de comunicación bidireccional para comunicar las tareas con la tarea principal y ahora Lo importante es que dentro de lo que es digamos la tarea principal pues podemos calcular nuevas tareas podemos crear tantas tareas como necesitemos vamos a por ello ahora lo que voy a hacer dentro de esta tarea es decirle al sistema que quiero traer quiero importar el Index 1. html Quiero realizar este cálculo lo voy a copiar voy a pegar dentro de tarea y lo que voy a hacer en post message Es que voy a lanzar el número voy a devolver el número Así que vamos allá recargamos vamos a verlo recargamos Aquí vemos que el programa ahora Se pondrá a funcionar a ver un segundo Index 3 no se va a poner a funcionar porque no le estoy enviando mensaje ahora se va a poner a funcionar vamos con el cálculo uno y dice el trabajador ha dicho algo el trabajador en este caso nos devuelve un número concreto Pero lo importante es que la ejecución no se ha parado la ejecución no se ha detenido Mientras que el programa estaba calculando bien qué es lo que voy a hacer ahora Bueno pues lo que voy a hacer ahora es crear una serie de workers donde cada uno de los workers como ahora veremos se va a colocar en un núcleo diferente de procesamiento vamos a verlo a continuación para ello voy a guardar este archivo como Index 4. html vale vamos a copiar algo de lo que teníamos en Index 2 tenemos número de núcleos vale Y ahora digo bar núcleo es igual a o trabajador es igual a New worker y voy a cargar el archivo tarea 2.js no es New aray Perdón ahora sí es una nueva colección de algo y ahora entonces digo for bar I es ig a 0 Y es menor que número de núcleos y má ahora sí le voy a decir trabajador de I es igual Ahora sí a New worker tarea 2.js esto es muy importante porque lo que he hecho por tanto ya no es un solo worker sino que he hecho un conjunto de workers he hecho un conjunto de diferentes workers en este caso evidentemente tantos workers como núcleos de procesamiento tengo en el sistema y ahora una vez que he creado diferentes workers lo que voy a hacer es enviarles un mensaje voy a decir trabajador de I punto post message y voy a decir comienza simplemente un mensaje de bienvenida ahora en la tarea voy a guardar esta tarea como tarea 2s y realmente la tarea 2s va a tener prácticamente lo mismo que la tarea un vamos a verlo vamos con un cálculo Ok post message número vale Y yo creo que ya está y simplemente le voy a decir al sistema que le voy a decir al sistema que trabajador de I on message voy decir function datos y console pun log datos. datata bien si todo va bien si todo va bien Ahora lo que voy a hacer es recargar en Index 3 vamos a verlo ahí el trabajador ha dicho algo vamos a verlo en principio vamos a verlo lo ha hecho muy rápido a ver estoy viendo si lo ha hecho o no lo ha hecho y En definitiva debería tener cuatro cu vamos a verlo por aquí Ah estoy en Index 4 claro es el problema muy bien vale trabajador ion message is not a function vale New worker trabajador on message Ah sí Perdón es igual a function Ahora sí vale recargo dice vamos con el cálculo y ahora me devuelve cuatro números diferentes que de hecho son los mismos pero fijémonos que eh lo que ha hecho el sistema en este caso es decirle que bueno que quiero calcular hay una cosa que me extraña y es que he hecho el mismo Exacto cálculo y ha tardado una barbaridad menos que trabajando en la tarea principal vamos a poner ese mismo cálculo recargamos y el programa devuelve el cálculo es decir No solo vemos que lo está calculando mucho más rápido sino que además vemos en ese pico de ahí que ahora Realmente está utilizando los múltiples sistemas de cálculo que necesite Además yo ahora puedo venir por aquí y decir bueno no quiero solo tener estas iteraciones quiero tener más iteraciones así que como podemos ver pues estamos trabajando ahora con cuatro núcleos de procesamiento y sobre todo lo importante es que si nos fijamos ahora en el procesador veremos que cada uno de esos núcleos de procesamiento cada uno de esos workers está trabajando de forma independiente y eso quiere decir que estamos utilizando Ahora sí el procesador en su plena expresión también evidentemente vamos a tener que enfrentar nuevos retos porque trabajar con workers evidentemente equivale a trabajar con tareas paralelas tareas que en principio son independientes entre sí tareas que se tienen que pasar información entre sí y En definitiva esto nos va a suponer nuevos retos pero a la vez una vez que hacemos esto también como podemos comprobar pues podemos desbloquear la potencia del ordenador y podemos realmente aprovechar todos los procesadores que tenga un ordenador concreto que además pues cada día son mayores a continuación en los siguientes ejercicios lo que vamos a hacer es eh analizar Cómo podemos sacarle partido Cómo podemos sacarle rendimiento a Esta técnica de programación mediante la cual vamos a poder usar los núcleos de programación de forma independiente hay una cosa interesante de todas formas que es la siguiente y Es que voy a bajar un poco los números de cálculo Y es que yo puedo lanzar más tareas qué Hilos de procesamiento tengo esto quiere decir que yo por ejemplo en este caso voy a esperar a que acabe este hilo si no lo puedo matar pero bueno no pasa nada eh Por cierto que si vengo por aquí al monitor vamos a ver cpu vale bueno no nos muestr los procesos una pena vale Pero quería que nos mostraran los subprocesos para que viéramos pues qué estaba usando realmente bien Vamos a verlo Vale entonces como decía no tenemos por qué no tenemos por qué quedarnos con tantos núcleos como tengamos evidentemente Es recomendable vale pero voy a poner por ejemplo que quiero 100 procesos quiero 100 workers qué es lo que va a hacer el programa si yo le pido 100 tareas y tengo cuatro procesadores bueno no va a pasar nada no va a pasar nada porque sobre todo lo que quiero ahora un momento es matar esta tarea para que finalice así que voy a matarla vale Okay perfecto bien y ahora he hecho un proceso más pequeño he hecho 100 procesos más grandes y vamos allá y vemos como lo que va a hacer el programa como vemos ahí es que tenemos 100 procesos ahora en cuanto el historial de la cpu se refresque pues veremos Cómo Pues bueno se pone al 100% De hecho yo diría que está bloqueado Yo diría que está parado Sí está muy bloqueado vamos a verlo cpu al 100% ahí lo tenemos de vuelta vale ventana historial de la cpu y por tanto lo que hace el programa ahora se refrescarán básicamente es repartir los 100 procesos entre los núcleos de procesamiento que tenga entonces pues hay evidentemente Cuantos más núcleos de procesamiento tenga pues mejor como digo creo que me he pasado Ah mira yo creo que ya lo tengo por aquí ya lo tengo por aquí de vuelta ahí lo vemos tengo ya los 100 resultados tengo ya ahí los núcleos corriendo Vale ahora volverá el sistema Pero bueno lo que comentaba hay diferentes estrategias una estrategia es un programa Y si tengo cuatro núcleos de procesamiento es partirlo por cuatro bloques y enviar cada bloque a su núcleo y hay otra estrategia ya iremos viendo a lo largo de los vídeos que consiste en hacer muchos cachitos diferentes y pequeños e irlos enviando dinámicamente a tantos núcleos como haya para procesar trabajar con múltiples procesos tiene sus cosas tiene su sus particularidades como que por ejemplo cada proceso es un mundo diferente vamos a guardar este proyecto como Index 5 voy a guardar tarea dos como tarea cinco y así un poco la idea es buscar una consonancia en la numeración de las tareas y con esto voy a demostrar lo siguiente voy a Index 5 y por ejemplo por aquí voy a crear una variable bar edad es igual a 43 por ejemplo entonces si yo he creado una variable lo que voy a hacer a continuación es meterme en la tarea 5 Por cierto me voy a meter en la tarea y en la tarea voy a decir console pun log edad o tu edad es dos puntos más edad si ahora ejecuto esto si ahora ejecuto esta este código vamos a verlo procesos Index inspeccion consola bien vemos que en este caso Bueno aparte de que he hecho no sé cuántos procesos hecho 100 voy a hacer No sé voy a hacer Bueno número de núcleos Y así vamos sobre seguro Bueno pues lo que ocurre en pantalla es que nos dice que erad is not defined erad is not defined lo cual quiere decir que yo haya declarado una variable aquí no quiere decir en absoluto más bien al contrario que la variable sea visible dentro de la tarea entonces Cómo puedo hacer que la variable sea visible que los datos viajen de una parte a otra pues los tengo que pasar como datos Así que a continuación me voy aquí a edad y digo quiero vamos a ver quiero post message Dónde está post message aquí post message y lo que voy a hacer es que en lugar de pasar un mensaje que no tiene ningún valor en cuanto a datos que es comienza Pues le voy a pasar la edad entonces vengo por aquí ahora me voy a tarea 5 js recojo los datos lugar de decir console log tu edad es lo que sea voy a decir console pun log datos a ver qué sale así que recargo por aquí y nos dice en este caso que tenemos unos datos tenemos un Data que es 43 Y entonces me dice Y entonces me dice Puedo pasar por cierto un jas puedo pasar cosas tu edad es edad punto No datos punto Data yo ahora vengo por aquí y me dice tu edad es 43 esto por supuesto no ha hecho que la variable sea visible dentro del worker porque eso no se puede hacer pero sí que por lo menos lo que ha hecho es pasarle el dato al worker y así el worker puede trabajar con el dato le podemos pasar datos al worker el worker puede trabajar con sus propios datos dentro del worker podemos hacer un poco lo que queramos hay ciertas limitaciones emente Eso sí pero En definitiva siempre o sea no podemos pasar de todo no podemos pasar datos gráficos por ejemplo porque el worker No soporta un contexto gráfico ahora lo comprobaremos pero En definitiva hay cosas que sí que podemos hacer vamos a hacer a otra ahora otra demostración donde vamos a pasar un pequeño jotas son porque qué es lo que ocurriría si quisiéramos pasar pues múltiples datos pues podríamos pasarlos como jas entonces por ejemplo pongo por aquí javascript simple jas voy a hacer un jas pequeñito a ver bueno uno pequeñito como Este vale pero no esto evidentemente ahora veremos Entonces yo me voy a Index 5 y quiero decirle que edad es igual a 3 y nombre es igual a José Vicente Entonces en este caso voy a decir que bar J son es igual a voy a hacer un objeto realmente y voy a decer que edad vamos a ver edad es 2 pun 43 coma nombre es José Vicente podría haberlo puesto directamente con las variables pero bueno entonces ahora lo que voy a hacer voy a recargar tengo de momento lo mismo pero lo que voy a hacer en este caso ahora es pasar el jas entonces en el post message paso en lugar de la edad paso directamente al Jason en la tarea 5 voy a matar un momento esto quiero solo los datos Así que recargo Y si nos fijamos en los datos Tenemos aquí en el Data Tenemos aquí que ha pasado correctamente pues la los datos tenemos edad 45 Y tenemos nombre José Vicente vemos cómo han pasado como datos independientes y entonces yo ahora puedo por ejemplo decir lo siguiente puedo decir tu edad es datos. datata edad y console log tu nombre es más datos punata nombre así que guardamos y recargamos y nos dice tu edad 45 tu nombre es José Vicente En definitiva vemos como podemos pasar datos es decir los datos no son transparentes de una parte a otra del programa pero eh las funciones de on message y las funciones de post message eh soportan el pase de datos de una parte a otra y soportan tanto el pase de datos en formato sencillo como en formato de objeto como En definitiva en cualquier otro formato Y eso En definitiva como digo nos habré much las puertas para poder realizar múltiples tipos de cálculos cómo vamos a poder ver como vamos a ver a continuación un ejemplo clásico de trabajo con múltiples procesos y con múltiples núcleos es el tratamiento de imágenes más que nada porque para demostrar el uso de procesos siempre tenemos que buscar escenarios complejos tenemos que buscar escenarios que computacionalmente sean complejos y sean intensos y un ejemplo es el tratamiento de imágenes entonces yo voy a abrir el gimp o cualquier otro programa de edición de imágenes voy a abrir una fotografía vamos a verla vale voy a abrir una fotografía vamos a escritorio no vamos a vaya Bueno vamos a volumes vamos a datos vamos a fotos mis fotos yo vamos a una de estas vale por ejemplo esta la vamos a recortar ok La quiero rotar vamos a recortar el trozo que me interesa bien y supongamos que quiero realizar pues una serie de filtros una serie de operaciones Como por ejemplo difuminar como por ejemplo Buscar bordes como ejemplo lo que sea tengamos en cuenta que esta imagen tiene 3500 píxeles por 4200 píxeles eso quiere decir que esta imagen ahora mismo 3536 por 4208 tiene 14 millones de píxeles eso quiere decir que si yo ahora por ejemplo hago un software que tenga que realizar operaciones sobre esta imagen va a ser un software que como mínimo solo con que realice unaer con cada píxel y ya va a tener que realizar 14 casi 15 millones de operaciones entonces por eso digo que el trabajo con imágenes es un trabajo clásico digamos de distribución En múltiples procesadores es un trabajo donde realmente se agradece Se aprecia tener varios procesadores a nuestra disposición Bueno voy a cargar alguna imagen por tanto voy a cargar una imagen en la que salga favorecido a ver un momentín fotos yo de carpeta habrá alguna que esté bien a ver un mín permitidme el momento a Mira qué guapo que estoy ahí Hala Ya está apañado pues voy a esa fotografía vamos a ver si quiero rotar Voy a prepararla un poco vale Voy a recortarla con un dónde estás recorte eh No veo el recorte Así que estará por aquí escondido Aquí bien proporción uno a uno voy a quedarme con ese trozo de la imagen y ahora lo que voy a hacer es que bueno esta imagen tiene 3280 voy a bajarla eh pero no demasiado entonces voy a aquí perdón a imagen voy a tamaño de la imagen escalar la imagen voy a hacer 2048 un número redondo digamos hablando refiriéndome a potencias de dos le doy a escalar Vale entonces ahora guardo esta imagen la guardo en vamos a verlo en applications la guardo en mamp la guardo en htdoc la guardo en procesos y voy a guardarla como pues jpg estamos hablando de una imagen que al final tiene vamos a verlo por aquí exportar una imagen que tiene una vez más calculadora 2048 x 2048 tiene pues 4 millones de píxeles y por tanto 4 millones de operaciones y eso que ahora haré también operaciones que serán más complejas todavía es decir operaciones que involucrarán a más de un píxel Entonces ahora lo que voy a hacer Es que voy a crear un archivo llamado Index 5. html no Index 6 perdón html y en esta en este archivo lo que voy a hacer es crear la estructura básica Bien voy a crear un Canvas Esto va a ser ID de Lienzo y voy a decir al sistema que wid es igual a 2048 height es igual a 2048 estamos hablando de una imagen que ocupa 1,2 megas o sea es una imagen grande digamos y entonces digo bar contexto vamos a verlo por aquí un momento que minimice esto bar contexto es igual a document.get Element byid y punto get context 2D Esto está mal porque debería estar haciéndolo dentro de una etiqueta Script Así que ahora sí y get context 2D y ahora lo que hago es cargar la imagen bar Photo es ig a New image y foto. src es igual a José Vicente pun jpg bien me espero un segund set Time out podría decirle que también cuando la foto cargue haga no sé qué Pero bueno da igual voy a hacer un Time out function y esto lo quiero en 2 segundos Entonces quiero contexto draw image y quiero dibujar la foto en 0 si esto ha ido bien cargo Index 6 y como digo la imagen está aquí cargada voy a quitar un momento esto ahora luego iremos a esto voy a hacer menos zoom y observo que básicamente lo que he hecho es pintar la imagen he dibujado la imagen en este Lienzo de 2048 por 2048 es decir he pintado una imagen de 2048 por 2048 en un Lienzo de 2048 por 204 hasta aquí no hay mucho misterio Pero lo bueno va a venir en lo que vamos a hacer ahora que va a ser básicamente empezar a tratar la imagen a continuación por tanto una vez que hemos dibujado el Lienzo lo que voy a hacer es hacer alguna operación con el Lienzo Entonces yo digo lo siguiente bar píxeles es igual a contexto get image Data y quiero los datos desde 0,0 hasta 2048 es decir estoy cogiendo todo el pack de píxeles Y entonces ahora lo que voy a hacer ahora lo que va a ocurrir es que eh voy a empezar a trabajar con la imagen vale voy a empezar a eh como diría yo hacer cosas con la imagen en este caso tengamos en cuenta que eh Por cierto que voy a poner Bueno sí píxeles Ahora voy a hacer un bucle for para recorrer la imagen tengamos en cuenta que la imagen está compuesta por en el array que he creado Está compuesto por bloques de cuatro cada bloque de cuatro datos representa un píxel y esos cuatro datos son rojo verde azul y transparencia entonces digo forb I es = 0 Y es menor que pixeles pun Data length y voy a decir I + = 4 porque como digo lo que quiero hacer es ir píxel a píxel vale este bloque de contenido lo que hace es ir píxel a píxel lo que voy a hacer también evidentemente es eh Como este código ya se va a empezar a complicar es empezar a comentar poco a poco el código entonces vengo por aquí y digo cargamos el contexto de la imagen en una variable Y entonces vengo por aquí voy a comentar creamos un nuevo objeto de tipo imagen vengo por aquí le indicamos Cuál es el archivo informático al que corresponde esa imagen por aquí ejecuto una función con cierto retraso para darle tiempo al programa a cargar la imagen bien cuidado con esto porque se nos va Vale y dibujo la imagen en el Lienzo y ahora aquí lo que hago realmente es atrapo todos los datos de la imagen en una matriz realmente es un objeto Pero bueno más que una colección y ahora recorro esa imagen cada cuatro bloques porque cuatro piezas de contenido representan a un píxel bien Y hasta ahora configurar el brackets para que no salte de línea en cada uno de los elementos pero ahora mismo no lo veo por aquí no Line no pasa nada bueno no pasa nada cerramos por aquí y cerramos por aquí vale ahora a continuación lo que hago es decir lo siguiente vamos a ver digo píxeles pun datata di esto es el color rojo es igual a 0 no es igual a 255 men píxeles pun dat de o sea lo que estoy haciendo es invertirlo ahora veremos y + 1 y + 1 y + 2 y má dos aquí lo que estoy haciendo como digo es invierto el canal rojo de la imagen invierto el canal verde de la imagen y aquí invierto el canal azul de la imagen tengamos en cuenta que para esto que para que esto funcionara correctamente debería también el elemento tres pero no lo estoy cogiendo porque es la transparencia y no quiero invertir la transparencia solo quiero invertir los colores Entonces ahora lo que voy a hacer es volver Aquí no aquí vamos a verlo por aquí momentín vale Entonces momentín esto por aquí volvemos a la imagen ahora también lo que podemos hacer es decirle al Body con una etiqueta Style decirle al Body que eh Body text align Center más que nada para que Wow ahí más que nada para que me Centre la imagen bien Ya he invertido los píxeles Pero en ningún momento estoy poniendo los píxeles de vuelta en la imagen así que vengo por aquí y digo eh contexto punto put image Data y le digo que pongo la imagen pongo píxeles en 0,0 recargamos por aquí esperamos un momento y como podemos comprobar en la pantalla lo que ha hecho el programa es invertir la imagen y sobre todo invierte la imagen tras haber realizado en este caso pues la operación con los píxeles voy a comentar este código y digo por último ponemos la imagen de vuelta dentro del Lienzo Cuando digo de vuelta quiero decir después de haber procesado los píxeles Así que voy a utilizar voy a aprovechar información de proyectos anteriores para ver digamos Cuánto es el tiempo que tardo en realizar esta operación para ello puedo reutilizar vamos a ver esto ha sido en Index 1 creo recordar vamos a verlo eh aquí el tiempo de inicio en Index 6 y aquí lo pongo técnicamente puedo empezar aquí ahora calculo el tiempo final en Index 6 y por último hago un console punto log del tiempo comentamos calculo el tiempo de inicio y lo pongo en una variable calculo el tiempo de finalización y lo pongo en otra variable y muestro palla la diferencia entre los tiempos de inicio y los tiempos de finalización Así que si todo ha ido bien vamos a poner esto en un lateral Aunque eso es un poco lo de menos pongo por aquí la consola recargo la pantalla y nos dice en este caso que el tiempo requerido para calcular Este programa ha sido de 33 milisegundos Eso quiere decir que bueno es un tercio de segundo algo y ojo que esta es una operación muy sencilla desde el punto de vista en el que solo incluye a un Pixel Pero si por ejemplo hago otra operación más compleja vamos a hacerlo ahora a continuación eh que incluya más píxeles pues veremos como el tiempo en este caso será mayor voy a programar a continuación una un pequeño método de cálculo sobre la imagen que se va que se llama Busca bordes lo que va a hacer es buscar los bordes y básicamente pues lo que va a hacer es eh detectar si hay bordes digamos con respecto a la imagen o si lo que tiene son colores sólidos para ello Tendremos que hacer que cada píxel se fije en los píxeles vecinos y esto evidentemente lo que va a hacer es que el programa tarde más y por tanto nos introducirá este problema que tendremos que solucionar mediante un cálculo Eh pues dividido digamos entre diferentes procesadores vamos a por ello bien pues a continuación lo que voy a hacer ahora es decirle al sistema vamos a ver un momentín aquí vale Voy a decirle al sistema que por cierto bueno Vale Voy a decirle al sistema que quiero crear una función que básicamente lo que haga es eh fijarse en los píxeles vecinos Entonces esta es la función que recorre píxel a píxel voy a borrar esto Si quieres lo voy a guardar como Index 7 y así no perdemos ningún ejercicio vale elimino esto se ha quedado guardado en Index 6 ahora mismo Estoy en Index 7 y píxel a píxel lo que voy a hacer es generar un cuadrado vamos a decir lo siguiente bar anchura y esto lo que va hacer es pues mirar digamos cuánto aquí realmente lo que voy a hacer vale s estoy pensando vale bien anchura es igual a por ejemplo 4 y esto es una variable esta variable va a almacenar la anchura del cuadrado de y Entonces eso quiere decir que yo ahora voy a otro sub cuadrado entonces y ahora vengo y digo lo siguiente bar sub cuadrado es igual a contexto get image Data y necesito averiguar Cuál es el píxel digamos así que bueno para este caso lo que puedo hacer vamos a verlo lo que puedo hacer es lo siguiente digo for bar x es igual a 0 x es menor a 2448 x + má y ahora digo lo mismo para y Pues ahora lo que quiero esto es la y ahora lo que quiero es eh bar sub cuadrado es igual a contexto get image Data desde x os anchura y men anchura hasta anchura por dos y anchura por 2 eso lo que va a hacer es un cuadradito de la imagen esta variable ya no me interesa ahora mismo al menos bien Y entonces ahora lo que quiero hacer es comparar eh cada uno de los valores cada uno de los valores Quiero ver si los píxeles son iguales o son diferentes o como son para ello ahora sí tengo que for bar y es igual a 0 vamos a verlo y es menor que sub cuadrado Data length y más y ahora como digo lo que voy a hacer es editar voy a empezar a trabajar con la información de cada uno de los píxeles y lo que tengo que hacer básicamente es mirar Cuál es la información del centro con respecto a la información de los bordes esto que quiere decir Bueno pues esto lo que quiere decir es que si yo vengo por aquí voy a decir bar centro es igual a contexto get image Data de x y 1 y entonces le digo bar centro rojo es igual a centro de cero bar centro verde es igual a centro de un y bar centro azul es igual a centro de do ahora como digo lo que voy a tener que hacer es comparar ese píxel con el resto de píxeles que tenemos en la contornada Y entonces voy a decir lo siguiente bar borde es igual a false voy a decir que no hay ningún borde Y entonces digo que si centro r voy a hacerlo por rojos en este caso si centro r si el valor absoluto perdón si el valor absoluto de Centro r menos vamos a ver menos sub cuadrado de I que es el rojo es menor o es mayor que 50 en ese caso voy a decir que borde no Border sino borde es igual a true y por tanto lo que haré en este caso es decirle al sistema que quiero pintar digamos un borde quiero indicar que sí que hay un borde para eso voy a crear otro Lienzo será bueno que cree otro Lienzo destino voy a el contexto del Lienzo destino contexto destino Lienzo destino vale Y entonces voy a por aquí bar datos destino es igual a contexto destino punto get image Data de 0,0 a 2048 Y entonces hago lo siguiente si borde es igual a false va a pasar una cosa si no va a pasar otra y lo que va a pasar es lo siguiente lo que va a pasar es que contexto destino punto vamos a ver punto dónde estás punto No datos destino Perdón datos destino punto Data a ver un segundo claro no porque tengo que pintar Ok contexto destino Style es igual a Black fill rect Voy a pintar un cuadrado en x y com 1 y entonces en caso contrario voy a poner esto de color White y datos destino con texto destino es F rect si todo ha ido bien Ahora comento este código evidentemente pero si todo ha ido bien lo que va a ocurrir en la pantalla aparte de que voy a bajar esto por el tema de los comentarios vale lo que va a ocurrir en la pantalla es que el sistema va a eh Buscar bordes vamos a por ello recargo Y si no hay ningún error Okay Index 7 Vale ahora voy a poner dos lienzos momentín vemos como el programa tarda más y es normal vamos a sacar ahora sí el la ventana del historial de la cpu voy a aquí voy a sacarlo y estamos viendo como Pues bueno lo que hace el sistema como podemos ver ahora es que está tardando bastante más en realizar el cálculo y ahora es cuando realmente Pues nos empezamos a plantear que necesitamos pues mejorar este cálculo esto que está ocurriendo es que el sistema pues está tardando una barbaridad en calcular otra cosa que puedo hacer es un poco ahora para el principio hacer que el cálculo sea un poco menos invasivo que sea menos fuerte porque pues le he puesto antes una anchura le he puesto una anchura de cuatro Pues igual con ponerle una anchura de uno ya es suficiente ahora tengo que parar este cálculo voy a arrancarlo de nuevo ahora está el otro cálculo también voy a pararlo Aunque el cálculo en workers a veces es difícil de parar Pero bueno vamos a dejarlo un momento vamos a dejarlo quieto a que acabe de calcular y ahora veremos a ver qué nos da ahí vamos a decirle bueno en este caso salir de la página aquí a ver si me deja cerrar ahora recargamos Vale y vamos a ver si ahora sí bien en este caso ya tenemos el resultado que por cierto ha tardado una barbaridad ha tardado un montón pero bueno no nada ahora iremos a ello de momento lo que estamos viendo Bueno me sale todo negro eso ya me extraña un poquito Vamos a repasar el código y entonces digo si borde es igual a false Vale entonces maz ABS centro r vamos a comprobar que todo este que todo esté correcto vamos a decirle mayor que cco y vamos a volver a calcular el caso es que como digo pues lo que está calculando tarda un montón está calculando un bloque de 9 píxeles si borde es igual a true si borde es igual a false estoy comprobando que todo esté correcto y parece que sí Entonces vamos a por ello anchura vamos a calcular recargo por aquí y lo que debe ocurrir básicamente es que en un momento dado Pues debe sacar un Lienzo en blanco y negro donde Pues digamos detecte Cuál es la variación de píxeles me extraña mucho que no haya habido deferencia de 50 píxeles en ningún píxel de la imagen pero bueno no pasa nada ahora veremos Por cierto si no s sí lo estoy haciendo correctamente vale estaba pensando si quizás me faltaba el último paso que es poner los píxeles dentro de el otro Lienzo pero no en principio no Entonces ahora lo que tenemos que hacer básicamente es esperar a que vale le decimos esperar está tomando mucho tiempo una vez más vemos que el algoritmo es ineficiente desde el punto de vista en el que pues no tiene no guarda las informaciones correctas Pero no pasa nada no utiliza al 100% la capacidad de proceso que tengo en el ordenador pero como digo no pasa nada Vamos a darle esperar Se puede también afinar el proceso Pero bueno ahora lo veremos vamos a esperar de nuevo y ahora como digo pues voy a intentar hacer que el proceso sea dentro de lo que cabe dentro de que es ineficiente pero que sea un poco pues más óptimo le vuelvo a decir esperar En definitiva esperamos a que acabe el cálculo y al final con suerte pues tend un cuadro blanco y negro le seguimos diciendo esperar bien De momento no pasa nada lo que voy a hacer en este caso es crear un algoritmo de momento un poquito más sencillo y ahora iremos a algo más complejo vamos a ver voy a hacer lo siguiente datos destino nada un momenti voy a cargar esto voy a decir bar píxeles es igual a contexto punto get image Data de 0,0 a 28,24 for bar I es = 0 Y es menor que pixeles d. length y más y ahora lo que voy a hacer es decirle que pixxel a Pixel pues quiero fijarme en el Pixel vecino en el Pixel de al lado entonces digo lo siguiente vamos a ver contexto momentín contexto put image Data Esto es lo que no creo que esto es lo que ha fallado de hecho bien entonces le digo si voy a contexto destino bar píxeles destino es igual a contexto destino punto get image Data de 0,0 a 2048 y digo por tanto qu si píxeles punto Data de que es el color rojo menos píxeles Data de I + 4 que es el píxel rojo de la derecha y ahora pongo ma. ABS quiero quedarme con el valor absoluto quiero quedarme con el valor positivo esto es menor que 20 caso en ese caso contexto destino punto Data de I es igual a c lo mismo aunque voy a hacer la operación para el rojo lo voy aplicar en el verde y en el azul y en el alfa voy a poner 255 por si acaso en caso contrario Esta es una búsqueda de bordes de un píxel es muy sencilla Pero bueno de momento no servirá Entonces si todo va bien Vamos a verlo contexto destino putim Data vamos a ver píxeles destino vamos a comprobarlo venimos por aquí recargamos voy a sacar el inspector de código bien recargo cuidado pixeles is not defined dónde Cómo que pixeles is not defined en la 45 có que en la 45 Si la 45 no hay nada texto put image Data píxeles destino estoy en Index 7 voy a ver si es que no ha actualizado bien no puedo la propiedad cero de undefined en este caso lo que me está diciendo es que no puede la propiedad cero de un elemento en este caso voy a decir pieles dat leng men cu porque el último píxel es el que está fallando vamos a verlo vale vamos a verlo hay alguien que no está cogiendo voy a poner os8 en la línea 25 está el error Ok Vale y cero es esto contexto destino curiosamente contexto destino píxeles destino ese es el problema OK recargamos ahora bien en principio no lo estoy viendo inspeccionamos Lienzo no está ahí pero está vacío entonces Bueno vamos a ver píxeles destino contexto destino punto pun image Data en principio es correcto voy a poner una cosa voy a poner 44 para saber si está operando o no pues efectivamente no está operando y ahora pues bueno podría hacer esto podría hacer contexto destino no puedo hacer el x y el y Vale pues vamos a verlo píxeles destino es igual a context destino. Gate image Data de tal y de tal vale en principio Ah I + = 4 el había puesto i + más y evidentemente eso no puede ser así que vamos a por ello Vale ahora me lo está poniendo todo negro pero si nos fijamos pero si nos fijamos hay una pequeña silueta con lo cual está empezando ya a hacer el la ejecución del programa Así que venimos por aquí y vamos a decirle aquí donde pone 44 pues vamos a poner 255 okay recargamos Vale ahora sí está empezando a buscar bordes ya tenemos el Buscar bordes y ahora básicamente pues lo que quiero es volver a generar un programa donde pues vuelva a calcular eh que en lugar de el píxel de la derecha pues coja más píxeles también voy a hacer un programa sencillo primer lugar de 3 por TR píxeles pues va a el del centro arriba abajo izquierda derecha así siempre Y así pues tendremos un cálculo que por una parte será más extenso y por otra parte será más eh más costoso de calcular bien Así que ahora me vengo por aquí y digo vale quiero esto pero lo quiero para cada uno de los píxeles digamos que tenemos a continua voy hacer una cosa voy a decir borde es igual a true Y entonces digo esto es borde es igual perdón a false esto no debería haberlo borrado en este caso voy a poner es igual a false en caso contrario borde es igual a true y ahora al final si borde es igual a true en ese caso haz algo en caso contrario haz otra cosa Y entonces hago así y entonces hago así parece que haya hecho lo mismo pero realmente no lo es entonces vuelvo recargo espero un momento y ahí lo tenemos Bueno he invertido los colores pero da igual eso para lo que es este para lo que es este proyecto es un poco indiferente Así que ahora a continuación vamos a aumentar esto a más píxeles entonces y ahora lo que quiero hacer No es solo el píxel de la derecha sino quiero eh varios píxeles entonces para ello ahora voy a la anchura voy a quitar esto y voy a decir a ver cómo lo podemos hacer bar sub cuadrado vamos a verlo es igual bueno primero tengo que sacar la x un momento voy a hacerlo de 3 por TR primero entonces If porque así ya tenemos suficiente como para ilustrar el proceso If vamos a ver ma. ABS de píxeles pun Data di menos y ahora viene la complicación Ahora quiero el píxel de arriba a la izquierda esto es píxeles punto Data de I men 4 menos 4 y esto es el píxel de arriba a la izquierda Es mayor que 30 por ejemplo ahora pondré una variable llamada umbral es igual a 30 de momento en ese caso borde es igual a true he cogido el píxel de arriba a la izquierda ahora vamos a el Pixel de arriba que es este Ahora quiero el Pixel de arriba a la derecha que es este Ahora quiero el pixxel de la izquierda que es este Ahora quiero el Pixel de la derecha que es este Ahora quiero el pixxel de abajo a la izquierda que es este Ahora quiero el Pixel de abajo que es este y ahora quiero el pixxel de abajo a la derecha que es este en lugar de estar validando únicamente contra el Pixel vecino de la derecha lo que estoy haciendo es validar contra un pequeño cuadradito digamos de tres por TR píxeles que hay en torno a este píxel si esto ha funcionado bien tengamos en cuenta que aquí ya estoy haciendo unas cuantas operaciones más si esto ha funcionado bien yo ahora recargo antes eran 317 milisegundos en calcular ahora han sido 415 vemos que el resultado tiene un poco más de calidad vale está tardando medio segundo prácticamente en realizar el cálculo con lo cual ahora lo que queremos ver es si podemos hacer el cálculo todavía más preciso pero todavía también más extenso bien Ahora a continuación lo que podemos hacer es bajar un poco el umbral por ejemplo voy a bajarlo a 20 volvemos a refrescar y Bueno ahí vemos como van apareciendo más píxeles vamos a pasarlo a 10 ahí Igual me estoy pasando un poco vamos a verlo y Bueno pues con 10 salen todavía más En definitiva lo que me importa ahora mismo lo que sobre todo me importa es Cuánto está tardando el programa en calcular esta información bien está tardando 391 milisegundos que parece que no sea demasiado tiempo es prácticamente 0,4 segundos que para una imagen puede parecer poco pero supongamos imaginemos que yo quisiera aplicar esto a un vídeo y un vídeo va a 25 fotas por segundo así que una vez más pues lo que quiero es eh rebajar los tiempos y En definitiva lo que quiero es utilizar múltiples núcleos entonces lo que voy a hacer es crear múltiples núcleos de procesamiento para este ejercicio y voy a intentar que el programa calcule esto con diferentes núcleos no va a ser un ejercicio sencillo desde el punto de vista de lo que va a tardar en transferirse la información pero vamos a ver porque vamos a dividir los cálculos y vamos a ver que incluso es posible que en principio en las primeras iteraciones del ejercicio tarde más dividiendo los cálculos que sin dividirlos porque hay que tener en cuenta lo que va a tardar en dividirlos vamos a comprobarlo y ahora veremos exactamente de qué estoy hablando vamos a venir por aquí vale Y cuando la función comienza vamos a ver tengo los píxeles Y si tengo los píxeles digamos que Eh Pues bueno aquí es cuando puedo empezar a lanzar digamos vamos a comprobar esto por aquí esto es bueno voy a poner comentarios No aquí meto toda la información de los píxeles en una variable meto la información correspondiente al Lienzo de destino y ahora lo que hago es que recorro los píxeles uno a uno y entonces en principio supongo que no hay un borde en el píxel que estoy registrando pero para cada uno para cada una de estas vamos a verlo a ver un segundo que está activando el dictado vale para cada aquí para cada uno de los píxeles compruebo si hay mucha diferencia de color o no la hay Y esto es píxel de arriba a la izquierda píxel de arriba a la derecha pixxel de la izquierda voy a poner en las preferencias el sonido en el auricular pixxel de la derecha píxel de abajo a la izquierda píxel de abajo a la derecha entonces en el caso de que sí que haya un borde coma en ese caso pinto de negro y en el caso de que no haya un borde coma en ese caso pinto de blanco y esto es lo que estoy haciendo realmente pongo la componente rojo a cero pongo la componente verde en cero pongo la componente azul en cero cuidado muy importante pongo la transparencia opaca y ahora pongo la componente roja al máximo valor pongo la componente verde al máximo valor pongo la componente Azul al máximo valor y la transparencia la sigo poniendo opaca bien Ahora puedo llevarme los comentarios a su sitio bien Y entonces ahora es cuando vamos a empezar a pasar esto a alguno de los workers vamos a crear workers en primer lugar y ahora veremos queé hacemos a continuación entonces cojo la tarea 5 js la renombro la guardo como tarea 7 js y vamos a por ello vamos a decir que de núcleos es esto de aquí así que hasta aquí número de núcleos ahora creo una Ray de trabajadores y a continuación les digo que su worker es tarea 7j vamos a enviar información el problema que tengo ahora es que me gustaría digamos que cómo diría yo me gustaría que para cada uno de los píxeles le podía enviar la información y le pudiera En definitiva eh preguntar al programa Qué es lo que tiene en los píxeles de alrededor podría enviarle la información de los píxeles yo aquí lo que quiero hacer es En definitiva enviar esta validación por ejemplo y bueno vamos a ver cómo lo podemos hacer Vamos a ver cómo lo podemos hacer porque aquí tengo un post message en este caso voy a ver exactamente qué es lo que envío se me ocurre por ejemplo por poner un ejemplo Que si tengo cuatro núcleos Pues podría enviar un cuarto de la imagen Entonces el programa me devolvería digamos ese cuarto de la imagen y luego al final lo imprimiría vamos a probar eso esa es una estrategia hay otra estrategia que consiste en partir la imagen en lo que se llaman buckets los backets son eh Pues digamos porciones de la imagen vamos Incluso si queremos acoger esta estrategia Yo quiero yo creo que incluso mejor así que en este caso lo que voy a hacer Es que voy a decirle al sistema que quiero trabajar con estos cuadraditos y cada uno de los cuadraditos será lo que envíe al sistema Entonces vamos a verlo número de núcleos bueno ahora veremos cómo lo hacemos bien ahora uno de estos cuadraditos vamos a por aquí vamos a decir anchura buet bar anchura buet es igual a no sé 32 Por ejemplo y voy a decir que eh Por ejemplo voy a algo que esté en 1024 coma anchura buet claro ahora tengo que reemplazar los parámetros en todos y cada uno de los cálculos No pasa nada y contexto destino y yo creo que esto ya está vamos a verlo recargamos bien J son not defin Sí claro porque esto todavía no lo puedo poner en marcha vale Así que cargo y si todo ha ido bien Pues bueno Ah sí cuidado vamos a 1024 por 1224 vamos a verlo lo pintamos ahí y parece que ahora ha cogido pues ese trozo que tenemos ahí en lugar de 32 pues puedo 128 No lo sé por hacer una prueba un backet En definitiva es un cuadradito de la imagen como podemos ver ahí el sistema lo que está haciendo es calcular Pues un cuadradito fijémonos que ahora el tiempo ha bajado pero tampoco ha bajado tanto porque al final el programa tiene que ponerse en marcha y eso lleva un coste es curioso vamos a ver que calculando por backets Pues igual tardamos más que en calcular de otra forma pero bueno no lo sé ahora veremos lo importante En definitiva de esta parte del ejercicio es ser capaces de partir un problema monolítico en varios sub yanto una vez que lo hayamos partido pues podemos empezar a enviar esos sub problemas a cada unidad de cálculo esto quiere decir por tanto que yo ahora podría venir por aquí voy a hacer este programa de momento monotarea y voy a hacer lo siguiente vamos a verlo voy a poner todo esto en un bucle Así que fun bcle voy a crear un temporizador Y entonces voy a decir lo siguiente voy a decir que esto de aquí y esto de aquí y bueno y realmente lo de abajo me da igual lo voy a poner en el bucle Y entonces la función temporizador es igual a set Time out quiero ejecutar el bucle en dentro de un segundo y ahora el bucle lo que va a hacer es cargar una x y una y bucle x y voy a decir esto es la x 1204 madre mía esto es la y esto es la x Y esto es la y entonces yo ahora vengo por aquí y digo bar anchura es igual a 2048 bar altura es igual a 2048 Y entonces vengo por aquí y digo Clear Time out temporizador es igual a bucle en un segundo Por lo que sea estoy introduciendo este retraso específicamente y ahora lo que voy a hacer es lo siguiente x más igual a anchura Bucket y ahora digo si x Es mayor que 48 en ese caso x es igual a 0 e Y es más igual a anchura Bucket Y eso lo que va a hacer y eso lo que va a hacer y por cierto que voy a decir que si y es igual o y es menor que 2048 pues en ese caso a ver Clear Time out en ese caso vuelve al temporizador esto por aquí y esto por aquí abajo vale vamos a ver qué es lo que va a hacer esto si todo va bien si todo va bien Esto lo que va a hacer es ir trabajando con los backets uno a uno vamos a ver el Val not type long vamos a verlo el 44 porque ahora me da es error Ah muy bien y le digo que x ig 0 bar y es ig 0 para empezar vamos a verlo y si todo va bien A ver get image Data el valor no es de tipo long en el así porque cuando paso por aquí Cuando paso por aquí bucle x coma y ahora le voy a decir bucle x y porque le tengo que pasar los valores en base a los cuales quiero analizar Bueno ahí si nos fijamos está empezando ya a calcular ahí vemos que poco a poco está empezando ya a calcular ahora ir a al debajo voy a quitar ese retraso de un segundo voy a poner un milisegundo para que el programa lo calcule lo más rápido posible vamos a verlo ahí lo vemos y vemos como estos buckets lo que están haciendo es calcular cada uno de los Trozos de forma independiente hay un pequeño defecto El pequeño defecto es pues que salen esas líneas verticales que es el final derecho de cada uno de los backets pero en principio me da igual como podemos comprobar lo que está haciendo el programa es pues calcular para cada uno de estos bloques pues lo que corresponda el tiempo como digo es mayor que si calculamos toda la imagen pero las oportunidades de dividir son mayores como nos podemos imaginar ahora a continuación lo tendremos más fácil para enviar cada buet a un worker diferente aquí tenemos Ya por fin finalizado el cálculo bien Ahora Bueno voy a hacer un poco de có diría yo de teatrillo vale Y cuando digo teatrillo lo que quiero decir es que voy a por Bueno voy a por a dibujar un poquito los backets entonces para eso aquí donde pongo contexto destino aquí Canvas voy a hacer un div ID contiene Canvas y voy a poner por aquí Lienzo destino y Lienzo backets y simplemente lo que voy a hacer ahora vamos a ver es poner el contexto backets Lienzo backets vale Y ahora en cada elemento del bucle pues lo que voy a hacer es contexto backets clearrect de 0,0 a 2048 com 2048 y ahora contexto backets fill Style es igual a red contexto backets stroke Style es igual a red y por tanto contexto backets beginpath contexto backets stroke rect de x y a anchura backet coma anchura backet y contexto backets punto stroke y si todo ha ido bien haciendo esto lo que va a ocurrir es que ahora al recargar vamos a ver momento porque ahora tengo ahí como tres backets tres momentín Vale ahora en Style le digo que contiene Canvas tiene un Wi de 2048 píxeles un High de 2048 píxeles un Pos relative y por tanto contiene Canvas le digo Pos absolute le digo top 0 píxeles y left 0 píxeles y con eso lo que voy a conseguir es que los Canvas estén uno encima del otro vamos a verlo vamos a ver los elementos contiene Canvas por qué tiene esto contiene Canvas posi relative posición absolute vamos a verlo vale contiene Canvas 2048 y un y dos esto es correcto entonces voy a decirle simplemente float left Y de esa forma bueno La idea es que flote vale bien Lienzo buckets no me está dibujando lo que quiero vamos a verlo contexto backets Lienzo backets está por delante o por detrás Lienzo destino Lienzo backets vale contexto backets Clear re voy a hacer una cosa F re no es lo que quiero hacer pero para comprobar que está funcionando eso es lo que eso es lo que quiero es un poco que se vea el cursor vamos a ver no sé por no se ve el porque se debería ver pero bueno da igual con que lo haga así pues ya me vale para que tú visualmente sepas para que tú visualmente puedas comprobar por dónde va el buet Pues ahora como digo la misión en este caso es devolver la misión es enviar cada uno de estos buckets a cada uno de los workers que en un principio puedo tener Así que vamos a por ello vamos a por ello y vamos allá y esto es lo que como podemos ver el programa está calculando con cada uno de estos backets ahí lo tenemos Vale pues vamos allá bien pues ahora si nos vamos al código ahora es cuando el código lo podemos empezar a lanzar en bueno en un en esto en un worker vamos a por los trabajadores y ahora nuestro gran reto consiste en pasar esta información a uno de los workers y que los workers nos devuelva pues verdadero o falso Así que vamos allá vamos a ver para cada uno de los trabajadores vamos a Vero estos son los contextos backets esto es otra cosa Vale y ahora vengo por aquí y ahora vengo por aquí voy a hacer un worker voy a hacer en principio un solo worker trabajadores igual a New worker y ahora lo haremos en matrices Index tarea s tarea 7 js vale Y ahora por aquí y ahora por aquí le digo trabajador punto post message y vamos a ver qué necesito lo que necesito vamos a ver qué variables estoy metiendo los píxeles y estoy metiendo el píxel de destino Bueno realmente el pixxel de destino casi que es lo que menos me preocupa entonces post message y voy a enviar Pues un pequeño Jason es igual a píxeles es igual dos puntos a píxeles bueno píxeles no esto es px es igual a píxeles coma px destino es píxeles destino Y qué más pues la i No qué es lo que necesito pues ya está la x mi x es x mi y es y yo creo que ya así que voy a enviar al jas voy a mutear un momento todo esto y en la tarea 7 on message voy a decir console.log datos voy a poner esto a un segundo y vamos a recargar Y si todo va bien vale message muy bien y Data es igual a esto de aquí mi x bueno hemos pasado de hecho los datos Así que Ok perfecto y ya está así que vale vamos a por ello estamos pasando el worker en principio todo va en principio todo va fenomenal Así que ahora vengo por aquí Ahora vengo por aquí escapo corto Pongo aquí en s y ahora evidentemente lo que tengo que hacer es intercambiar entonces digo datos vamos a ver tenemos px y px destino vale datos. datata punto px leng vale Y esto es vale momentín px correcto pxd length ahora sí es Data correcto ahora esto viene aquí ahora hablaremos de anchura backet y umbral y borde aquí aquí cuidado con los dos puntos bien Vamos a ver que además a Pixel destino esto realmente no hace falta vamos a ver vale voy a decir bar destino es igual a c y aquí Simplemente digo destino cer y voy aquí voy a decir destino igual a 255 o destino es igual a un me da igual vale Ya tengo Esto me hace falta un bral OK Y anchura backet entonces vengo por aquí paso los datos Mi umbral es umbral y mi anchura backet es anchura backet Entonces esto es vamos a ver datos Data mi anchura backet aquí y esto es datos. datata punto umbral si todo ha ido bien si todo ha ido bien le digo después de todo esto le digo eh post message y básicamente lo que quiero devolver es datos pun Data de no me acuerdo de mi x no quiero un J son es igual a mi x es igual datos. datata mi x coma mi y es datos. datata mi y ahora resultado es igual a destino le envío el jas y por tanto por ejemplo por aquí en donde sea realmente donde defino el trabajador le puedo decir que trabajador onmessage es igual a function datos console.log datos vamos a verlo puedo ya quitar este console pun log ya que creo que ya sé lo que va a salir parece que tenga aquí como datos pun datata pun K punto umbral o vale ha hay un error es mayor a datos. datata umbral umbral y umbral okay vamos a verlo recargamos a ver si hay algún error bien tranador No es tranajar es trabajador vale vamos a ver bien nos da un mensaje de momento no hace nada evidentemente nos dice mi x mi y nos da un resultado vale en el resultado básicamente lo que nos dice es si da error o no da error Esa es otra cuestión Y es que yo realmente vamos a ver ay yo realmente lo que quiero hacer es para cada uno vamos a ver tarea js vale para cada uno de los datos vamos a verlo vale para cada uno de los datos Quiero que me diga si es correcto o no vale Quiero que me diga si tiene que poner los datos o no entonces claro yo lo que tengo que hacer es para cada uno de estos datos vamos a verlo se ahora estoy consiguiendo que para cada uno de ellos me diga si sí o si no lo cual bien lo cual es correcto pero es un poco incompleto porque lo que quiero es que me dé pues unos datos finales Entonces vamos a decir lo siguiente vamos a copiar este bloque Y dónde estás Ah este bloque no está aquí vale Okay muy bien píxeles destino Vale pues me voy a tarea s vamos a verlo en el siguiente vídeo vale y ahora le digo ahora sí lo siguiente datos punto Data punto px destino punto Data de I es igual a cer vuelvo a hacer lo mismo de antes y + 1 y + 2 y + 3 recordemos que tiene que ser 255 y ahora hago así 255 y entonces digo mi x mi y resultado es igual a datos punto Data px destino es decir el elemento que he sobreescrito vamos a verlo Index 7 Vamos a hacer esto cada 10 segundos para no saturar el navegador vamos a probarlo Vale ahora vamos a por el primero No puedo leer Data of undefine de tarea 722 muy bien Vamos a ver tarea 7 22 aquí tarea 722 datos. datata px destino es px destino No lo sé vamos a ver el jas que estoy enviando px dst no es px destino es px dst guardo recargo bien y vamos a verlo nos da una serie de datos resultado undefined vale esto vamos a ver por qué es undefined px destino. datata console log datos vamos a cargarlo vamos a ver qué nos da el primero tiene un Data que es px destino que es un image Data que tiene unos datos no sé por qué me dice que el px destino es desconocido porque entonces yo vengo aquí y me dice que el resultado es undefined vale datos. d. px dst Esta es la razón porque no he cambiado la información aquí ahora sí así que recargo vale Y si todo va bien Ahora en datos tengo un image Data Y eso qué quiere decir pues eso lo que quiere decir es que yo ahora puedo venir aquí puedo atrapar estos datos y puedo ponerlos donde corresponde y puedo decir que on message ya no quiero un console sino que quiero contexto destino quiero put image Data píxeles destino No lo sé a ver html5 Canvas put image Data a ver qué parámetros tiene esta función imagen x y vale muy bien y imagen x y entonces Vengo al código y le digo datos pun datata punto p no me acuerdo datos pun datata pun resultado en datos pun Data punto mi x y datos. datata mi Y si todo esto ha ido bien en principio ahora en contexto destino debería estar poniendo una serie de datos vamos a comprobarlo vamos a ver si hay suerte recargamos y vamos a verlo vale de momento está Atrapado ahí no sé si es por porque efectivamente está recogiendo los datos de momento no aparece nada esto es un poco lo de menos bien entonces vemos Que bueno ahí teníamos un poco algo que me temía Y es que vemos que el tiempo de transferir la información pues es un tiempo que tiene que ser tenido en cuenta aparte de que no tengo muy claro si lo está haciendo o no pero bueno ahora veremos Ahora cuando llegue a la cabeza pues veremos si lo está haciendo o no Ahora cuando llegue a esa parte de arriba otra cosa que puedo hacer es bueno Ah no tardar 10 segundos también Sería bueno vamos a verlo y otra cosa que puedo hacer es lanzar el worker Solo cuando haya un on message es decir este bucle vamos a verlo realmente no quiero bucle A ver no es un temporizador y lo que quiero es decirle al sistema lo siguiente esto de aquí lo meto en el on message y le digo bucle de x y así lo que vamos a hacer es que el sistema Lance un nuevo cálculo de backet no en un temporizador sino cuando realmente sea necesario cuando el on message libere vamos a verlo vale eso es lo que está tardando en liberar el on message vale muy bien de momento no tengo nada en la pantalla Okay correcto no pasa nada vale Y bueno ahora veremos por no tengo porque no tengo nada en la pantalla porque en principio debería empezar a tener la información gráfica ahí parece que lo que está fallando es el put image Data esto es un poco lo de menos dentro de lo que cabe pero simplemente Esto es lo que datos. datata resultado voy a contexto punto No console punto log datos vamos a ver vamos a refrescar por aquí datos. datata resultado y punto datos 255 esto es curioso porque no es que no esté funcionando sino que es que está dando todo el rato 255 o sea es blanco esto quiere decir que esto está funcionando pero en apariencia el tarea js es el que no está funcionando es decir siempre da false y esto quiere decir que borde es igual a true esto siempre está dando false datos. d. umbral y bueno vamos a verlo vamos a ver datos. datata px datata en principio parece correcto datos pun Data punto mi anchura backet no Esto no es correcto mi anchura backet ah que es correcto anchura backet y Data umbral vamos a verlo el J son es mi umbral mi anchura backet Vale mi umbral mi anchura buet mi umbral y mi anchura backet vamos a verlo ahora vamos a recargar ahora esto ya es otra cosa y ahora sí tenemos que el cálculo lo hemos dividido en diferentes partes en diferentes zonas bien lo divertido en este caso es que ahora ya no quiero tener un solo backet Ahora quiero tener cuatro backets y ahora yo creo que es cuando el programa se va a volver realmente interesante ya que ahora es cuando el programa Va a empezar a calcular realmente en diferentes núcleos y desde luego lo vamos a poder ver aquí Así que vamos a por ello vamos a por ello vamos por aquí vamos a sacar el código bien Y entonces ahora en Index 7 Vamos a ver ahora voy a decir que trabajador es igual a New aray número trabajadores lo tenía por aquí parece que lo he borrado vale número trabajadores es igual a Navigator Hardware concurrency y entonces digo for bar y es igual a 0 Y es menor que número trabajadores y más en ese caso voy a decir trabajador de I es igual a vaya se me ha perdido a New worker es tarea s pun js y ahora viene lo divertido y entonces voy a hacer lo siguiente para cada uno de los trabajadores trabajador de I on message y haz esto de aquí esto qué va a hacer pues esto lo que va a hacer con suerte como digo es que de repente aparezcan cuatro backets y si todo va bien Vamos a verlo vamos a comprobarlo estoy un poco nervioso vamos a Por cierto quería quitar el console Pero bueno da igual vale trabajador post message not a function trabajador dónde estás post message aquí vale bucle muy bien Ahora claro el bucle le tengo que decir a qué trabajador estoy haciendo referencia muy bien Y entonces voy a decirle el trabajador de i bucle de I y por tanto es el trabajador de I para decirle a Qué trabajador le estoy pasando la información yo creo que ya recargues vale vamos a ver valiu no es de tipo long en el bucle en 64 vale interesante en la línea 64 vamos a ver porque no sé por qué ha dado aquí un error a ver voy a quitar unas cuantas cosas no esto se queda vale vamos de nuevo Ok get image Data en Canvas rendering context 2D el valor no es de tipo long vale Okay console pun log y más x + y vamos a verlo vale 00 undefine ahí está el problema El wow espérate 00 undefine la y es lo que no está definido eso es lo que Wow Por qué la y no está definida la y está definida Qué interesante console.log voy a lanzar con más y x tal vamos a verlo Ajá a ver quito el bucle y en el 62 Ah esto fuera ya está ahora sí tenía un set Time out que no tocaba bien Ahora no se está ejecutando evidentemente porque no estoy ejecutando el bucle recargo y ahora sí si todo va bien Vamos a ver debería estar lanzando no estoy lanzando vamos a ver por qué no estoy lanzando vale está haciendo el post message vale voy a lanzar un trabajador Dei punto post message comienza ya que si no creo que no va a comenzar o eso es vale vamos a arrancarlo muy bien y vamos allá por lo menos vemos que ha lanzado ya cuatro tareas dice que no puede leer los datos de algo que no está definido vamos a verlo tarea js4 por cierto Ah claro bueno post message vamos a ver vale voy a hacer en tarea siete que sí si datos. datata x por ejemplo no es igual a nul en ese caso ejecut me todo esto vamos a verlo vale no hace los message els post message Hola vale bien Hay un problema y que en cuanto se rompe el flujo de datos deja de funcionar a ver quién está lanzando OK trabajador post message y Entonces al final ejecuto el bucle vamos a verlo vamos a ver ahora vale Bueno vamos por ahí ha causado un error ha hecho algo por ahí no pasa nada Vamos a continuar Bien voy a lanzar con 438 384 Perdón voy a lanzar con a ver 4560 44 4512 Esto está bien Ahora en cada uno de ellos me ha dado un error Por cierto que parece que ha perdido el estilo contexto backets punto fi Style es igual a red vamos a ver si sale de color rojo Ok y ahora da error y dice en el 69 no puedo leer la propiedad post message of undefine 69 no puedo leer la propiedad post message of undefine Por qué Pues porque aquí en el bucle no estoy viendo estoy pasando la y vamos a quitar los consoles en el bucle devuelvo má y por aquí vamos a ver el bucle devuelvo qué 00 vale 1 en el bucle devuelvo 4280 qué es lo que devuelvo en el bucle en mi índice Vale mi índice x y Okay mi índice x y en principio es correcto entonces post message of undefined post message of trabajador vamos a ver y esto es porque trabajador tiene que estar aquí en las variables principales bar trabajador porque si no solo existe dentro de esta función recargo vale post message of undefined en el bucle 71 trabajador de New worker trabajador de principio es correcto en principio desde el punto de vista de que debe estar metiéndolo dentro de un elemento trabajador de I es igual a New worker trabajador de I bien voy a lanzar con 41280 siempre es cer0 en el bucle de vuelvo bucle en el bucle de vuelvo y xy Ah un 2 3 el bucle de vuelvo 4 eso es lo que no eso es lo que no está bien Y es que teóricamente voy a poner trabajador de cero vamos a verlo vale Hay un problema con es Ah el problema ahora mismo es que es ahí se está comiendo todo el trabajo Y eso no está bien o sea ese cero ese trabajador cero se está comiendo todo el trabajo y eso como digo no está bien Así que ahora a continuación pues vamos a ver qué es lo que ocurre y porque ese I porque es Ah y no está funcionando correctamente porque como digo trabajador de I post message trabajador de I es esta I de aquí Así que voy a decir bar índice es igual a i y aquí voy a poner índice a ver si así recargamos me dice post message of undefined console punto log el índice del trabajador es más índice recargamos el índice del trabajador es 4 claro no puede ser cuatro no puede ser cuatro el índice del trabajador es 3 esto es correcto es 0 1 2 y 3 Pero porque el índice luego es 4 y cu quién está aumentando el valor del índice nadie debería aumentar el valor del índice porque el índice siempre tiene que ser 0 1 2 3 y 4 es normal que si dice que es 4 pues diga que no existe realmente Entonces vamos a ver quién está aumentando el valor del índice a ver esto es bucle de esto es bucle de i vale Y entonces bucle de i A ver el problema parece estar aquí voy a poner bucle de cero Entonces el principio Okay el índice es cer0 el índice es cer0 el índice es cer0 vale el problema está ahí Entonces por qué por qué ahí por qu ahí no está pasando correctamente el valor on message ahí está el problema vale bar ID trabajador es igual a i Y entonces aquí pongo bucle y de trabajador vamos a verlo ahora y de trabajadores igual Ah y ahora parece que sí Ahora parece que sí bueno el índice es tres momento porque tampoco lo ha hecho porque en principio parece que se ha quedado fijo en el y no puede ser ahora todo el trabajo lo está haciendo el tres Vale y de trabajadores igual a y voy a hacer una cosa voy hacer coma i y ahí voy a ponerla ahí pero bueno me está costando que el programa atrape claro el L del trabajador es Def un momento bueno puedo hacer una cosa y Es que voy a enviarle worker es I vale Ya que eso sí que parece que lo coge y ahora en la tarea voy a decirle que mi ID worker es datos. data.id worker Y entonces ahora le digo que esto es vamos a verlo esto es datos punto Data punto miid worker vamos a ver si así vale recargamos principio en principio parece que sí el índice del trabajador es 01 2 3 si nos fijamos ahora historial de la cpu Pues ahora prácticamente está ocupando el 100% y ahora tengo que empezar a jugar un poco porque no me ocupa el 100% realmente me está ocupando menos Entonces yo por ejemplo podría decirle al sistema que pues en lugar de ocupar digamos esos Pues quiero crear más quiero ocupar el doble de lo que acepta mi procesador vamos a verlo entonces digo número trabajadores es igual a Hardware concurrency por dos o sea tengo cuatro núcleos pues quiero ocho tareas vamos a ver ahora pondremos las 8 por cierto ahora podemos ver cómo Ahora sí Bueno machaca un poquito más el procesador okay Ahí lo tenemos otra cosa que quiero hacer es en html5 hacer un stroke re Así que vamos a verlo vale aquí stroke rect y vamos a verlo no quiero Clear rect vamos a por ello recargo Ahí va a dibujar múltiples rectángulos no pasa nada no me está dibujando rectángulos no me está dibujando rectángulos ahora vamos a ello Qué interesante vamos a ver por qué no me dibuja rectángulos contexto backet voy a decir fillrect vale con fillrect sí que lo hace y con stroke rect no es curioso a ver si no a una mala le puedo decir context backets punto backets pun beginpath move to x coma y contexto punto buckets Line two x + anchura Bucket Line to y + anchura backet contexto Line to y contexto backets stroke y con eso debería pintar rectángulos tampoco y es lo que me extraña una barbaridad debería estar pintando un rectángulo y no sé Hay algo que me estoy perdiendo y no sé ahora mismo Qué es tengo el begining path tengo el stroke no sé ahora mismo qué puede ser lo que está haciendo que es se pierda Lienzo backets contexto backets punto stroke Style es igual a esto de aquí y bueno ahora cuando quiera pues me dibujará me dibujar algo porque el caso es que si le pongo contexto backets punto fillrect Mira voy a hacer una cosa Ahora verás voy a hacerlo muy a la bestia x y coma anchura backet coma altura backet anchura backet y ahora a bestia contexto backets punto clearrect x + 1 y + 1 coma anchura backet men2 coma anchura backet men2 eso lo que hace es crea rectángulo Sólido y luego lo borra Yo qué sé si no me deja otra opción para no perder tiempo con este tema de los rectángulos y parece que tampoco vamos a ver rectángulo ahí Y por qué no me deja x + 2 y + 2 Claro claro claro es que estoy pensando que igual el rectángulo que estaba dibujando era muy pequeño ahí lo tenemos vale Ahí lo que está haciendo el programa como podemos ver Es ir de cuatro en cuatro bloques al ir de cuatro en cuatro bloques pues lo que está haciendo es como podemos ver ahí también eh usar bastante mejor el procesador y por tanto ahora pues da igual realmente qué es lo que use da igual realmente Cuántos procesadores tenga porque los puedo aprovechar otra cosa que puedo hacer es analizar digamos Cómo el programa Va a ir más rápido si con más anchura de backets o menos anchura backets vamos a verlo esto vamos a decir que por ejemplo la anchura de backet es 32 voy a poner eso Entonces recargo y ahora lo que está haciendo es que estará enviando trocitos más pequeños está enviando trocitos más pequeños está haciendo el cálculo al final y fijémonos como con cálculos demasiado pequeños el procesador no está usándose al 100% la razón probablemente es porque está perdiendo más tiempo en enviar y recibir la información que en calcularla con lo cual es interesante es importante que pues realicemos este tipo de pruebas para saber cuál es el punto óptimo y eso que en este caso recordemos que lo tengo en Pues en el doble de tareas de Entonces ahora voy a poner por ejemplo pues voy a poner 512 pongo 512 recargo vamos a verlo ahí bien y ahora con 512 ahora de hecho va a tirar más ahí fijémonos que el procesador sí que lo está realmente utilizando la idea siempre que trabajamos con backets pues es intentar digamos trabajar con un número óptimo y hasta que no hacemos estas pruebas pues no podemos saber cuál es este número óptimo démonos cuenta como ahora sí que puedo hacer digamos el cálculo Vale ahora sí que puedo hacer el cálculo de Cuándo ha terminado Y entonces voy a por ello Y así hacemos diferentes pruebas hacemos análisis de carga vamos a ver vamos a las constantes constante tiempo de inicio es cuando el programa empieza cuando el programa empieza después del Time out a tiempo inicio Aquí lo tengo bien Ahora si y es igual a Es mayor que 2048 en ese caso const tiempo final cuidado con tiempo final es igual a esto y entonces console pun log no lo quiero cortar console pun log esto de aquí muy bien entonces ahora puedo recargar me voy a la consola bueno da igual los consoles que hay por ahí luego los puedo quitar el tiempo para calcular Este programa ha sido 249 realmente no porque tengo que esperar a que me devuelva el último worker vale bueno otra cosa que puedo hacer es cronometrar Pero bueno está tardando 18 segundos Sí realmente Esto me sirve estoy pensando porque me calcula la diferencia con respecto a cuandoo he empezado con lo cual el último tiempo es el que me puede valer Vale pues vamos a por ello vamos a ver Tengo cuatro Tengo ocho Claro pero no puedo partir más okay Vale son 20 segundos Entonces ahora anchura va 256 recargo y recordemos que el anterior han sido 20 segundos Así que ahora empieza a calcular ahora empieza a calcular vale Y bueno el tiempo finalmente el máximo ha sido de 18 segundos o sea que ha estado un poquito por debajo del anterior curiosamente no me lo esperaba pero Vale ahora vamos a darle por ejemplo eh 26 128 64 vamos a verlo vamos a ver bien ahí vemos que el procesador no lo está usando tanto vamos a verlo y vamos a ver por ahí y el tiempo ha sido de 42 evidentemente Pero también es cierto que le puedo decir que trabajadores es igual a esto por 8 y puedo hacer la prueba de tener más trabajadores vamos a verlo vemos como ahora el procesador Bueno lo está utilizando pero tampoco mucho así que yo creo que pues parece que hacer los backets más pequeños no nos va a dar más eficiencia porque En definitiva pues pierde parece pierde bastante tiempo transfiriendo la información vemos como el último tiempo ha sido de 36 segundos Así que yo creo que el mejor tiempo lo hemos conseguido antes cuando hemos conseguido prácticamente 20 segundos hay que tener en cuenta que el programa originalmente hacía esto no sé si sería el índice 6 vamos a verlo el índice 6 hacía esto Ah no esto es el de 190 pero este no vale Bueno pues hacía esto en 0,4 segundos y ahora está tardando 20 segundos o sea que está claro que evidentemente Aparentemente lo que está haciendo es perder mogollón de tiempo pero no es tanto así es decir el tiempo que ahora mismo Estamos perdiendo en dividir la información es el tiempo que más adelante podemos ganar repartiendo esta información a lo largo de diferentes dispositivos de cálculo Entonces siempre hay que seguir optimizando siempre que hay que seguir trabajando y En definitiva Pues siempre vamos a poder digamos controlar la ejecución de los objetos otra cosa que voy a hacer Es que voy a Desactivar los consoles porque tengo miles de consoles Y eso quieras que no también hace que se ralentice el trabajo así que vengo por aquí vale vamos a quitar los consoles este no muy bien Vamos a quitar los consoles de la tarea si es que los hay vale parece que no vamos a recargar ahí En definitiva únicamente quiero ver pues los consoles del final esto tampoco va a hacer Milagros tampoco va a hacer maravillas pero sí que cierto que el console pues finalmente ralentiza entonces pues tengo que tenerlo en cuenta vamos a verlo finaliza la ejecución Vale y 28 segundos Pues bueno algo de tiempo sí que hemos ganado otro uso posible de los workers consiste en crear procesos independientes que un momento dado nos pueden servir para prácticamente cualquier cosa vamos a crear ese tipo de procesos independientes ahora luego veremos Hasta qué punto Son independientes o no lo son así que vamos a ver por aquí nos vamos a procesos vamos a abrir un editor y vamos allá así que a continuación voy a crear un nuevo archivo lo voy a guardar como Ah procesos voy a guardar como Index 8 punto html bien Y en este caso vamos a ver que se está guardando y ahora a continuación también lo abrimos localhost Index .php procesos Index 8 bien esto por aquí esto está abriéndose no sé por qué se está quedando frito Así que vamos a cerrarlo y lo volvemos a abrir eventualmente lo abrimos directamente bien y ahora continuación y ahora a continuación vale lo que vamos a hacer es crear un archivo nuevo crear un archivo nuevo vale Y en este caso vamos a crear una serie de workers que van a hacer una serie de cosas voy a crear un Script y aquí dentro voy a crear bar trabajadores es igual a New r voy a decir por aquí arriba bar número trabajadores es igual a 50 por ejemplo y por tanto Ahora vengo por aquí y digo for bar es ig 0 Y es menor a número trabajadores y más en caso lo que quiero decir es que trabajadores de I es igual a New worker y el archivo que voy a usar es tarea 8 js que no existe pero que ahora en un momento dado crearemos si todo va bien voy a crear ahora el archivo voy a guardarlo como tarea o Index Vale y procesos y tarea 8. js bien y tarea 8 simplemente va a decir console pun log otra vez se ha quedado parece un poco frito No pasa nada o Sí vale entonces tarea 8 lo abrimos con brackets si todo va bien se van a abrir los dos archivos vale Y si no pues los abrimos manualmente Así que Index 8 bien Index 8 y tarea 8 voy a poner console pun log Hola Así que recargamos vamos a inspeccionar voy a quitar un momento esto de momento no nos sirve ahora luego lo volveremos a poner vale Y en este caso nos dice hola es decir vemos como de momento por lo menos han arrancado cada uno de estos workers entonces voy a poner aquí inicio y aquí voy a poner el código de un archivo worker totalmente libre entonces voy a hacer lo siguiente inicio arranco inicio fun inicio hace algo y en este caso que voy a hacer es decir function bucle y el function bucle va a hacer alguna otra cosa así que Bart temporizador Esto es algo parecido a las clases y los objetos pero un poco diferente Bart temporizador Y entonces en inicio voy a decir temporizador es igual a set Time out quiero ejecutar bucle dentro de un segundo entonces aquí qui en bucle fun bucle Clear Time out temporizador y temporizador es igual a set Time out bucle y básicamente lo que voy a decir es console log estoy en el ble bien Ahora si lanzamos esto ocurrir es que inicio y bueno básicamente cada uno de los workers en todo momento va a decir estoy en el bucle no voy a machacar demasiado esto básicamente porque el console pun log se va a llenar de cosas en la pantalla pero ahora lo que voy a hacer es pues como una serie de digamos personajillos en la pantalla para mostrar gráficamente cada uno de estos workers que está haciendo Entonces vengo por aquí y ahora continuación lo que voy a hacer es decir que en Index 8 aquí arriba voy a crear un Canvas y de Lienzo no lo voy a hacer muy grande eh lo voy a hacer de Wi es ig a 512 píxeles H es igual a 512 píxeles simplemente este Lienzo nos va a ayudar a ver visualmente qué es lo que hac cada uno de los 50 trabajadores Y entonces ahora aquí lo que voy a hacer es decir que bar contexto es igual a document.get Element byid Lienzo get context 2D entonces de esta forma sabemos ya sabemos que desde un worker no podemos pintar directamente dentro de dentro del Canvas vale Pero sabemos que podemos pasar información y por tanto aquí puedo hacer un fun inicio puedo hacer un function bucle y de hecho incluso me puedo copiar Bart temporizador vamos a meterlo aquí me puedo copiar temporizador es igual a set Time out ble me puedo copiar esto de aquí y aquí voy a poner inicio y En definitiva La idea es que podemos digamos trabajar con un bucle en el principal y luego otros tantos bucles en los elementos digamos de del inicio bien Ahora una vez que tenemos esto vamos a hacer que digamos esto haga cosas interesantes muy bien Vamos a comentar el código anterior Así que voy a copiar eso y voy a decir defino el número de trabajadores que tendría simultáneamente voy a hacer esto grande especifico un contexto en el cual dentro voy a dibujar he dejado esta línea los trabajadores son una nueva colección donde en cada uno de ellos pondré un worker un Burger me ha cogido bien creo un nuevo vamos a verlo creo un nuevo temporizador vacío para cada uno de los trabajadores dentro de la colección los asigno como un trabajador y ahora aquí digo llamo a la función de inicio defino la función de inicio la función de inicio ahora hará cosas dentro de un segundo ejecutamos la función de bucle vengo por aquí y digo defino la función de bucle elimino el temporizador anterior para refrescarlo y aquí creo un nuevo tariz ador recursivo que se llama así mismo realmente que Llama a la misma función llama a la función de bucle bien pues si tenemos esto Si hasta ahora tenemos esto a continuación Yo vengo por aquí y dentro de del trabajador voy a hacer lo siguiente vamos a ver ahora para cada uno de los workers cuidado aquí para cada uno de los workers lo que quiero es que me digan dónde están y lo que quiero es que me digan Pues bueno que digamos que tienen Entonces vamos a por ello vamos a ver vamos a ver ahora vamos a decir bar trabajadores bar personajes es igual a aray y ahora voy a decir en este caso personajes aquí no perdón personajes y vamos a verlo de i esto es que los creo desde cero es igual a de momento x es igual a 0 y es igual a 0 ya está de momento Así que en este caso lo que voy a hacer es for bar I es igual a 0 Y es menor que número trabajadores y más y lo que voy a hacer de momento es decirle al sistema decir a la pantalla que eh contexto punto Fil re y voy a decir que personajes de I punto x coma personajes de I punto y coma 22 Y si todo ha ido bien Vamos a verlo si todo ha ido bien recargamos tendremos un Canvas y tendremos ahí 50 puntitos es decir 50 elementos 50 digamos puntitos iniciales por qué porque les he dicho que cuando nacen digamos tienen x = 0 Y es ig 0 ahora bien aquí dentro del worker el worker va a decir algo diferente y va a decir lo siguiente pues x es = 0 o x es ig a ma random multiplicado por 512 porque la anchura del proyecto es de 512 posición y es lo mismo y de momento aquí en el bucle lo que voy a hacer es decir post message y voy a lanzar un jas voy a decir que bueno x es Pos x coma y es Pos y ya está así que vamos a verlo esto de momento no va a hacer nada os lo aseguro ya pero tampoco da error que es lo bueno pero ahora aquí lo que quiero es lo siguiente lo que quiero es trabajadores de I punto on message es igual a function y le digo en este caso que y a ver si no me vuelve a fallar como antes que igual sí vete sa ver personajes de I punto x es igual esto es Data o datos es igual a datos. datata x y personajes de y es igual a Data y con lo cual de momento lo que estoy haciendo si no funciona mal que en este caso ha funcionado mal lo que estoy haciendo es definir las posiciones X e Y bien No pasa nada voy a pasar las coordenadas entonces voy a vamos a ver trabajadores New worker voy a pasarle el identificador vale trabajadores de I punto postmessage y voy a decir que ID es igual a i en este caso por tanto lo que voy a hacer es decirle a Cada trabajador Cuál es su ID voy a decirle por aquí arriba on message le voy a decir que esto es igual a function datos aquí arriba digo ID es igual a nada barid y aquí le digo ID es igual a datos pun Data punto No lo sé punto ID será y por tanto Ahora aquí digo ID es igual a ID Y si todo va bien Aquí voy a decir datos. data.id datos datata si ahora esto ha ido bien Vamos a recargarlo Y tenemos ya todas y cada una de las posiciones de los puntitos pero lo interesante en este caso es que lo que se va a encargar de las posiciones va a ser el worker y no el objeto principal el archivo principal únicamente va a recoger X e Y todo lo que ocurra realmente al archivo principal le va a dar igual porque va a ocurrir dentro de los workers vamos a verlo por tanto y ahora nos metemos dentro del propio worker y bueno vamos a quitar los consoles ya que ya están ya está claro que estamos dentro del inicio y dentro del bucle bien y ahora por ejemplo yo voy a crear diferentes cosas voy a crear bar dirección es igual aquí debería poner bar también vale vamos a poner bar dirección es igual a e maz pun Random multiplicado por maz pun pi multiplicado por 2 bien bar velocidad es igual a math punto random y bueno por tres por ejemplo vamos a ver qué ocurre Así que ahora vengo por aquí y en cada uno de los elementos del bucle pues digo dirección más igual a ma punto Random - 0.5 y esto lo multiplico por 0 punto lo que sea o lo divido por 4 por ejemplo y ahora digo pues x es ig a es más o igual a ma. Cos de la dirección y Pos Y es más igual a ma pun sin de la dirección entonces si todo esto ha ido bien lo que ocurre en este caso yo recargo lo que ocurre en este caso es que los personajillos se están empezando a mover se mueven ellos solos ahí tendría que borrar el Aunque Bueno me hace un poco de Gracia que se queden en la pantalla vale parece como gusanitos que van creciendo pero lo importante de esto lo interesante de esto es que cada bucle va absolutamente a su rollo cada bucle va como quiere voy a darle aquí a que esto ocurra pues cada Bueno a 30 fotogramas por segundo Aquí voy a hacer exactamente lo mismo vale voy a recargar y observamos que esto es lo que ocurre en la pantalla ahora s ya puedo sacar el monitor y bueno de momento no creo que vea mucho ciertamente pero lo interesante de este tema es que yo ahora puedo por ejemplo poner me vuelvo al archivo principal y yo puedo poner 250 programitas de estos Y le doy aquí a recargar y ahora veremos que hay 250 de ellos Hola a ver Ah bueno Espera que está Ahí dale que te pego están ahí calculando pero fijémonos voy a parar un poco esto porque parece que se ha quedado frito no sé por qué Porque tampoco eran tantos Pero bueno pero démonos cuenta que el cálculo de cada personaje está dentro de cada uno de los workers voy a ir a procesos de nuevo que parece que no ha sentado muy bien lo de que le ha puesto 250 pero bueno creo que no eran tantos pero como digo interesante lo interesante es que ahora cada uno de ellos está trabajando está funcionando de forma independiente y cada uno de ellos En un espacio diferente voy a poner 100 venga va a ver si no se me cuelga como antes vale en principio Estos son 100 y lo que quiero ver es que pues insisto cada uno de ellos tiene un comportamiento diferente y cada uno de ellos va a su propio núcleo de del procesador bien vamos a seguir metiendo condiciones para seguir viendo que el archivo de inicio prácticamente se va a quedar así pero toda la lógica va a estar aquí dentro de este archivo o aquí dentro de estos archivos Así que yo ahora puedo venir por aquí y decir pues varias cosas vamos a ver voy a meter funciones voy a meter function colisiona bordes Así que vengo por aquí y le digo al sistema que pues bueno quiero que colisionen digamos con los bordes Así que si poses x es menor que 0 o Pos x Es mayor que 512 o Pos y es menor que 0 o por si y es mayor que 512 en ese caso lo que quiero es que dirección más igual a ma punto Random No ma punto pi o sea pégate una vuelta de 180 gr y luego dentro del bucle lo que hago es decir colisiona bordes básicamente llamo a la función también puedo poner por aquí función mueve y vamos a ver y ya está entonces Y function cambia dirección y así luego pues vemos Cómo podemos darle más código a cada uno de ellos esto es la función mueve y ahora esto es cambia dirección y esto es mueve y así de alguna forma es como que estamos trabajando con un objeto con una especie de objeto un objeto que ahora cada vez va a tener más complejidad va a tener más código pero cada uno de estos bloques pues lo que va a hacer es moverse dentro digamos bien Vamos a ver ahora cada uno de ellos rebota evidentemente y bueno Vamos a continuar dándoles propiedad un poco para ver hasta dónde podemos llevar este ejercicio y para ver hasta dónde podemos llevar el hecho de que pues podamos trabajar en múltiples hilos en este caso tengo 100 a la vez y démonos cuenta de que si el hilo no es muy pesado Aunque solo tengo cuatro procesadores pero tengo 100 tareas y no pasa nada Vamos a darle un color Vamos a darle una coloración así que poses x Pos y pues bar vamos a ver bar color color vamos a r bar color r es igual a math pun round de math Random multiplicado por 256 esto es el color rojo verde y azul y por tanto lo que podemos hacer en este caso es decirle al sistema que le pasamos la información cuidado porque estamos llenando esto más de información Así que CR es igual a CR cb es igual a cb y no perdón cg es igual a cg y cb es igual a cb y por tanto ahora a continuación cuando venimos por aquí pues lo que hacemos Es decirle al sistema que contexto fi rect pues le decimos contexto punto fill Style es igual a rgb coma y vamos a poner aquí los las coordenadas correspondientes Entonces esto es personajes de I punto CR personajes de I cuidado me queda dejado la p parece personajes de I cg personajes de i. cb Y si todo ha ido bien pues vamos a ver como ahora bueno fijémonos que ya está casi negro ahora vamos a ver debería cada personaje debería tener su propio color pero parece que no lo está teniendo Bueno vamos a verlo datos datad voy a refrescar del todo no sé por qué me parece todo negro vale vamos a ver y voy a hacer una cosa mi r mi G mi b y aquí digo mi r Ah cuidado mi G mi b y bueno Simplemente ya está aquí está vamos a ver Esto es x0 r es 0 G es 0 B es 0 y por tanto ahora r es igual a mi r G es igual a mi G B es igual a mi b y por tanto aquí pongo una r pongo una G y pongo una B guardo recargo vamos a verlo ahora y ahora sí si todo va bien cada uno cada una de las trenzas digamos cada una de las líneas cada uno de los personajes pues tiene su propio color y En definitiva pues le podemos dar una serie de propiedades diferentes vamos a ver a continuación que bueno en un momento dado no os podría gustar digamos el hecho de poder introducir diferentes propiedades y que el sistema digamos las pueda ver entre sí incluso las pueda actualizar en este caso por ejemplo me gustaría que los personajes digamos de alguna forma se vieran entre sí para pues interactuar por ejemplo para intentar evitarse o para cualquier otra cosa en este caso lo que tenemos que hacer con los personajes es eh que se vean entre sí es decir que el sistema sea capaz de enviar a cada una de las instancias la información del resto de instancias Entonces esto lo vamos a poder conseguir de una forma más o menos sencilla con Eh bueno con la creación de o con el pase digamos de información de una parte a otra vamos a verlo bien para hacer esto vamos a hacer lo siguiente al worker a cada uno de los workers le podemos pasar la información de el resto de workers entonces voy a hacer en este caso una cosa y es que le voy a decir eh otros es cero otros de momento lo voy a poner a cero pero ahora lo que voy a hacer Vamos a ver Esto es on message nada vale cuando llamo al post aquí y cuando de hecho llamo cuando de hecho llamo al post message vale puedo decirle que identificador es igual a i y puedo decirle también que otros es igual a vamos a verlo a personajes de esta forma lo que estoy haciendo es que a cada uno de los personajes le estoy pasando la lista de los otros personajes vamos a verlo me vengo por aquí y le digo bar otros y le digo otros es igual a datos. datata otros y al final le puedo decir cuidado a otros y al final le puedo decir console pun log otros y vamos a ver qué nos da vamos a ver qué nos da voy a bajar la frecuencia voy a bajar la frecuencia voy a recargar voy a inspeccionar Vale y aquí lo tenemos Ah y voy a poner menos trabajadores poner menos workers voy a poner 10 para que el sistema no vaya tan aquí y entonces si nos fijamos vamos a ver espera esto aquí vale lo que está haciendo es lanzar cada uno de los otros 10 vamos a esperar un poco vamos aquí abajo y entonces veremos como el sistema lo que está haciendo Es que le está enviando como un dato la posición de cada uno de los otros elementos Entonces eso quiere decir que ahora cada worker pues puede conocer información acerca del resto de otros workers y por tanto puede hacer cosas como por ejemplo pues van a intentar evitarse vamos a verlo vengo por aquí me voy a tarea y ahora voy a crear una función llamada evitarse bien Vengo por aquí y ahora le digo lo siguiente quiero for bar I es igual a 0 Y es menor que y ahora viene la cuestión y es menor que datos punto Data punto otros punto leng creo yo sí porque esto es directamente vale para cada uno de ellos voy a averiguar Cuál es su dirección y Ah y cuidado aquí falta un y más bien voy a poner javascript distance between two points voy a la clásica ecuación que está aquí vale Y voy a decir a es ig a+ x menos datos punto Data punto otros de I punto x Por qué x pues porque si nos fijamos tengo aquí para cada uno de ellos su x Vale ahora la B es Pos y menos datos. datos. y la c es la distancia Entonces yo a continuación digo si es cierto que la distancia es menor que no sé 20 en ese caso yo lo que quiero es dirección más igual a maz pi esto quiere decir que cuando me acerco a alguien pues doy la vuelta voy a poner Aquí evitarse voy a poner la función activa dentro del bucle Así que si ahora vengo por aquí y recargo voy a bajar un poco la frecuencia ahora que ya hemos visto lo que queremos y no hace falta que pongamos ya el console pun log porque si no se nos van a llenar la consola de matrices recargo bien cuidado datos is not defined al evitarse vale por qué Pues porque datos está aquí entonces okay esto es otros Ah muy bien vale pues solo componer otros en principio ya debería funcionar porque ahí lo he puesto en una variable recargamos datos is not defin al Uy otra vez a ver que recargue entero al evitarse otros punto leng Ok recargamos vale Ahí los tenemos no sé si están haciendo algo o qué Yo diría que no a ver los Time outs 33 y 33 voy a Desactivar evitarse a ver si es que evitarse está haciendo que se quede frito Pues igual Sí vamos a verlo vale voy a hacer distancias igual a 5 activo evitarse porque parece que se están quedando fritos en el sitio sí que parece que voy a hacer una cosa console pun log cambiando a ver si está entrando ahí dentro cambiando efectivamente por lo que sea parece que se están detectando como que están todo el rato unos pegados a otros siis distancias menor que cco si distancia es menor que cco voy a repasar el código otros de y voy a hacer una cosa console pun log otros de X y gu otros de y O sea quiero ver las x y las y de los personajes Quiero ver si están cogiéndose correctamente sí que parece que se están cogiendo correctamente así que no parece que esto sea un problema vamos a hacer un console punto blog de la distancia y este console ya no hace falta tampoco cuidado Vale recargamos vemos ahí como esto ya está a ver ya está usando procesador vale inspeccionar vamos a ver la consola a ver qué nos dice voy a volver a rebajar el tiempo vale Okay consola bien y en principio esto que estamos viendo aquí es la distancia vemos Que en prácticamente ningún caso es menor vamos a ver aquí si la distancia es menor que 5 en ese caso dirección más ig a pi Así que vamos a ver esto y por tanto no acabo de ver cuál es el sentido de que diga que está cambiando vamos a hacer esto con todavía más tiempo vamos a poner esto con todavía más tiempo y vamos a poner menos jugadores en pantalla voy a poner dos así que Ah ya sé lo que está pasando ya sé lo que está pasando y lo que está pasando Es que se está cogiendo Así mismo porque si mismo es un jugador muy bien entonces ya está entonces y distancia es igual a cer and distancia no es igual o sea si es menor que cco y no es igual que cer vale Y ya está hecho Bueno cambiando le aparece uno como distancia es interesante y distancia es mayor que uno vamos a ponerlo cambiando de nuevo vamos a poner mayor que dos parece que se está cogiendo a sí mismo con lo cual no debería Vale entonces ahora vamos a volver a bajar vamos volver a bajar vamos a verlo otra cosa es que además estoy cogiendo puedo la ID Entonces si puedo la ID vamos a verlo si puedo la ID yid es I vamos a verlo yids pues puedo decirle al sistema directamente si otros punto ID dónde estás y otros punto ID no es igual a mi ID es igual a ID y En definitiva lo que estoy haciendo con esto es no cogerme a mí mismo vale sigue por ahí cambiando vale No pasa nada voy a decirle and otros and distancia es mayor que 4 y voy a decirle menor que 10 vamos a verlo recargamos ahora vale se empiezan a mover creo que se sigue cogiendo Así mismo pero bueno vamos a poner más para que haya un poquito más de opciones a que colisionen bien fijémonos que vamos a verlo en cuanto hay 20 Bueno aparte de que la consola la voy a liberar evidentemente porque si no vale fijémonos que vamos a empezar a probar poco a poco cinco vamos a ver procesador al 100% puedo incluso matar el proceso vale arrancamos Chrome lanzamos de nuevo vamos con cinco y vamos allá bien pues ahora lo que estoy esperando es a ver si se acerca los unos a los otros ahí yo creo que hay uno que ya ha colisionado Pero bueno no sé no puedo saber y Ah iban a colisionar pero parece que no curioso voy a darles un poquito más de voy a darles un poquito más de es menor que 10 no menor que 50 por lo menos vamos a recargar Ahí lo han hecho Ahí hay dos que se iban a acercar demasiado y se han evitado entre sí y ha hay dos que también se estaban acercando y se han evitado entre sí así que ahí podemos verlo ahora lo que quiero es un poco ir subiendo poco a poco Voy a poner 15 para comprobar que el sistema pueda con ello ahí tenemos Uh hay dos Ah claro se quedan atrapados hay dos que se hay varios que se quedan atrapados cuando están demasiado cerca se quedan atrapados entre sí es curioso cuando nacen demasiado cerca es como que no se pueden alejar ahí uno ha salido y se vuelven a quedar atrapados y ahora a continuación Pues voy a ir subiendo poco a poco Yo creo que la sobrecarga de antes sera por tener la consola abierta vamos a poner 25 también lo que voy a hacer en la aquí en la tarea es buen ahí vemos como el procesador va subiendo es decirle que bueno no va a ser distancia 50 va a ser distancia 20 y una vez más lo bueno lo divertido de esto es que Eh pues vemos como la lógica del comportamiento de cada uno de estos elementos pues va independiente a cada uno de ellos vemos como yo puedo poner lógica y la lógica va a ir totalmente de forma totalmente independiente en cada uno de estos personajes como llega un momento en el que dibujamos y no se ve muy bien lo que podemos hacer es volver aquí ahora pondremos más comentarios y vamos a decir que vamos a decir que contexto punto fi Style es igual a rgba 255,255 0.1 y contexto pun fillrect eh 0,0 com 512512 esto en lugar de borrar la pantalla lo que hace es como una máscara semitransparente que hace que los personajes pues dejen un pequeño rastreo así que pues bueno ahí los tenemos y la idea es comprobar cómo pues van dejando un momento de colisión De hecho hay algunos que se quedan fritos es interesante de ver una cosa que puedo hacer por ejemplo es ponerles tamaño y así si les ponemos tamaño Pues igual podemos mejor podemos ver mejor cómo colisionan vamos a por ello voy a ponerles tamaño por tanto Entonces para ponerles tamaño vemos que son como un poco como pececitos una pecera vamos a ponerles tamaño por aquí Así que ID es igual aí y tamaño voy a poner es igual a cer vamos a ver por aquí tamaño es igual a cer Ok realmente no realmente aquí no lo que sí que quiero es retornarlo entonces bar tamaño es igual a 2 por ejemplo y ahora lo que quiero hacer es decirle lo siguiente en el bucle tam es igual a 2 y si la distancia cambia tam es igual a 2 tam es igual a 5 y esto lo que va a hacer y esto lo que va a hacer Ahora vengo aquí y digo tam es igual a tam lo que voy a hacer aquí es que el grosor va a ser este va a ser personajes punto tam es Data Tam y por tanto vengo aquí y digo Tam y lo que voy a hacer es cambiar el tamaño mediante programación en este caso lo que he hecho simplemente es decirle al sistema que en el momento de colisionar pues se hagan grandes ahí y así notaremos mejor cuando colisionan vemos que en el momento de colisionar en ese momento se hacen grandes y luego ya se vuelven hacer pequeños y así yo creo que se ve en la pantalla cómo lo están haciendo Y así también me ayuda a ver cuáles de ellos están atrapados y cuáles de ellos pues no vemos ahí cómo se des atrapan vemos que algunos se quedan atrapados por parejas llega uno y de repente los Desbloquea bueno y ahora pues una vez más puedo ir metiendo poco a poco nuevos elementos más elementos voy a meter 50 a ver qué pasa y ahí lo tenemos la idea es ir subiendo poco a poco ir subiendo poco a poco ahí bien Además voy a intentar que se pegue en un empujón cuando se cambi la dirección Voy a hacer esto dirección velocidad creo que al final no lo he utilizado por velocidad por tres un poco como para que se pegue un empujón Y por cierto Aquí voy a poner también la velocidad que no la estoy teniendo en cuenta en ningún momento recargamos bien cuidado no tanta velocidad vamos a bajar vale menos velocidad Aunque tampoco me disgusta pero partido dos y bueno La idea es ver si así al rebotar pues se atrapan menos pero yo creo que estoy viendo que se atrapan Igual vamos a intentar picar más al sistema vamos a decirle que queremos ahora 150 y siempre pues vamos viendo aquí Cómo va subiendo el procesador conforme vamos subiendo los elementos vale vemos que pues eso el procesador con 150 ya empieza a tener ciertos problemas para gestionar la información sobre todo porque hay un Jason que está yendo y viniendo en cada momento pero es inevitable porque pues tenemos que decirle al sistema Cuántos elementos hay así que vale Ahí parece demasiado así que bueno vamos a bajarlo de nuevo a 50 y así un poco estamos comprobando que podemos digamos llevar el sistema a su límite podemos forzar el sistema y podemos en todo momento monitorizar el procesador y comprobar Como cada tarea se está ejecutando de forma independiente ahí lo tenemos bien Ahora a continuación vamos a empezar a introducir bueno ciertos parámetros dentro de cada uno de los workers tales como por ejemplo voy a meter la energía bar digamos energía Ok Voy a decirle que al principio es igual a 100 y bar vamos a decir hambre vale es igual a cero de momento para empezar entonces a continuación voy a hacer lo siguiente voy a decir bar duerme Perdón fun duerme y al dormir voy a decir que energía más y ahora a continuación voy a hacer lo siguiente eh vamos a ver voy a decir que bar muerto es igual a false no está muerto está vivo y voy a decir que si la energía es menor que 20 en ese caso duerme y en caso contrario muévete Pero hay un pequeño problema y es que a medida que uno se mueve la energía decrece esa va a ser un poco la cuestión y ahora el tamaño voy a hacer que sea de vamos a ver energía partido por 10 porque si intento hacerlo de 100 realmente va a ser una barbaridad así que recargo vale Ahí tenemos a los personajes y cuando tienen poca energía lo que hacen es que paran deberían estoy siguiendo a uno estoy siguiendo a uno de ellos nunca deja de moverse Ah muy bien vale claro perfecto fantástico y si energía If energía es mayor que 80 en ese caso ya se puede mover vamos a verlo es cuando están durmiendo y ahora se quedan deberían quedarse quietos estoy esperando a que decrezca a ver claro vamos a ver energía más vale lo que quiero es que se queden un momento quietos porque ahí lo que están haciendo es un poco de trampa es decir están moviéndose independientemente vale a hacer una cosa vamos a ver bar dormido es igual a false Y entonces digo vamos a ver si energía es menor que 20 dormido Ok es igual a true vale duerme en ese caso si dormido es igual a true en ese caso duerme y cuando la energía sea 80 en ese caso dormido es igual a false eso quiere decir que despierta así que recargamos por aquí vemos que algunos personajes se quedan por ahí quietos voy a seguir a uno en principio deberían perder energía al moverse vamos a ver vamos a poner menos porque no estoy viendo nada recargamos vale Este por ejemplo entiendo que debe estar durmiendo no porque se mueve rápido o sea se mueve lento y yo diría que no están durmiendo nunca caen dormidos en Entonces algo debe estar fallando en la lógica vamos a verlo vamos a ver dormido es igual a false vale si energía es menor que 20 en ese caso dormido es igual a true si dormido es igual a true duerme vale si energía Es mayor que 80 dormidos igual a false y muévete Entonces no entiendo por qué Por ejemplo estos de aquí no se hacen pequeños vale vamos a eliminar unas cuantas cosas Okay y Okay vale Y aquí Así que paro esto recargo me he cargado algo se ve cinco errores expected End of input y no sé muy bien que me he cargado pero sí que parece que me haya cargado algo sí me he cargado esto okay recargamos Y en principio deberían estar cayendo de tamaño pero no están cayendo Vale cuando se mueven energía menos igual a 10 una barbaridad vale Y evitarse no ahí hay algo que me extraña porque al moverse no están perdiendo energía voy a decir console.log energía y así vamos a ver qué es lo que ocurre recargamos y siempre es 100 ese es el problema Entonces cuando el personaje se mueve de hecho Cómo se están moviendo si nadie está haciendo que se muevan cambia dirección son 100 ahí hay un problema vale bien y digo si la energía Es mayor que 80 se mueve vale vamos a verlo ahora vale se mueven porque sí okay Y cuidado porque no se pueden hacer Okay tan pequeños muy bien Ahora vale si energía Es mayor que 80 en ese caso dormido es igual a true es igual a false Y si dormido es igual a false en ese caso muévete vamos a verlo vamos a ver ahora vamos a ver ahora el personaje se hace pequeño duerme y se vuelve a mover Ahora sí que está funcionando correctamente está perdiendo mucha energía lo sé pero ahora lo corregimos Entonces ahora lo que hacemos Es que el personaje se mueve pierde energía cuando se pierde energía duerme al dormir recupera okay Y una vez recupera pues se despierta y sigue trabajando muy bien Ahora puedo quitarle menos puedo decirle que cuando se mueve pierde 0,1 de energía cuando duerme suma 0.1 de energía y así los ciclos digamos de sueño no serán tan rápidos puedo quitar ya el console punto log porque ya lo estoy viendo bien Ahora se van haciendo pequeños y cuando se hacen pequeños aparte de que esos dos se han quedado enganchados pues duermen y una vez que duermen Pues luego ganan energía al dormir y se despiertan ese de ahí yo creo que ya dentro de poco se va a ir a dormir ahora está durmiendo está aumentando su energía y en cuanto su energía haya aumentado suficientemente pues se despertará y seguirá trabajando bien vamos ya tenemos la energía producida por el cansancio por la necesidad de reposar vamos a continuación a por el hambre y es que si hay hambre digamos el sistema tendrá que eh comer Vamos a poner unos cuantos puntos para comer por aquí por el proyecto vale para que el personaje pues pueda comer Vale entonces en este caso voy a hacer lo siguiente me voy a ir a Index y voy a decirle al sistema que vamos a ver número bar número comida cuidado barra bueno sabes que comida es igual a New array bar número comida es igual Por ejemplo a 20 y ahora voy a decir y ahora voy a decir aquí al principio for bar I es = 0 Y es menor que número comida y más y voy a decir que en este caso pues número no esto Qué es comida de I es vamos a poner por aquí directamente pues x es igual a ma. Random por 512 coma y es ma. Random por 512 y yo creo que más o menos ya está Así que ahora vengo por aquí y digo forar y es igual a número comida contexto pun binp contexto ar de comida de i pun x coma comida de I pun y coma 20a 0a ma pun pi por 2 coma true Y entonces contexto punto F y ya está y pues contexto punto Fil Style voy a poner que la comida sea Roja de color rojo Así que si todo va bien Vengo por aquí y habré creado pues unos círculos por aquí de comida muy grandes cinco estos círculos representan digamos puntos donde los personajes pueden comer La idea es la siguiente a continuación voy a introducir aquí Qué pasa Hay algún error O es que han desaparecido los elementos vale estaban por ahí voy a hacer una cosa la comida la voy a pintar No sí correcto ahí venga vale Y ahora voy a introducir la comida digamos en la matriz que voy a pasar a los personajes Así que post message y le digo comida es comida o sea le estoy pasando la matriz de la comida para que cuando un personaje se quede sin comida pues sepa dónde puede ir a buscarla me vengo por aquí y digo hambre es igual a cero y cada vez que me muevo pues hambre más ig 0.1 entonces function Busco comida fun como Y entonces ahora fun como Y entonces ahora en Busco comida lo que voy a hacer es que cuando si el hambre el hambre si mi hambre Es mayor que 80 en ese caso pues voy a buscar comida Vale entonces lo que voy a hacer es for Buscar la más cercana for bar I es igual a 0 Y es menor que datos no otros no esto es bar comida es igual a datos. datata comida y entonces voy a decir comida pun leng y más y entonces en este caso lo que voy a hacer es averiguar pues cada uno de ellos es decir para empezar vamos a ver si está cerca var a aquí bar comida bueno y comida distancia es igual a esto y digo si la distancia es menor que 30 vamos a empezar por ahí pues en ese caso lo que voy a hacer es que mi orientación digamos debe ir hacia la comida este caso lo que voy a hacer es Buscar dónde estás javascript angle between two points vamos a verlo y aquí está entonces angle radians vamos a verlo angle radians es igual a Pos y2 o sea comida de X no perdona comida de y menos Pos y comida de X menos Pos x y entonces digo que ángulo dirección es igual a angle radians si esto funciona bien Vamos a verlo si esto funciona bien cuando tengo hambre y estoy a menos de 30 unidades de un punto de comida pues voy a ir hacia la comida vamos a ver si es cierto o no recargo vale vamos a esperar a que tengan hambre y cuando tengan hambre vamos a verlo no sé si están cogiendo vale Ahí se han quedado a dormir vamos a ver si hambre console.log tengo hambre vamos a verlo vamos a esperar un momento y ahora en cuanto se hagan pequeños ahora en cuanto se hagan pequeños pues empezará a decir tengo hambre Ah se han puesto a dormir Qué curioso se ponen a dormir pero nunca dicen que tienen hambre voy a poner Hambre igual a uno vamos a forzar que tengan hambre y esto ya me extraña mucho esto ya me extraña mucho porque nadie está diciendo que tenga hambre bar hambre es igual a cer hambre más igual a un vamos a ver console.log hambre porque ya me está extrañando muchísimo que nadie diga tengo hambre 0 10 20 50 80 90 100 y qué pasa Ah que no estoy ejecutando Busco comida muy bien Eso es lo que pasa así que quito el console Vamos allá y ahora en un momento en principio deberían empezar a buscar comida pero no están buscando vamos a recuperar el tengo hambre ahí Creo que había ido uno por ello tengo hambre pero que yo vea Ahí Ahí sí que parece que efectivamente estn encontrando vamos a decir qu distancia es menor que 50 o que 60 o que 100 o que lo que sea para que lo encuentran mejor tengo hambre vale Y ahí van a comer sí que está funcionando correctamente muy bien vale entonces ahí lo que vamos a hacer es lo siguiente si hambre Es mayor que 80 vale Okay vale Y ahora digo bar hambriento es igual a false Y entonces digo si hambriento es igual a false Ok vale Y ahora digo lo mismo aquí si hambre Es mayor que 80 en ese caso hambriento es true si hambriento es true en ese caso besa por comida ahora si comida vamos a ver si hambre es menor que 20 en ese caso hambriento es igual a false Vale entonces ahora lo que voy a hacer es que cómo vale si distancia es menor que 10 en ese caso hambre menos hombre menos igual cuánto le he puesto antes menos igual a 1 Vamos a verlo cuidado hambriento is not defined bar hambriento It's not defined vale Y entonces ahí tengo hambre va y come y cuando ya ha comido teóricamente debería irse a hacer su marcha vamos a ver cuando ya ha comido debería irse a hacer su marcha vamos a ver por qué no está ocurriendo eso mientras tanto tenemos aquí los que están durmiendo mueve duerme vamos a hacer que todo ocurra muy rápido vale duermen vale les cuesta llegar por la comida vale Y una vez que han comido ahí se quedan ahí entonces hambriento es igual a false si hambre es menor que 20 hambriento es igual a false con lo cual teóricamente deberían dirección es igual a ma punto Random por pi es decir una vez que han comido deberían irse pero no pero se están quedando vale creo que ya lo único es que lo único es que tienen que volver vale pero creo que ya está funcionando Entonces vamos a ver hambre - 0.1 0.1 vamos a dejar que todo ocurra más lentamente 0.1 Y si todo va bien y si todo va bien Ahora sí tenemos ya los personajes Vamos a darle otra vez para Que corran un poquito más rápido en la velocidad má pun Random por 2 + 0.3 Que corran todos Un poquito más vale Ahí los tenemos y teóricamente cuando tengan hambre pues irán a comer ahí lo tenemos tengo hambre claro tengo hambre y tengo sueño también de momento están durmiendo ahora se despertarán y ahí lo tenemos bien Ahora van a comer porque tienen hambre perfecto vale vamos a hacer lo siguiente cuando comen vamos a decirle que coman rápido y luego por otra parte la energía es Random por 100 por 50+ 100 50+ 50 Y esto es lo mismo pero 100 menos Esto vale un poco para que cadao un valor diferente de hambre y de sueño y de todo esto están comiendo y cuando acaban de comer deberían irse Ya se han ido perfecto vamos a poner más personajes pero parece que esto marcha vamos a poner 50 importante que veamos que toda la lógica de cada uno de los personajes está en el worker bien ahora Ahí está ahora vemos Como algunos comen algunos duermen vemos como tienen que descansar de vez en cuando y cuando han descansado pues se recuperan vamos a hacer que duerman un poquito más rápido que recuperen energía un poquito más rápido vamos a ver estamos recargando vamos a verlo bien ahí parece que los últimos cambios que hemos hecho pues como podemos observar en el procesador están haciendo Que bueno que el sistema le cueste así que bueno qué se va a hacer lo que tiene el hecho de que Cuantos más cálculos hagamos pues más va a pesar el procesador ahí los tenemos comiendo algunos durmiendo y ahora lo que voy a hacer lo que voy a hacer es pues poner alguna condición Digamos como de muerte y es que si en un momento dado uno un personaje se queda sin comida si o sea el hambre digamos se le pone a cero Pues el personaje digamos se muere o sea tiene que o sea si descansa vale Pero tiene que encontrar comida porque si no morirá Entonces vamos a por ello vamos a por ello Vamos a intentarlo y a ver si tenemos suerte y no se nos muere ninguno lo que voy a hacer ahora por tanto es decirle al sistema que fun muerte y voy decirle que si hambre es menor que cer en ese caso muerto es igual a true y por tanto todo esto lo que hace es bueno aparte de que le voy a decir que dónde está CR es = a 0 o sea es de color negro fg = 0 cb es = 0 y por tanto voy a decirle al sistema que si todo esto depende de muerto es igual a false Porque si el personaje está muerto pues ya no hace falta que hagamos todo esto y Okay vamos a por ello voy a poner 30 personajes y vamos a por ello recargamos vamos a verlo no sé si ha recargado Yo diría que no vamos a verlo ahora Vale entonces La idea es que ninguno se quede sin energía pero claro cuando duerme técnicamente no pierde energía Pero bueno cuando duerme técnicamente creo que ahí no voy a decer una cosa cuando duerme hambre es igual a 0.1 voy a poner no voy a ser muy cruel en el sentido de que cuando el personaje duerme Pues bueno pierdo un poco de energía pero o sea gana un poco de hambre quiero decir pero tampoco tanto como cuando está caminando Así que ahí los personajes están comiendo vale Ahí se van pero vuelven yo creo que cuando se están comiendo la energía les puede subir a infinito con lo cual pues alguno estará acumulando energía infinita prácticamente y por tanto o hambre negativo y por tanto no podrán morir por suerte para ellos pero como podemos ver pues bueno inent estar cerca de la comida lo cual es Pues cuando menos curioso una cosa que puedo hacer es decir que si hambre cuidado hambre menor que cero hambre mayor que 100 a ver creo que lo he puesto bien hambre claro bien vale si hambre aquí si hambre es menor que cer en ese caso hambre es igual a cer si energía es igual a 100 en ese caso energía es igual a 100 esto es mayor que 100 lo que estoy haciendo es que los personajillos pues no puedan hacer ciertas trampas digamos que no puedan tener energía infinita que no puedan tener hambre negativa todo esto bien pues ahí los Tenemos uno se ha quedado dormido justo antes de llegar la comida es curioso y bueno como vemos pues están cumpliendo que cuando tienen hambre pues van a los huecos de comida y cuando han comido o cuando han descansado pues se van muy bien bueno y siempre se puede realizar algún ajuste eh Por ejemplo en este caso observo que al rato de haber dejado esto un poco funcionando Pues de alguna forma es como que se juntan todos en el en los comederos pero yo creo que no es por un tema de avaricia por comer sino que es por un tema de que se quedan atrapados porque antes cuando le he dicho que choquen lo que le he dicho realmente es que se den la vuelta a 180 gr pero creo que ese la vuelta a veces los deja un poco atrapados vamos a venir aquí vamos a venir a cambia dirección entonces voy a hacer lo siguiente bueno cambio de dirección no perdona colisión vale No colisión apes no dónde estás evitarse aquí está entonces voy a buscar la función de buscar comida y lo que voy a hacer con esto es el ángulo en radianes vamos a ver voy a decirle que angle radians voy a darle la vuelta a las cosas que es Pos y menos esto y Pos x menos esto por qué Pues porque no quiero que vayan el uno hacia el otro con la comida quiero que huyan el uno del otro Así que vengo por aquí dirección es igual a angle radians y vamos a probarlo Entonces ahora lo que va a ocurrir es que Eh Pues cuando alguien va a colisionar pues eh Pues intenta huir digamos en la dirección contraria vamos a ver al intentar huir vamos a verlo ahí esos no sé si es que están durmiendo o es que se han quedado atrapados o qué vale Ahí sí que están durmiendo bueno interesante curioso porque por una parte quieren comer pero por otra parte están atrapados y ahora se quedan más atrapados todavía que antes lo cual no deja de ser curioso voy a hacer una cosa voy a hacer que orbit así que más ma pun pi par 2 lo que van a hacer es orbitar 90 gr Esto va a hacer un efecto bastante curioso y vamos a verlo vale ahí y lo que ocurre y lo que ocurre ahí vale es que quedan un poco atrapados entre sí se evitan Pero al final pues no pued no pueden evitar digamos vamos a ver lo que puedo hacer es digamos eximirlos o hacer el tamaño más grande o más pequeño quería decir a ver si distancias menor que cco y distancias mayor que tres y voy a hacer incluso y hambriento es igual a false digamos que no se busquen cuando están hambrientos No lo sé vamos a verlo La idea es ir probando Así que cuando no están hambrientos pues La idea es que entonces puedan tener más libertad vamos a verlo ahí ahora se supone que están comiendo Pero yo creo que unos cuantos se han quedado pados Así que la idea es esa La idea es que como vemos en un momento dado Bueno aparte de que se hay uno que se ha quedado durmiendo Pero de alguna forma lo que puedo hacer es que se eviten entre sí por ejemplo claro es que ese nunca llega a comer y vamos a decirles que dirección angle radians y voy a ver si puedo decirles que caminen un poquito O sea que se eviten y que peguen un golpe digamos y la idea es que cuando colisionen entre sí pues se pegen un empujón digamos Pero bueno algo tendré que retocar en el código porque como podemos ver pues yo creo que se quedan muy enganchados entre ellos yo creo que se quedan enganchados vamos a ver si con que estén lejos que ya coman Busco comida si distancia es menor que vamos a poner 50 pues ya comen y así un poco la idea es que mira coman todos a comer La idea es que puedan comer y no se queden atrapados porque haya otros que no les dejen comer y ahí salen ahí se han quedado enganchados y bueno como vemos La idea es ir retocando el código hasta que finalmente pues tengamos un poco el comportamiento que esperamos vamos a verlo Y esa es un poco la idea Bueno por último voy a aprovechar para hacer un repaso de lo que hemos hecho en el ejercicio sobre todo voy a comentar el archivo tarea 8 que es el archivo que más tengo sin comentar Así que vamos a por ello vamos a crear una serie de comentarios originalmente le asigno un identificador a este objeto a continuación le asigno una variable que recibirá la colección de datos que corresponden a los otros objetos le asigno una variable que corresponderá a la colección de datos que corresponde a la comida bien Y entonces digo esta función se ejecuta cuando recibo un mensaje mi identificador es el que le pasa la función principal recojo quieto aquí recojo los datos de los otros objetos y los pongo dentro de la variable y recojo los datos de la comida y los pongo en la variable bien Esta es una línea que realmente al final no hace nada recordemos vale ahora vamos a ver como en un momento dado voy a tener un bucle coma arranco una variable temporizador llamo a la función de inicio que se ejecuta una vez cuando el personaje nace coma Le aplico una posición x aleatoria de la misma forma le aplico una posición y aleatoria le pongo un color rojo aleatorio le pongo un color verde aleatorio le pongo un color azul aleatorio y ahora en las propiedades del objeto le pongo un tamaño inicial de dos que luego ya cambiaremos le doy una dirección inicial aleatoria entre 0 y 360 gr doy una velocidad inicial aleatoria le proporciono una energía inicial aleatoria le doy una cantidad inicial de hambre aleatoria y por defecto cuando el personaje arranca por defecto no está muerto cuando el personaje arranca coma por defecto no está dormido cuando el personaje arranca por defecto no está hambriento y ahora cuando el personaje arranca coma por defecto no está hambriento Vale ahora ejecuto la función de inicio aquí estaría bien que pusiera un espacio no la función de inicio de momento lo único que hace es llamar al bucle el bucle que está aquí abajo del todo ahora llegaremos a él entonces esta función Busca los bordes y conecta las colisiones Entonces si es cierto que el personaje está fuera de los rangos de la imagen Entonces en ese caso el personaje pega la vuelta esta función se encarga de gestionar el movimiento del personaje actualizamos la posición X en base al coseno trigonométrico de la dirección por la velocidad coche no coseno actualizamos la posición y en base al seno trigonométrico cuando el personaje se está moviendo inevitablemente pierde un poco de energía y cuando el personaje se está moviendo gana un poquito de hambre Vale ahora vamos a ver esta función controla que el personaje vaya cambiando poco a poco de dirección y por tanto le añadimos una pequeña componente aleatoria al ángulo de dirección del personaje esta función se encarga de la búsqueda de comida solo se ejecuta en el caso de que el personaje esté hambriento miramos dónde están todos los comederos para cada uno de los comederos sacamos la distancia horizontal sacamos a continuación la distancia en vertical y mediante esta fórmula calculamos el módulo de la distancia Entonces en el caso de que la distancia sea menor que 60 coma es decir coma que esté cerca me dirijo hacia ese comedero esto quiere decir actualizo mi ángulo y en el caso de que la distancia sea poca rebajo mi cantidad de hambre coma lo que quiere decir que estoy comiendo la función como al final no la he llamado y esta función gestiona que los personajes se eviten entre sí sacamos la distancia en horizontal sacamos la distancia en vertical miro dónde están todos y cada uno del resto de los personajes para cada uno de los personajes mido mi distancia con respecto a ellos y en el caso de que el personaje esté cerca Busco el ángulo de escape y lo aplico a mi ángulo actualizo mi posición x con respecto a ese nuevo ángulo actualizo mi posición y con respecto a ese nuevo ángulo y temporalmente cambio mi tamaño simplemente para que se sepa que he colisionado y ahora la función duerme Esto es lo que ocurre cuando el personaje duerme su energía se recupera Pero cuidado porque su hambre también sube y esto es lo que ocurre cuando el personaje muere por defecto la variable muerte se pone en verdadero su color se vuelve negro creo que no he puesto aquí la función Muerte en ninguna parte si hambre es menor que cero hambre es igual a cero sin muerto false y creo que no he visto por ninguna parte donde realmente se muera al personaje bueno no pasa nada esta es la función de bucle que se ejecuta constantemente no es posible tener hambre negativa sin energía cuidado esto aquí no es posible Tener más de 100 puntos de energía y entonces si el personaje está vivo en ese caso su tamaño está en función de su energía activamos la función de colisión de bordes activamos la función de cambio de dirección activamos la función de búsqueda de comida si el personaje tiene poca energía se queda dormido si el personaje está dormido Se ejecuta la función de dormir Si la energía del personaje está por encima de 80 deja de dormir Si el personaje ya no está dormido Se puede mover si el hambre personaje está por encima de 80 quiere decir que está hambriento si el hambre está por debajo de 20 deja de estar hambriento activamos la función de evitarse y pasamos a la función principal los datos del personaje Opa limpiamos el temporizador anterior y creamos un temporizador recursivo que se llama así mismo para hacer otra vuelta del bucle y con esto por tanto como vemos tenemos ya el código comentado para que en un momento dado pues podamos tener la documentación de qué es lo que hace cada línea de este archivo voy a arrancar un proyecto que es un proyecto un poco curioso porque es un auto juu voy a poner Game of Life El juego de la vida entonces si pongo el juego de la vida en principio podemos parecer podemos pensar vamos a ver si esto recarga podemos pensar Game of Life que esto es más parecido digamos a un juego que una aplicación de digna de procesos y servicios de multiproceso en este caso pero como voy a mostrar a lo largo de este ejercicio pues realmente es un buen ejercicio para realizar dentro de procesos dentro del análisis de multiproceso multiprocesador multitarea y computación distribuida en general bien El juego de la vida básicamente es este juego de Aquí vamos a darle a Start y es este juego que estamos viendo puedo hacer clic puedo crear por aquí más puntitos de estos y digamos que vemos como tenemos un patrón que va creciendo El juego de la vida tiene una serie de reglas tiene unas reglas concretas que vamos a analizar a continuación vamos en primer lugar a la página de la Wikipedia para averiguar un poco más de esto de este juego o de este Auto juego o de este no juego podemos ver que es básicamente bueno Vamos a darle aquí a Play podemos ver que es eh un automate celular es un auto juego diseñado por un matemático en 1970 es decir lo diseñó sobre papel como un juego matemático y luego más adelante pues con la popularización digamos de la informática pues han aparecido cosas como la que tenemos hoy en día que es Eh pues la implementación informática de este juego de la vida para muchos programadores para muchos áticos Pues el juego de la vida es algo así como el holam mundo es decir en algún momento de tu vida Pues tienes que hacer un juego de la vida vale es como uno de estos proyectos inevitables como uno de estos proyectos obligatorios digamos entre comillas evidentemente que Eh Pues bueno que tenemos todos que aprender entonces hay una serie de reglas sobre todo estoy vio en la página de la Wikipedia porque Bueno hay por aquí un una serie de formas predeterminadas vale para que bueno Esto es ya más digamos para estudiosos de del juego de la vida pero Eh hay por aquí una serie de reglas en la Aquí está no Estas son las variantes vamos a vamos a No aquí Bueno aquí vale Estas son las reglas y lo que voy a hacer a continuación a lo largo de estos ejercicios y a lo largo de estos vídeos es implementar el juego de la vida pero eh primero lo voy a hacer mal entre comillas vale Y luego eh lo voy a hacer bien lo voy a optimizar voy a hacer que el programa sea más óptimo por eso no es que al principio lo vaya a hacer mal pero al principio lo voy a hacer de forma secuencial pero luego voy a ir modificando este código para que sea eh pues multiproceso multitarea para que sea más eficiente para que por tanto vaya más rápido esto es algo que queremos notar y eh Y luego lo haré incluso con computación distribuida lo cual nos llevará al siguiente tema que es la comunicación de red Así que vamos allá vamos a ver vamos a por ello vamos a continuación a crear una nueva carpeta voy a crear una nueva carpeta aquí en aplicaciones o aquí en hddc realmente voy a hacer una carpeta llamada juego de la vida y en el juego de la vida voy a poner 2021 porque luego cuando archivo estos proyectos Pues tengo un montón de juegos deos diferentes Entonces vamos a ver 2021 o voy a poner juego de la vida 21 Vale entonces entro por aquí voy a entrar en brackets vale Y voy a crear un nuevo proyecto lo voy a guardar voy a ir a cht Doc voy a ir Ju de la 2021 voy a crear un archivo llamado index html y a continuación voy a hacer lo siguiente momento que estoy guardando una vez más voy a intentar hacer el código lo más sencillo que pueda lo más sencillo que sea posible puesto que ya se complicarán vamos revisando las reglas y nos dice una célula muerta Blanca digamos con exactamente tres células vecinas vivas nace vale al turno siguiente estará viva Okay una célula viva con dos o tres células sigue viva Pero si tiene menos de dos o más de tres muere por soledad o por superpoblación ya tenemos aquí una serie de reglas como para poder empezar a trabajar correctamente Bueno veo que se ha quedado frito el brackets no sé bien por qué pero lo que voy a hacer es que lo voy a cerrar a las bravas y voy a abrirlo entonces juego de la vida 21 Lo abro con bracket vamos a ver si ahora carga razonablemente rápido Okay aquí lo tenemos bien entonces Bueno voy a hacer hacerlo correcto doc type html por aquí Head por aquí Body por aquí vale Y eh vamos a ver un momentín okay Y entonces eh Bueno pues lo que voy a hacer por aquí es poner un Canvas Que de momento va a tener un wid de 512 píxeles y un High de 512 píxeles esto cambiará luego pero ahora de momento para trabajar para hacerlo lo más sencillo posible insisto y ahora voy a hacer un Script y aquí dentro voy a empezar a trabajar luego por otra parte aquí en el Head voy a hacer un pequeño Style y Dentro de este Style voy a decir que simplemente el Canvas tiene un Border de un Pixel solid Grey simple para verlo así que ahora vengo por aquí y bueno arranco el mamp Por qué no vamos a verlo arranco el mamp le doy a local Host juego de la vida 21 y ahí lo tenemos vale Ahí tenemos nuestro Canvas y ahora por aquí vamos a trabajar el código Así que dejo el Canvas aquí me llevo el brackets Aquí y ahora vamos a empezar a trabajar bien Ahora a continuación lo que voy a decir es que para empezar el juego de la vida voy a crear una serie de píxeles iniciales entonces contexto es igual a document get Element by ID Lienzo esto debería llamarse Lienzo vale Lienzo y get context 2D cuidado Vale y ahora eh digo carga inicial de píxeles negros vivos digamos entre comillas vamos a hacer como que los blancos están muertos y los negros están vivos esto más adelante podemos cambiarlo vale Aunque es un poco lo menos importante ahora mismo pero bueno entonces eh voy a decir ahora qu vamos a ver de qué forma lo puedo hacer Bueno puedo repasar todo el pixxel no sé vamos a probar lo siguiente bar datos Canvas es igual a context.get image Data desde 0,0 hasta 512512 Y entonces para o sea repaso cada uno de estos for bar I es ig 0 I es menor a eh contexto datata length y i+ más OK Y entonces digo If ma. Random es menor que 0.5 ahora hablamos de esto yo en ese caso voy a decir esto es más igual a 4 Por cierto para repasar cada cuatro bloques de píxel entonces voy a decir que datos Canvas punto Data No espérate get image Data vale Sí punto Data de Okay es igual a cer casi que lo voy a hacer con color rojo ya está els en lugar de aparecer negro y blanco creo que va a aparecer rojo y blanco y 255 Y por último después de todo esto contexto put image Data y quiero poner datos Canvas en 0,0 y yo creo que ya vamos a probarlo a ver si no tengo ningún error recargo vamos a verlo quizás tenga algún error un error vale no puedo leer las propiedades de undefine and length Entonces no es sí no es datos Canvas esto es vale recargo y vamos a verlo en principio no vale voy a hacer una cosa también Y es que contexto punto fillrect desde 0,0 hasta 512512 Y entonces ocurre eso ahora sí y ahora contexto punto Style es igual a rgb 255,255 o sea lo pinto de blanco o selecciono el color blanco pinto un rectángulo porque si no es que tenía el contexto vacío y cuando digo vacío es vacío Entonces no tenía mucho sobre lo que trabajar ent ahora guardo recargo y veo que en este caso lo que está haciendo bueno me lo está poniendo cian vamos a ver me lo está poniendo cian que es lo contrario de lo que esperaba vamos a ver Mira sabes qué voy a hacerlo con blanco y negro y ya está y + 1 y + 2 y esto es I + 1 e i + 2 El I + 3 no lo toco porque es el canal transparencia y no me interesa tocarlo ahora mismo vale Y ahora lo que tengo ahí pues es una un patrón voy a asegurarme que esto esté al 100% es patrón de píxeles digamos aleatorios para cada píxel está decidiendo si Eh pues eso si el Pixel pues está vivo o está muerto ahora mismo con un math Random de 0,5 digamos que tenemos mitad de probabilidades de que el Pixel esté vivo mitad de probabilidades de que el píxel esté muerto podemos variar para decirle Por ejemplo 0.1 Y entonces lo que va a hacer es que habrá nueve veces más probabilidad desde que el píxel esté muerto que vivo Vale entonces ahí podemos Pues cambiarlo puedo decir 0.03 vale puedo variar la probabilidad para pues para lo que me interese realmente vale para indicar si los píxeles estarán vivos estarán Muertos o lo que sea ahora a continuación tocaremos este parámetro voy a dejarlo a 0,1 o 0,2 para que haya suficiente densidad como para que el juego empiece y ya está por qué sé que 0,2 es una buena densidad Pues porque heo este juego mil veces antes con lo cual pues quieras que no pues me acuerdo de unos cuantos parámetros de memoria vale Así que ya tenemos la base y ahora lo que queremos evidentemente es poner el juego en funcionamiento queremos entrar en un bucle y queremos empezar a calcular el juego de la vida pero con los parámetros que hemos visto aquí en la página de la Wikipedia a ver que lo recupere no me he pasado pero bueno con los parámetros con el aquí está con el algoritmo que hemos visto que hay en la Wikipedia en la página en inglés del juego de la vida de hecho hay más información todavía vale Pero bueno con esto ya tenemos por lo menos para empezar a trabajar muy bien pues continuamos entonces ahora voy a entrar dentro de lo que conocemos como el bucle Así que digo function bueno primero bar temporizador es igual a set Time out Bueno realmente nada un momentín Y entonces sí set Time out y quiero ejecutar bucle en 100 milisegundos o un segundo Por qué no Entonces ahora digo function bucle y en el bucle lo que hago es un Clear Time out no esto no un Clear Time out del temporizador y ación sin redlar el temporizador pero lo vuelvo a arrancar digamos que estoy haciendo un bucle cada segundo Y entonces ahora lo que puedo hacer es decirle al sistema que pues quiero empezar a trabajar con cada uno de estos píxeles vamos a por ello vengo por aquí y hago lo siguiente Primero cojo la información que tengo voy a hacer un programa extremadamente momento ineficiente que va a funcionar Pero va a ser muy ineficiente y a continuación de ahí iremos iterando para hacerlo más eficiente y para analizar digamos pues qué cuellos de botella podemos quitar qué podemos distribuir Cómo podemos hacer que no sea secuencial sino que sea paralelo y todo esto ahora mismo me interesa que funcione y más adelante me interesará que funcione mejor así que Primero cojo lo que tengo entonces vengo por aquí y digo datos Canvas es igual a esto de aquí podéis empezar a preguntar bueno por qué lo vuelves a si ya lo tenías cogido Pues ahora luego hablaremos de esto pero de momento lo cojo para asegurarme digamos pero ahora luego veremos si hace falta asegurarme o no Entonces ahora vuelvo a realizar esto vuelvo a realizar el bucle en el cual pues calculo todo lo que tengo bien y voy a hacer lo siguiente bar anchura es igual a 512 Ok bar altura es igual a 512 bien Y entonces y Enton digo lo siguiente vamos a ver y entonces digo datos canvas. datata length ahora para cada uno de los píxeles quiero lo que haya pues como te diría yo alrededor es decir tanto en la célula muerta como en la célula viva lo que hacemos en cada célula es analizar Qué es lo que tiene alrededor entonces para cada una de las células y más ig a 4 Quiero ver las ocho células que tiene a su alrededor entonces digo bar número vivas por ejemplo es igual a c y entonces digo If y ahora tenemos que ver qué pasa If datos Canvas punto Data de I y ahora menos anchura por 4 menos cuatro es decir el componente rojo es igual a cer eso quiere decir que número vivas más eso quiere decir que la célula de arriba a la izquierda está viva ahora vamos a continuar datos Canvas de Data y menos anchura por 4 menos nada Es decir la el píxel de justo arriba es este de aquí vale estoy mirando solo el componente rojo no hace falta mirar componente verde ni el componente azul Esto es lo mismo + 4 Esta es la célula de arriba a la derecha esto es I -4 es la célula vecina de la izquierda yo mismo a mí mismo no me voy a ver con lo cual es +4 me voy directamente a la célula de la derecha y ahora voy a copiar estas tres para decir la célula de abajo a la izquierda la célula de abajo y la célula de abajo a la derecha y entonces una vez que tengo esto número vivas me dice cuántas células vivas hay así que a continuación lo que voy a hacer vamos a verlo es decir sí y ahora es cuando implementamos el algoritmo que tenemos aquí en la Wikipedia dice si una célula muerta con exactamente tres células vecinas vivas Vale entonces digo si datos Canvas datata di es igual a 255 O sea la célula está viva Perdón la célula está muerta quiero decir vale anda número vivas es igual a 3 dice exactamente tres células vivas vale en ese caso digo datos Canvas punto Data de I es igual a cer la célula vive la célula de repente vive I + 1 e i + 2 La el componente verde el componente azul okay Ahora ya he implementado esta condición del algoritmo ahora una célula viva una célula viva es cero con dos o tres células vivas vamos a ver and número vivas and pongo una condición es igual a o número vivas es igual a 2 voy a hacer una cosa voy a hacer un inf anidado que yo creo que en este caso me conviene okay Ahora aquí digo sí número bbas es esto en ese caso pasa algo en caso contrario pasa otra cosa Vale entonces datos Canvas vamos a ver que no me acuerdo de memoria si es igual a dos o es igual a tres sigue viva es decir cero en caso contrario muere o sea blanco Okay Y yo creo que haciendo esto ya lo tenemos vamos a ver un momento vamos a ver un momento vale vamos a verlo a veces cuando hago esto se me engancha un poco pero no pasa nada ahora por último lo que voy a hacer es esto es contexto put image Data voy a poner el lo que he modificado o sea los números que he modificado los convierto en una imagen vamos a comprobarlo Así que recargo y teóricamente a ver quizás tengo algún error Por eso no se pone en marcha No tengo ningún error vale vamos a ver console.log bucle guardo recargo inspeccion bucle vale está funcionando Ok con esto vamos a verlo datos Canvas vamos a ver contexto Data no se está produciendo ningún cambio voy a poner el bucle mucho más rápido vale cuidado ahí porque ahora esto quería confirmar que estoy en el bucle ya he confirmado que estoy en el bucle bien y ahora simplemente los píxeles no se están moviendo Así que voy a ver qué es lo que qué es lo que ocurre Canvas punto Data Ah muy bien fantástico y lo que ha ocurrido es que estos ifs Data de tienen que ir dentro del bucle for entonces tienen que ir aquí dentro por eso es importante sangrar correctamente para ver este bucle for no Esto va Aquí y ahora vamos a recargar y eso ya es otra cosa Vale ahí ya tenemos como podemos ver una especie de juego de la vida de momento se comporta un poco raro no pasa nada vamos a verlo voy a poner 0.1 Vale y vemos que va creciendo un poco raro no se comporta como debería comportarse El juego de la vida es normal ahora veremos el error que he cometido pero de momento ya tenemos algo en pantalla vale Ya tenemos una especie de auto juu que va creciendo Aunque crece de una forma un poco extraña pero por lo menos ya tenemos un inicio de lo que quiero mostrar voy a poner el zoom un poco más grande y así pues un poco veremos el patrón un poco mejor vale Y de momento tengo esto pues vamos a ver a continuación qué es lo que ha pasado vale Por qué ha ocurrido esto y qué es lo que quiero hacer Entonces vamos a ver el siguiente vídeo Bueno pues lo que ha ocurrido es que no debo estar tocando el mismo contexto Vale entonces lo que voy a hacer es lo siguiente vamos a ver datos Canvas y ahora voy a crear una variable llamada datos Canvas eh Temporal y entonces da igual que coja uno que otro porque realmente es lo mismo pero voy a comprobar el datos Canvas temporal pero cuando compruebo voy a hacer esto un poco más pequeño texto un poco más pequeño cuando edito el datos canva temporal al final y aquí está lo que quiero modificar es el datos Canvas es decir tengo el problema Si a la vez estoy leyendo y a la vez estoy modificando el datos Canvas entonces lo que hago es guardarme el datos Canvas en un Temporal y Modificar el datos Canvas real y esto lo que va a hacer ahora cuando recargue es que ahora sí esta pequeña tontería que acabo de hacer hace que como podemos comprobar el juego se comporte como el juego de la vida Ya sé que lo que acabo de hacer es difícil de entender es decir cómo es posible que antes no funcionaba o funcionaba mal y con esto funciona pues simplemente la razón si nos paramos a pensarlo matemáticamente tiene todo el sentido Pero a mí las primeras veces que me pasó Me costó entender el porqué pero lo que ha ocurrido simplemente es que si estoy leyendo y a la vez estoy viendo el datos Canvas es un lío porque a la vez que lo estoy leyendo lo estoy modificando y por eso se raya como se rayaba antes entonces lo que hago es un datos canva ten para solo leer y un datos Canvas para solo escribir separando la lectura de la escritura como vemos este ejercicio funciona correctamente bien pues aquí lo tenemos aquí tenemos ya un primer juego de la vida en funcionamiento como os he comentado antes pues poniendo la densidad a 0,1 0,2 pues sale bien vale vamos a ponerlo lo he puesto antes a 0,1 voy a ponerlo a 0,2 y vamos probando vale hay que justo el punto entonces ahí veo que con un 0,2 Pues también sale bien pues hay veces que si bajo más eh los bichitos desaparecen Y si pongo más se saturan vale entonces 0,1 Pruébalo evidentemente es la idea es lo que quiero pero la idea es esta vale Aquí tengo Pues un juego de la vida con el cual puedo empezar a disfrutar pero ahora tengo un problema y el problema que tengo por tanto es que Eh pues este juego de la vida no es muy eficiente voy a bajar el Time out a cero recargo y por tanto este juego va todo lo rápido que puede ir Cuando digo todo lo rápido que puede ir lo que quiero decir es que si yo ahora saco el monitor voy a poder comprobar Pues que bueno en este caso vamos a verlo un momentín aparte de que tengo aquí el Google Chrome pero luego tengo también el obs grabando evidentemente O sea no estoy utilizando los cuatro núcleos del procesador O no estoy utilizando digamos todos los recursos que tenga mi ordenador Por qué Pues porque este proceso digamos es lento vale este proceso lo que está haciendo es revisar uno a uno los píxeles y pues eso tarda lo suyo evidentemente yo ahora incluso de lo que puedo hacer es decirle al sistema que ya no quiero 512 por 512 sino quiero lo siguiente vamos a hacer una versión dos vamos a hacer el juego de la vida en grande y al hacer el juego de la vida en grande veremos cómo pues va sensiblemente más lento al hacerlo más grande veremos como pues ya una cosa es calcular 512 por 512 y otra cosa es calcular pues por ejemplo 1920 por 1080 o sea Full HD vamos a decir lo siguiente vamos a decir que anchura es igual a window Inner wid y altura es igual a window Inner height Vale ahora le digo lo siguiente eh document.get Element by ID Lienzo punto eh wid es igual a anchura y lo mismo para el height es altura Así que guardo y recargo y ahora un momentín ahora vamos a eso vamos a ver vale pone 512 por 500 ahora arreglaré eso no os preocupéis que eso es lo de menos ahora mismo Vale entonces yo lo que quiero ahora un momentín javascript set object with entonces no sé si aho sty punto with no es atributo no quiero el estilo object with no Style with ese sí punto with es igual a esto Ah sí Bueno claro A ver espérate si no lo hago grande Ahora sí vale entonces Bueno ahora me está fallando ahora sí que no sé por qué un momentín vamos a ver html com Body le digo padding cero píxeles margin 0 píxeles y overflow hidden Vale y ahora vamos a ver ahí se me está yendo y no sé por qué no sé por qué Aquí está el problema esto es anchura coma altura y esto es anchura coma altura y esto es anchura coma altura y yo creo que ya está vamos a probarlo ahora vale No pasa nada por todo el caos ese que hay ahí Entonces vamos a decirle al sistema Aquí está que anchura coma altura y ya está así que vamos a probarlo ahora Vale ahora ya tenemos un juego de la vida a pantalla completa en el sentido de que incluso si ahora vengo por aquí y le digo que quiero recargar Pues tengo un juego de la vida literalmente en pantalla completa de hecho puedo venir por aquí y decirle que lo quiero sin zoom y ahora recargo y al recargar yo creo que se puede apreciar dentro de ese m Magnum que tenemos ahora mismo en la pantalla pero se puede apreciar que va más lento se puede apreciar que fácilmente estoy llegando a uno de los límites del sistema vale fácilmente se puede apreciar que solo con que lo ponga a 1920 por 1080 pues este juego ya va lento con respecto a cuando lo tenía antes en la otra pantalla entonces La idea es a partir de aquí la idea es a partir de este momento pues analizar qué es lo que puedo hacer para que el juego vaya más rápido vale para que este juego que estamos viendo pues como te diría yo en un momento dado pues se calcule más rápido de lo que se está calculando para ello vamos a aplicar diferentes técnicas de optimización vamos a trabajar con workers vamos a trabajar con diferentes tipos de recursos pero En definitiva para hacer que este mismo ejercicio que tenemos en la pantalla pues consigamos que vaya más rápido voy a hacer la pantalla más pequeña me voy a ir a 200 voy a recargar Ah un momentín vale Y así lo veremos más rápido pero también sobre todo lo importante es que lo veremos más grande de hecho Incluso le podría dar más todavía eh una cosa que puedo hacer vemos Que si lo pongo a 500 vemos que aparece un poco como con antialias Vale entonces lo que puedo hacer es intentar decirle al sistema mediante css que me quite el antialias Entonces fss remove antialias vamos a ver font sming no remove image antialiasing y vamos a ver no vale vamos a por esto así que Canvas vamos a poner ya el estilo así y si todo ha ido bien este código es para mozila para opera para Chrome vale Y para Microsoft Así que vengo aquí recargo y no en principio no lo está haciendo vale venga vamos a ver vamos a verlo Ahora sí vale Esto es lo que quiero Voy a bajar ahora un poco la velocidad ya que ya hemos visto que tenemos un problema ya no hace falta ilustrar el problema y así pues un poco el código funciona un poco más lento y o sea ahora artificialmente pero por lo menos podemos ver lo que ocurre en la pantalla y vemos Que pues esto que tenemos aquí es el juego de la vida y ahora como digo a continuación pues lo que vamos a hacer en los siguientes bloques es optimizar su funcionamiento y al optimizar su funcionamiento pues vamos a eh como diría yo vamos a mejorar su velocidad y vamos a mejorar su rendimiento Bueno pues a continuación lo que voy a hacer es separar esto en workers voy a cerrar varias cosas voy a hacer esto más grande voy a reiniciar bien y a continuación lo que voy a hacer es guardar la versión dos así que Index 2. html y vamos a empezar a trabajar con workers de hecho como digo pues bueno voy a eliminar Prácticamente todo y ahora luego recuperaré el contenido Vale y vengo por aquí y voy a ir a la versión 2 Index 2 html Vale y tengo de momento esto y ahora lo que voy a hacer Es que voy a crear una serie de workers digo vamos a ver bar número workers es igual a hardware no a ver ah html5 number of ofes Así que Hardware Esto es lo que quiero así que esto bien y ahora digo que for y es ig 0 Y es menor que número workers y má bien Y entonces ahora lo que voy a hacer es que bar trabajador es igual a New array y le digo que trabajador de I es igual a New worker y voy a decir que es trabajador punto js y voy a crear evidentemente el archivo trabajador js vamos a ver aquí trabajador js Que de momento va a decir console.log hola Así que si todo va bien refrescamos por aquí recargamos por aquí vale Y en principio vamos a verlo console log Hola vale Y ahora pu vamos a ver trabajador de i New worker bueno a ver voy a poner console punto log arranco un trabajador vale Ahí está el problema recargo estoy trabajando en Index 2 console.log numero workers vamos a ver cuántos núcleos tenemos undefined vale Y entonces vamos a ver el windows.net Hardware concurrency Este es el tema vale Y ahora vengo por aquí y dice hola hola porque básicamente lo que ocurre Es que desde el worker desde el trabajador pues estoy diciendo hola muy bien ahora por tanto ahora ya puedo quitar este console pun log y ya puedo quitar este console punto log ya lo tengo en funcionamiento vale Y ahora lo que voy a hacer es que a Cada trabajador le voy a enviar unos datos concretos V le voy a enviar Pues bueno vamos a verlo vamos a ver le voy a enviar un cacho de la imagen y en ese Cacho de la imagen habrá unos píxeles y lo que quiero es que calcule digamos los píxeles voy a enviarle por tanto trabajador js vamos a ver New worker está enviando un mensaje y el trabajador dice on message es igual a on message es igual a vamos a verlo a function y console.log Hola Así que ok vale muy bien y vamos a un momento hddc procesos tarea 5 por ejemplo on message function datos por ejemplo vamos a verlo y on message function Vale pues bueno vamos a ver Vamos allá a ver qué le puedo pasar a ver un momento que repase este código de aquí Esto es lo que esto es lo que quiero vale venga voy a esto por aquí vale Entonces ahora le digo trabajador post message qué le paso pues le quiero pasar un bloque Entonces vamos a ver lo que hago es que pu x es igual a o x es igual a ma pun round coma ma pun Random multiplicado por anchura y ahora la y es lo mismo pero por la altura y lo que le voy a pasar en este caso es eh bar datos es igual a contexto pun get image Data de X y33 es decir un bloque de 3x 3 píxeles Por qué 3 por 3 píxeles porque quiero el píxel del centro y los ocho de alrededor para ver que hay alrededor entonces post message datos esto voy a pararlo un momento un segn Y entonces ahora en el trabajador digo función datos console datos Así que vamos a probarlo recargo vale Y ahí tenemos el evento y el evento tiene un Data que es un image Data y en el Data ahí lo tenemos vale voy a decir datos. Data datata y ahí tenemos por tanto todos los bytes vale Ahí tenemos todos los Qué raro que sea 255 todo Ah no Mira se ve que he pillado uno vacío vale Ahí tenemos más Muy bien pues ahora lo que queremos es decirle vamos a ver ahora lo que queremos es decirle al sistema que H mire a ver qué hay alrededor vamos a por ello Entonces ahora Lo que quiero es digamos poder decirle al sistema qué es lo que tiene que hacer Vamos a ver ahora digo Bueno célula del medio A ver vamos a recuperar aquí una célula muerta Okay entonces es igual a datos pun datata Data de qué pues son 3 vamos a ver son 3 + 3 + 3 + 3 + 3 realmente es 4 Perdón 4 + 4 + 4 + 4 má más yo creo que ya a ver c es una + 4 + 4 vale + 4 + 4 Ahora sí esa es la célula del centro entonces digo si centro es igual a cer O sea si la célula está viva vamos a muerta si la célula está muerta Entonces yo ahora vengo y digo vamos a ver entonces nace vale Ok digo bar células vivas es igual a cer Y entonces digo si datos punto Data de cer vale es igual a cer es viva es igual a células vivas más ahora voy a hacer lo mismo eh un moment sí 0 + 4 0 + 4 + 4 0 + 4 + a ver 4 + 4 y ahora 0 + 4 + 4 + 4 pero no + 4 porque es el centro sino + 4 que es la de la derecha y ahora 0 + 4 + 4 + 4 es abajo a la izquierda + 4 es justo abajo y + 4 es abajo a la derecha Y entonces ahora digo si células vivas es igual a 3 en ese caso return viva return que return true voy a decir true es viva false es falsa Vale ahora digo si el centro es igual a cer si la célula esta viva rehago esto mismo otra vez realmente Aquí vamos a ver voy a hacer lo siguiente si el centro es igual a 255 así y a Sí ahora si el centro está vivo en ese caso digo si células vivas es igual a TR o células vivas es igual a dos en ese caso pasa una cosa si no pasa otra cosa Entonces esto es return true vamos a ver return true return false voy a hacer una cosa me vengo al trabajador y esst message aquí exp message true post message false Así que vamos a verlo si todo ha ido bien esto ya no hace falta ya lo tengo claro me voy Aquí y ahora cuando el trabajador me envía un mensaje voy a decir console pun log datos Data momento Quiero ver qué es exactamente lo que me devuelve vamos a verlo recargo y me dice un false y dos true Qué raro hay alguna que no me devuelve nada eh Y no lo sé Supongo que es porque no está viva no lo sé un true no me devuelve nada vale muy bien un false un true vale hay alguna hay algunos casos donde no está devolviendo nada Que bueno Vale tampoco me preocupa demasiado Pero simplemente Supongo que será por la lógica que he puesto tendría que revisar la lógica pero vamos a ver datos Data y datos Data cero y se ve que no Se confirma ninguno de los dos casos que es este de aquí vale Ok no pasa nada bien entonces ahora lo que voy a hacer es el siguiente vídeo es decirle al sistema qué es lo que quiero hacer con esta información Vale pues Ahora lo que voy a hacer es como digo pintar Quiero pintar algo en este caso vamos a pintar me voy a Index 2 y ya no quiero console pun log de Data digamos sino que lo que quiero es decirlo quiero si datos pun datata realmente datos que son los datos realmente datos es igual a true en ese caso lo que quiero es decirle que contexto punto Fil rect claro hay que ver ahora qué le paso porque ahora tiene que devolver la x y la y bien vale pues datos coma x y aquí en el trabajador datos coma x y no sé si me va a dejar enviar tres parámetros Pero bueno true x y creo que no me va a dejar pero vamos a verlo vale vamos a verlo Okay overload resolution Vale overload resolution básicamente lo que nos dice Es que solo le deja pasar datos no tres datos bien No pasa nada Pues en este caso lo que voy a hacer es decirle al sistema que vamos a ver bar datos Vale pues bar Jason es igual a eh datos coma x y ya está le paso al jas y a correr entonces trabajador me devuelve unos datos e datos es igual a Jason punto datos creo que es vamos a verlo Ah espérate no datos dos puntos datos coma x dos puntos x coma y dos puntos y ahora sí vengo por aquí js pun datos vale Y ahora en el post message vale vamos a ver aquí mage post message vale J son de vuelta es igual vamos a ver bar viiva viva es igual a true viva es igual a true viva es igual a false Y entonces en jas de vuelta en J de vuelta digo datos es viva xs j. X e Y es jsy post message J son de vuelta Así que en el Index quiero que me devuelvas on message vale quiero que me devuelvas console.log datos Así que vamos a ver vale Reading Data en trabajador js3 Ok venga claro es Ah no J son datos pues vamos a ver console.log datos undefine vale console j Ahora sí y Data punto datata punto datos vamos a aglo ahora Ok y ahora J son datos no puedo leer el cero vale en el trabajador 8 Ah datos Data eliminamos uno eliminamos uno y yo creo que ya vale Ahí tenemos eso muy bien datos undefine ex undefine y undefined muy bien Vamos a verlo interesante en la línea 54 es cuándo vuelven Vale entonces Según esto los datos no Están volviendo correctamente y eso me extraña pero vamos a ver bueno así Ah sí ya está J son d. x j.d. y me extraña que sea undefine todo el rato undefined undefine undefined y undefine vale vamos a en Index 2 fun datos. datata y así lo vemos mejor true false vale esto ya es otra cosa vale Ahí está cogiendo ya pues unas cuantas células muy bien y ahora sí lo que voy a hacer es decirle que vale si datos. datata punto qu punto datos es igual a false en ese caso va a pasar una cosa y si datos. datata true va a pasar otra no quiero el caso els porque tengo el undefine Vale entonces no quiero que coja un dato que realmente es erróneo así que ahora sí voy a decir contexto punto fillrect en datos punata X datos. dy Y es un porque es el Pixel del medio coma 1 com1 contexto punto F Style es igual a qué si está muerto es White y ahora esto es black si todo esto ha ido bien Esto lo que quiere decir es que si la célula devuelve que está muerta pues en ese caso la va a pintar de blanco si la célula devuelve que es que está viva en ese caso de negro Así que yo vengo por aquí recargo y en principio lo que debe haber ocurrido es que cuatro células al azar se han convertido en negras o en blancas pero claro Vete a saber cuáles ese es el problema así que es imposible prácticamente detectar Entonces ahora lo que voy a hacer es decirle al sistema que una vez que tenga on message pues quiero volver a pasarle esto así que vengo por aquí no le vuelva a pasar por supuesto otra vez el New worker ya tengo un New worker y ahora vengo por aquí copio y pego vamos a verlo okay momento a ver cojo desde aquí hasta aquí ahora sí vale Ahora sí hago así y vamos a verlo Bien can read properties of undefine and post message en 67 vale Por qué vamos a ver trabajador de I post message of undefined bar J son no lo quiero redlar batos no lo quiero redlar de hecho vale bien y ahora tengo que ver qué es lo que ocurre aquí porque vamos a verlo 67 me dice que se resiste a enviar un nuevo trabajador podría usar un dis pero en principio no debería hacer falta vale voy a poner dis pero no confío en el dis en este caso Vale pues parece que sí bien entonces lo que está ocurriendo Es que tengo ahí un juego de la vida pero aparte de que ahora quito los consoles porque lo están haciendo es básicamente hacer perder el tiempo antes eran útiles evidentemente ahora ya no pero lo que estoy haciendo es tener un juego de la vida de cuatro núcleos y además digamos que de forma estocástica lo que va haciendo es ir cogiendo información voy a quitar el console pun log porque ya no lo quiero guardo recargo y ahora vemos que va más rápido y sobre todo además de ir más rápido lo que está ocurriendo es que eh cómo te diría yo es que ah pues está es modo multinúcleo vamos a hacer así vamos a ver cómo pues ahora va a ir más rápido de hecho recordemos que en hardware concurrency no tengo Bueno aparte de que me está haciendo algún no está funcionando del todo correcto veo que está generando creo algún patrón que no Toca para el juego de la vida pero no pasa nada aunque no me dé el resultado correcto de momento con que sea multinúcleo ya me empieza a valer y luego evidentemente lo tocaremos para ver qué es lo que no esté funcionando correctamente de momento lo que voy a hacer es número workers el Hardware concurren lo voy a multiplicar por 10 a ver qué pasa hago así y con esto pues vemos como está funcionando insisto en modo multinúcleo Y si ahora vengo por aquí pues veremos como ahora aprovechará mucho mejor podría aumentarle más Supongo pero aprovechará mucho mejor el rendimiento del sistema ahora aumentaré más el número de núcleos para aunque tengo que ver si hay cuellos de botella evidentemente vamos a ver por Ah Hardware concurren por 10 voy a poner por 100 no quiero reventarlo pero desde luego lo que sí que quiero es ahí por ejemplo parece que lo estoy reventando vale Pero lo que sí que quiero es llegar a un momento en el cual Pues realmente el procesador lo vale número de núcleos vamos a dejarlo un rato calculando y al dejarlo un rato calculando vamos a ver número workers vale insisto en que no me está haciendo los típicos dibujitos del juego de la vida luego debe haber algo que no estoy haciendo correctamente en el algoritmo de cálculo probablemente es dentro del worker Pero bueno de momento con ver que hace un poco un auto juu pues ya me vale vamos a verlo Vale ahora lo que quiero también es optimizar un poquito y al optimizar un poquito lo que quiero es H pues decirle al sistema vamos a ver decirle al sistema que no pierda el tiempo eh enviando información que no es necesaria Entonces yo tengo por aquí que he cogido el datos contexto image Data de tres y TR Y entonces a continuación lo que puedo hacer es decirle bueno primero Mira si en ese punto hay algo y si en ese punto hay algo pues en ese caso envía la información es decir lo que quiero es revisar esto y decirle al sistema Oye si no hay nada no hace falta que envíes la información pero si hay algo en ese caso Envíalo qué es lo que puedo hacer con eso Bueno pues lo que puedo hacer con eso es decirle al sistema voy a poner un While vamos a ver While mientras que se de una condición vamos a ver esa condición que la quiero escribir bien vale Y ahora vamos a ver quiero decirle lo que quiero decirle Es que recursivamente si esto de aquí está blanco lo vuelva a calcular entonces While true entro dentro de un bucle infinito hago eso y entonces digo sí datos. datata no voy a sumar a ver for I es igual 0 I es menor que datos. datata length por cierto que el procesador me empieza a ir lento voy a bajarlo a ver un segundo y aparte oigo el ventilador vale he bajado la carga del sistema vamos a verlo he bajado la carga del sistema tengo algún error ahora evidentemente está clarísimo vale porque est a mitad del While y más vale Y entonces digo suma es igual a cer esto es más = a 4 suma más igual datos punto Data de I Y entonces digo sím así que a ver X es ig a 0 y es = 0 vale si datos No si suma es menor que bueno lo puedo calcular aquí que 255 * menos 255 es decir si hay un píxel negro en todo esto en ese caso vamos a verlo break a ver javascript exit While Loop y me dirá que es break vale v ya está es break si todo esto ha ido bien lo que hace es que empieza a lupar y solo cuando la suma de negro Solo cuando haya un punto negro en la suma en ese caso sale del bucle y empieza a calcular Y si por lo que sea pillado un punto blanco es decir que todo está blanco pues es como ni hagas esto no vale la pena o sea no entres aquí dentro porque no vas a encontrar nada así que guardo recargo vale vamos a ver 64 muy bien y J son Ah no J vale No dice que no puedo encontrar de trabajador de I vale Reading post message vamos a ver no puedo leer las propiedades de undefined datos vale datos es igual a nada Okay vamos a por ello No todavía no pu m vamos a mutear un momento esto para asegurarnos vale en la línea 4 Reading 16 trabajador en la línea 4 Ok Entonces quito el wtr no puedo leer los properties del post message y vamos a ver por vamos a poner variables por aquí token 46 Ah no esto es una Ray evidentemente Vale pues voy a ver cuál es la cuál es el problema datos. datata datos. datata hacer console.log js a ver qué tengo en este momento datos image Data 11940 y datata en principio parece correcto pero no puedo leer las propiedades de undefine muy bien entonces console.log trabajador de I Ah ya tengo el problema vale Ya sé cuál es el problema y es que si aquí he utilizado I aquí no puedo utilizar I entonces J Data de J vale Yo creo que con esto ya está solucionado el problema vale Ahí lo tenemos y ahora en principio el código debe funcionar más rápido todavía en el sentido de que en principio estoy ignorando las células blancas Así que ahora es cuestión de dejarlo funcionando un rato y bueno y de ver si el cálculo es correcto en el sentido de si está haciendo el algoritmo correcto del juego de la vida o no lo está haciendo que Insisto que para mí ahora mismo es lo de menos a nivel purista no es lo de menos porque debe funcionar correctamente pero es lo de menos en el sentido de que lo que me importa de momento es hacer un programa multinúcleo y comprobar Cómo estamos operando sobre un recurso como una imagen y lo estamos haciendo correctamente Así que voy a ir voy a refactorizar un poquito voy a ir aquí a trabajador y voy a decir aquí 8 12 Pero esto es 20 no 16 esto es 24 esto es 28 y esto es 32 1 2 3 4 5 espérate Ah igual aquí tenía el error míralo Ahí estaba el error vale pues Hala venga 24 28 y 32 yo creo que ahí está el error Ok todo lo demás Ok esto es 16 porque es el centro y ya está así que recargo Y si todo va bien Ahora pues hará mejor el cálculo del juego de la vida Esto que ahora mismo estaba un poco raro digamos Pues ahora yo creo que debe funcionar mejor de hecho Incluso si lo hago más pequeño recalculo y ahora pues veremos qu Qué debe ir mejor lo interesante en este caso es que pues estoy pasando la mínima información posible a los workers y también es importante el ver que no estoy dentro de un temporizador sino cada worker se va cargando y se va descargando conforme es necesario es curioso ver como en lugar de calcularse toda a la vez pues se va calculando a trozos pequeños otra cosa que podríamos analizar es que es si es justo que el criterio sea Random de ahí un poco el hecho de que lo estoy haciendo de forma estocástica entonces la forma de hacerlo vale la forma de hacerlo estocástica o mediante una metralleta de metrópolis que se llama es un poco como una especie de metralleta vale la idea es tirarlo aleatoriamente con la esperanza de que al repetir muchos ciclos pues cada a cada Pixel le toque la misma probabilidad Esta es la esperanza luego pues Habría que ver entonces yo creo que lo que está ocurriendo aquí también porque veo que la pantalla se está poniendo muy negra es que me debe faltar algún caso me debe faltar algún caso en el que le diga al sistema que si la partícula no está definida Entonces no me la pinte Aunque ya no debería darse ese caso estoy pensando vamos a poner aquí un console punto log datos datata bien undefined este undefined ese undefined no me cuadra la verdad Pero vale entonces lo que puedo hacer en este caso es lo siguiente si datos pun datata pun datos es igual a false o datos pun datata punto lo que sea o bien le puedo decir o bien le puedo decir que en cualquier otro caso ahora sí contexto fill Style White o sea undefine lo tomamos como célula muerta por ejemplo así que probamos de nuevo y bueno La idea es comprobar si vamos a verlo si el cálculo es correcto yo creo que Supongo que debo haber hecho como una especie de otro juego de la vida Pero bueno vamos a dejarlo calcular un rato y vamos a ver qué es lo que nos devuelve lo importante en este caso lo importante en este caso es que Eh Pues bueno lo estamos haciendo multinúcleo que es lo que realmente queremos y es digamos nuestra principal urgencia de Cara a desarrollar Este programa informático voy a hacerlo un poco más grande para verlo un poquito mejor insisto vamos a dejarlo calculando un rato y a ver cómo se comporta está haciendo un dibujo extraño Entonces ahora mismo no estoy viendo el motivo no sé si es por el While o por qué Así que voy a esconder un momento el While recargamos de hecho con fuerza porque estaba haciendo una especie de caminitos digamos y no sé si es porque me he equivocado en el Wi o porque me he equivocado en el trabajador en el worker entonces estoy viendo a ver qué hace si nos fijamos yo creo que sí que está volviendo a hacer estos caminitos está haciendo como un laberinto que no es lo que se supone que hace el juego de la vida vemos como está construyendo esta especie de laberintos que está muy Guay también visualmente pero no es lo que hace el juego de la vida entonces dentro de que luego por supuesto evidentemente podemos experimentar podemos jugar pero yo de momento lo que quiero es ver de momento lo que quiero es que el sistema pues se comporte como está previsto digamos entonces si Data es igual a true en ese caso Black vale estoy intentando averiguar Estoy buscando a ver dónde está el problema células vivas más es decir está buscando Cuántas células vivas tiene alrededor y si el centro está a 255 en ese caso vamos a ver vale els viva es igual a false Creo que me estoy dejando ese caso vamos a verlo y como digo En definitiva lo que quiero es tener un juego con workers Pero al final lo que quiero es no Modificar el algoritmo es decir que el resultado sea el mismo con workers que sin workers veo que está volviendo a hacer los caminitos así que bueno esto ya es una cuestión de pues localizar dónde está aquí el fallo del algoritmo ahora mismo está funcionando el modo multitarea digamos Lo único es que tengo que averiguar exactamente dónde está el problema con el algoritmo de culo para que me haga el juego de la vida original y no me haga el juego de la vida digamos versión B que es el que me está haciendo bueno pues voy a volver Un paso atrás voy a Index y lo voy a duplicar convirtiéndolo en Index 3 un poco para buscar una mejora en el rendimiento del programa informático Así que vamos a verlo vamos a cargar Index 3 tanto en el navegador como en el editor vamos a ver vale vamos a cargar Index 3 ahí tenemos el juego de la vida vale Y ahora vamos a cargarlo también en el editor bien y con esto vamos a ver si podemos simplificar algunos cálculos para hacer que el porque es que el software que hemos hecho antes no es demasiado no rinde demasiado bien casi que parece que vaya más rápido si nos damos cuenta si comparamos Index 2 y lo comparamos contra Index 1 Pues casi parece que vaya más rápido Index 1 que Index 2 entonces hemos conseguido que sea multinúcleo pero no parece que hayamos conseguido que sea muy eficiente voy a cerrarlo todo Voy a cargarlo de nuevo vale Y entonces ahora lo que voy a hacer es lo siguiente vamos a ver Ah esto de aquí lo que voy a hacer es convertirlo en una matriz unidimensional pero más sencilla Entonces ahora lo que voy a hacer es lo siguiente vamos a ver tengo aquí el datos Canvas Vale tengo aquí vamos a verlo vamos a ver por aquí voy a crear una variable llamada Pixel que es igual a un New array Y entonces ahora lo que voy a hacer es decirle al sistema que para cada uno de estos casos en lugar de decir esto vamos a ver y ok Y esto por aquí vale lo que voy a hacer es decirle al sistema que exel punto Push y voy a decir a ver javascript array Push vamos a ver y Push Ok vale Ya está pues voy a decir uno y si esto es falso en ese caso voy a decir cero entonces antes de hacer nada más antes de hacer nada más lo que voy a hacer es console pun log y voy a decirle al sistema que quiero sacar Pixel recargo eh recargo fuerte porque no se ha enterado de los cambios e a ver y Ah fantástico Index 3 venga Index 3 Ahora sí vale pues lo que tengo como podemos ver Es una matriz de números ahora Lo importante es que lo que voy a hacer a continuación es sumar vale Y voy a hacer lo siguiente vamos a ver Ah esto representa la información vale Y voy a hacer lo siguiente Pixel si Pixel voy a decir Pixel pun leng esto ya no lo multiplico por cuatro esto es O sea ya no es cuatro En definitiva esto ya no es cuatro esto ya no es cu esto ya no es cuatro vale Y ahora a continuación lo que voy a decir es que número vivas es igual vamos a verlo nuas más igual a esto el If me lo quito porque el If consume bastantes recursos y vamos a verlo Bueno de hecho Aquí voy a reemplazar todo esto AC acabo antes 2 3 4 5 6 7 y 8 esto es menos anchura esto es anchura + 1 esto es -1 esto es + 1 esto es más anchura -1 más anchura sin nada y más anchura + un y así lo que estoy haciendo es leer directamente Bueno pues entonces ahora lo que hago vamos a ver es decir datos Canvas ok No quiero un get image Data vale bien Esto me va a dar un error no pasa nada Y entonces ahora hago lo siguiente me vuelvo a El juego de la vida Wikipedia y voy a ver qué es lo que ocurre a ver cuáles son las reglas dónde estás Aquí bien y digo sí Pixel di es igual a cer si el Pixel está muerto entonces voy a decir si píxel está muerto y además píxel no Y además número vivas es igual a 3 en ese caso Pixel de I es igual a 1 y entonces digo si pixxel de I es igual a 1 si está viva y también es cierto que número vivas es igual a o es igual a 2 o número vivas es igual a 3 en ese caso pixxel de I es igual a 1 en caso contrario pixxel d es igual a 0 bien ahora por tanto esto fuera vamos a ver datos Canvas es igual a contexto lo que sea vale Y entonces vengo y digo vamos a ver Ok vale realmente esto no hace falta hacerlo en cada iteración del bucle datos Canvas vale Ahí vamos a empezar a ahorrar tal y como decía anteriormente Y entonces vengo aquí y digo Sí bueno sabes que datos Canvas a ver cómo lo puedo hacer datos Canvas vamos a ver punto Data de y qué Y por 1 y por 4 realmente es igual a menos píxel de I multiplicado por 255 y así me evito los ifs lo mismo y * 4 + 1 y * 4 + 2 y el I * 4 + 3 siempre va a ser 255 porque es el alfa si todo ha ido bien si todo ha ido bien Supongo que algún error tendré eh desbloqueo el temporizador vale de momento parece que está haciendo un extraño bien pero no pasa nada vamos a verlo No pasa nada porque tengo que averiguar de que aquí tengo una serie de a ver un momento ahí tengo una serie de píxeles Okay Vale está cogiendo mal la anchura No pasa nada vale Voy a averiguar a ver qué es lo que ocurre es decir cuál es el motivo por el cual está fallando vamos a ver Pixel pun len Pixel pun Push voy a hacer una cosa voy a decir que anchura es igual a 64 y altura es igual a 64 y así voy a tener un poco controlado el tema vale de momento no hace nada Okay voy a asegurarme que recargo vale y la continuación vamos a ver por qué aparece así pixel.en 4096 que es 64 por 64 o sea cuadra más ual Pixel voy a hacer un console pun log de ner vivas para ver si lo está cogiendo como un número vivas Okay correcto es correcto vale muy bien Vamos allá muy bien si pixxel y vamos a verlo si Pixel d es igual a 0 y número vivas es igual a 3 Pixel de1 menos anchura en principio esto parece que debería estar funcionando correctamente pero sin embargo no lo está haciendo ahí tenemos ahí un problema muy bien Y entonces esto es más esto es anchura por altura vale Vamos a darle ahora bien recargamos con fuerza vale todavía hay alguien que lo está haciendo multiplicado por cuatro parece 4,096 De hecho 001 Ah 00 vale Y uno por cierto que qué es lo que ocurre si aquí pongo 0.5 por su curiosidad bien ese es el problema y es que aparece un píxel cada cuatro aparece un píxel cada cuatro entonces Pixel pun length Ah creo que aquí está el problema este es más esto ya es otra cosa Vale entonces ahora voy a hacer 0.2 voy a hacer en el Random el 0.2 o 0.1 muy bien y ahí como podemos ver pues tenemos ya El juego de la vida voy a poner un tiempo de 10 para que vaya lo más rápido posible ahí lo tenemos y ahora pues voy a poner por ejemplo 128 por 128 vale Y ahí tenemos pues como digo El juego de la vida voy a poner 0.01 vamos a ver qué ocurre bien cuidado no tanto 0.03 0.04 Vale y vemos que ahí pues tenemos el mismo juego de antes evidentemente pero ya Pues un poco intentando que sea lo más rápido posible y sobre todo simplificando la lógica de la matriz metiéndolo todo en una sola matriz vamos a ver ahora vamos a ver ahora vamos a ver ahora si Pixel de I es igual a 0 y número vivas es igual a 3 Pixel de I es igual a 1 No creo que haga falta poner el pixxel igual a 0 pero yo por si acaso lo voy a poner ahí parece que empieza a haber un problema vamos a ver 0.2 vale a ver par 3.5 e Wow Vale qué está ocurriendo pixxel de y es ig c voy a quitar esto es interesante que si pongo esto Ah muy bien muy bien porque vamos a ver claro Esto es lo siguiente si Pixel de y es igual a 0 la lógica es esta no me puedo ahorrar tantos ifs como quería una pena Vale y digo Si número vivas es igual a TR en ese caso Pixel de I es igual a 1 sino Pixel de I es igual a vale 0.2 Okay 0.1 vale Y ahora este els corresponde a esto els sí voy a reformularlo sa Else si número de vivas es igual a dos o número de vivas es igual a tres vale Este es el els entonces Pixel 1 si no Pixel 2 y este els va fuera vamos a verlo vale Y ahora lo que tenemos que hacer pues es un poco lo de copiar la matriz vamos a arrancar de nuevo el Index simplemente para verlo vale por el datos Canvas temp entonces ahí La idea es que vengo por aquí y digo bar Pixel temp es igual a Pixel slce para crear una copia Y entonces digo Pixel temp si pixxel de es Pixel temp vale si hago esto en principio Ahora sí tengo el juego de la vida correcto vale como digo tengo el juego de la vida y en principio ahora debería tener algún tipo de ventaja algún tipo de en el rendimiento puedo ya quitar la anchura y la altura ahora que estoy viendo que funciona correctamente vale puedo decirle que es cero para que vaya al máximo de rendimiento y también sobre todo lo que quiero es al inspeccionar hacer una prueba de rendimiento vamos a verlo para ver en qué me estoy gastando En qué me estoy gastando la el procesamiento así que detengo vamos a cargar el profile ahí parece que se va a morir este juego Pero bueno vale Y me dice que eso que tengo la gran mayoría del tiempo en secuencias de comandos vale Y bueno vemos que ya ha llegado a un punto de estabilidad y bueno Vale pues supongo que el If y el els será bastante responsable pero En todo caso lo que estoy intentando es vamos a recargar de nuevo es antes de pasar a la ejecución pues hacer que esto sea lo más estable posible bueno pues ahora lo que tengo que hacer es plantearlo en modo multinúcleo primero lo que he intentado es optimizar el modo normal digamos y ahora creándolo en una matriz y ahora lo que quiero es pasárselo a un multinúcleo para digamos ganar cuatro veces más rendimiento pero claro tengo que pensar qué es lo que pasó y qué es lo que no paso para que funcione correctamente antes de continuar vamos a arrancar una especie de Side Quest donde Nuestro objetivo en este caso es eh poder medir Cuál es el rendimiento digamos del sistema esto es Index 2 quiero Index 3 bien quiero por tanto eh medir quiero por tanto tener un indicador de los fotogramas por segundo reales a los que estoy trabajando y quiero además que esa librería pues o sea ese desarrollo digamos lo podamos poner en forma de librería tal que más adelante pues lo podamos utilizar en cualquier otro desarrollo y en cualquier otra versión de este ejercicio Entonces vamos a ver porque voy a hacer lo siguiente voy a empezar haciéndolo digamos a Palo Seco y más adelante lo haré como desarrollo incapsula voy a hacer una anchura de pues 128 píxeles una altura de 64 píxeles y esto se va a llamar stats De hecho se va a llamar jv stats entonces eh vengo por aquí vale vamos a ver esto dónde está No sé dónde estará pero voy a decirle que jv stats Qué pasa aquí por esto me lo pone Esto está como Ah sí Ok vale falta aquí un comentario Vale entonces jv stats es Pos absolute es top cer píxeles left C píxeles Vale y ahí lo tenemos Entonces ahora de hecho casi que incluso lo puedo hacer más pequeño y todo quiero 64 píxeles por aquí y 32 píxeles por aquí vale Y ahí dentro Quiero un pequeño gráfico de el rendimiento Entonces ahora lo que voy a hacer es lo siguiente vamos a ver vale cada uno de los bules vamos a primero decir contexto jv stats es igual a document.get Element by ID jv stats y ahora por ejemplo Aquí voy a decir contexto jv stats fill Style es igual Esto no es una función es una propiedad es igual a Black contexto jv stats fillrect es de 0 coma dónde estás coma 64 no 0,0 hasta 64,32 algún problema hay vamos a ver qué problema hay consola error fillrect no es una función pues primera noticia fillrect no es una función pero si es este mismo fillrect vale es interesante e a ver fillrect no es una función Ah sí punto getcontext 2D Ahora sí que es una función vale Y entonces ahora lo que voy a hacer es eh decir lo siguiente vamos a pintar una serie de cosas vale Y esas cosas ahora veremos Bueno vamos a medir cuánto tiempo tenemos entonces jv stats m tiempo inicio esto es igual a cer jv stats tiempo final es igual a 0 Y entonces Esta es la Declaración inicial Y entonces en el bucle digo jv stats tiempo inicio y es igual a javascript get Time microseconds o milliseconds o lo que sea a ver date Now a ver en qué mide no Bueno sí me sirve vale State Now vale Y ahora jv sts tiempo final que es aquí tiempo final y ahora por curiosidad lo que voy a hacer es jv stats no console log jv tiempo final menos jv tiempo inicio vamos a ver qué nos da recargamos vale Y nos da la cantidad de milisegundos que estamos tardando en ejecutar cada bucle que son estos de aquí son los que sean evidentemente van a ser menos milisegundos Cuanto más grande sea la simulación o sea más grande sea estos elementos ahí lo vemos vale Y van a ser más milisegundos Cuanto más extensa sea la simulación y vemos ahora que ahí hay más milisegundos bien vale pues yo ahora lo que quiero es eh averiguar A cuántos fotogramas por segundo voy entonces para ello voy a decir que bar fps es igual vamos a ponerlo minúsculas bar fps es igual a esto de aquí es esto de aquí partido por fps Así que vamos a hacer esto y un momento no al revés al revés es 1000 partido por esto Vale ahora sí Entonces vamos a comprobar como si por ejemplo hago esto más grande pues voy a más fotogramas por segundo vale 500 fotogramas por segundo si hace falta Y si hago esto más pequeño Pues voy a menos fotogramas por segundo ahí lo tenemos bien ahora por tanto lo que quiero es representar esta información no en la consola sino en aquí arriba en los píxeles Por cierto que voy a hacer un ma pun round voy a hacer un ma pun round y así redondeamos el número vale Y entonces ahora lo que quiero es pintar ese número aquí al final Esto va a ser bueno difícil pero curioso vamos a ver a continuación lo que quiero es lo siguiente vamos a ver quiero contexto jv stats fi Style es igual a Green es igual a verde vale a continuación voy a decir contexto jv stats fillrect desde bueno 621 coma 1 coma 30 vamos a verlo así que si ahora va bien pues sale por ahí una Barrita Vale pues Ahora lo que vamos a hacer es copiar Esa Barrita digamos que ahí lo que quiero es 30 menos fps ahora mismo no se va a ver nada no pasa nada vale Okay Ey qué pasa Ah Sí perdón esto es al revés esto es 30 y voy a decir No espera esto es uno esto es 30 Y esto es 0 men fps Ahora sí vale ahora lo que voy a hacer ahora lo que voy a hacer es decirle al sistema que antes de dibujar esto quiero bar datos es igual a contexto jv stats get image Data Esto es lo difícil ya le digo desde uno ah no desde 2 com hasta cuánto pues hasta 30 coma 31 o 30 a ver Esto es 29 creo vale Y entonces ahora digo contexto putut image Data y le digo que quiero contexto jv stats y quiero datos y los quiero poner en un coma un es decir lo estoy tirando una para allá ahora por último contexto stats fillstyle es igual a Black y contexto jvst fillrect y digo 31,1 coma 30 y yo creo que si todo esto ha ido bien e cuidado j. putim datata Vale putage Data vamos a verlo si todo esto ha ido bien debería estar copiando y pegando ahí unos datos unas gráficas vamos a decir 30 y debería estar ahí copiando y pegando vamos a verlo vamos a decir 2,1 yo esperaría Ah espérate aquí vale vamos a ver yo esperaría que esto lo fuera pegando stats put image Data en 0,1 vamos a ver vale porque como digo lo que yo esperaría esto lo voy a machacar un poco es que eso se fuera tirando para atrás vamos a verlo vamos a ver como digo lo que yo esperaría lo que yo esperaría vamos a ver con j stats Data vale estoy cogiendo los datos voy a poner esto después lo que yo esperaría Es que esto se fuera tirando para atrás console pun log datos Y ya está son height 30 with 40 correcto todo esto es correcto y al final hacia el final debería tener hacia el final debería tener un color verde no tiene un color verde sin embargo es curioso no tiene un color verde todo es negro vamos a ver otra forma que tengo de hacerlo por un poco Buscar formas alternativas para no quedarme parado ahora es lo siguiente a ver vale yo digo jv stats historia es igual a New array Vale entonces ahora le digo for par I es igual a 0 Y es menor que 64 y más Ah momentín Fil rect Ah espérate claro es que estos No son 40 son 64 como mínimo creo que ahí está el error Ah expecto token sí esto fuera de momento Ahora sí que estoy cogiendo lo correcto vale que lo estaba cogiendo incorrectamente muy bien Entonces ahora sí lo pongo en uno Ahora sí tengo una gráfica muy bien Se me está yendo evidentemente el color negro por supuesto entonces vale lo quiero de dos a uno okay correcto Pues ahora voy a pintar Bueno la verdad es que puedo decir jv stats background Black y casi que acabo antes realmente vale Así que tengo ahí ya una barra de Pues fps vale si ahora hago esto más grande recargo y veré que los fps pues caen más todavía vale así que digamos que por bajo de 30 pues muestra esa gráfica digamos vale Y ahora pues bueno puedo hacer algo como que pues si está por debajo de 10 va sale de un color si está por debajo de no sé cuántos sale de otro color vale Así que pues puedo hacer algo Como por ejemplo puedo hacer algo como que por ejemplo vamos a verlo eh switch no If fps Es mayor que 30 en ese caso fi Style Green If fps voy a poner mayor o igual que 30 es menor que 30 en ese caso Yellow y si fps es menor que 10 No lo sé a ver voy a poner 15 en ese caso red Así que recargamos y ahí pues vamos viendo unos colores que nos informan un poquito mejor de En qué situación estamos ahora por ejemplo pues hago así lo hago más pequeño vuelvo a recargar vale Y ahí pues lo veo mejor no sé yo Pues no lo sé si aquí le digo 20 y aquí le digo 10 y así pues un poco ajustamos Cuál es el resultado bien y ahora pues sí que me gustaría contar con un pequeño elemento de texto así que ml5 Canvas text texto sencillo y vamos a ver vale contexto font esto lo puedo poner aquí es 10 píxeles o no sé se píxeles Arial y Fil fillrect etim Data timage Data contexto jv stats y en 1 coma 25 voy a poner fps más fps vamos a verlo Ah sí claro bien Ah y color White jv stats F Style White Vale y vamos a verlo claro cómo lo puedo hacer cómo lo puedo hacer para que se vea bien Ah no sé si le podría decir no no Vaya pues lo del texto me puede fastidiar un poquito porque dependo del dibujo anterior bueno eso tengo que ver cómo hacerlo eso tengo que ver cómo hacerlo quizás en un texto voy a poner aquí Ah vale No lo sé ahora mismo No lo sé ahora mismo pero tengo que pensar cómo lo puedo hacer para ver dónde lo imprimo y que no se vaya hacia la derecha evidentemente no lo puedo poner verde porque Vete a saber en qué momento será verde o no igual un Canvas por encima pues tendría igual que recurrir a eso es decir jv stats 2 eh dónde estás contesto jv stats 2 y entonces jv stats 2 clearrect desde 0,0 hasta 64,32 y luego todo esto div ID contiene jv stats vale Y contiene jv stats es esto de aquí con un with de 64 con un H de 32 y esto de aquí es jv St y jv stats 2 lo probamos no sale nada fantástico vamos a verlo Ah s background Black ahí no puedo entonces jv St es esto jv stat 2 es esto y al dos no le puedo poner background Black vamos a verlo ahora vale Y ahora sí Entonces ahora este número lo voy a hacer un poquito más grande aparte de que voy a hacer esto Bueno realmente está aplicado al Canvas Vale pues voy a hacerlo seis píxeles por 10 píxeles Arial vale una cosa así y eh si me ha ido el color vamos a ver por qué y voy bien pues vamos a ver qué es lo que ocurre porque tenemos ya ahí el texto pero se nos ha ido vamos a ver contiene stats eh J stats 2 lo eliminamos y Ah qué interesante A ver J 2 lo eliminamos Por qué y J Stars 1 lo eliminamos Vale qué está pasando aquí eh Clear re en jv Stars 2 fill Style fill text no entiendo por qué a ver 10 pixels este console fuera y vamos a ver jv stats no sé por qué ya no estamos pintando vamos a ver JW stat F re 0 men fps Pues no sé por qué además es que estoy borrando este y no se borra Okay ya s Por qué Y esto es porque es J sts 2 ahora sí vale Okay así que ya lo tenemos por ahí ya tenemos tanto nuestros fpss como la Gráfica vamos a poner el texto en tres por ejemplo y ahí lo tenemos y ahora ya pues podemos hacer esto más pequeño esto más grande recargamos bien y ahí es donde podemos verlo mejor vale Muy bien pues hasta aquí tenemos Pues el juego digamos refactorizar en una matriz y ahora lo que queremos es pues ver lo que queremos es trabajar correctamente con Pues bueno con todo aquello que haga falta para convertirlo en multinúcleo ahora tenemos que ver cuál de las estrategias podemos adoptar para pues ver En definitiva qué es lo que hacemos con la información es decir necesitamos esto pero claro qué le pasamos ahora a cada worker Pues es lo que tenemos que pensar es lo que tenemos que decidir Más que nada porque como diría yo no podemos pasarle a un worker la información de todo el bucle porque entonces estaremos perdiendo un montón de información hemos visto como le hemos pasado cada puntito a un worked y tampoco ha mejorado mucho la situación Entonces tenemos un poco que ver qué es lo óptimo que le podemos pasar al programa para que En definitiva pues trabaje de forma correcta voy a poder los fps aprovechando para dividir esto por dos y así pues la Gráfica saldrá más conveniente y así de alguna forma si pongo esto al 200 por pues ahí por ejemplo a 60 fotogramas por segundo voy a partirlo por cco y ahí por ejemplo vamos a ponerlo al 200 por y recargarlo a pantalla completa y así veremos Pues a ver cuánto funciona ahí lo vemos vamos a también echarle un vistazo A cuánto costaría en pantalla completa vemos Que en pantalla completa es cuando pues tenemos el problema que ya conocemos de que pues Estamos bajando hasta 20 y pico fotogramas por segundo y no es nada conveniente puedo aumentarlo al 400 evidentemente y entonces pues paso a más fotogramas por segundo Pero no es lo que quiero Claro en un momento dado puedo esconder también lo las estadísticas vale puedo hacerlas más pequeñas o puedo hacer lo que quiera pero siempre teniendo en cuenta pues la velocidad digamos ahora a continuación como es cuando vamos a hacer esto que sea multinúcleo