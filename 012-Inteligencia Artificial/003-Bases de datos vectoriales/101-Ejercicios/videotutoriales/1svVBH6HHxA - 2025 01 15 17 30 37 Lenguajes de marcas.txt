qué me decís cuál diríais que es la lógica sí verás te cuento La pregunta es la siguiente es una pregunta no sí Agustín más entradas Sí vale está claro por supuesto que va a tener más entradas pero el Access log va desde las 12 de la noche de hoy 15 de enero las 12 de esta noche pasada hasta las de hoy hace una hora porque el servidor va con una hora de retraso el Access log1 va des de ayer a las 12 de la noche hasta ayer a las 2359 con lo cual el Access pun 2 qué tendrá qué diréis que tendrá cada log está en un día Exacto vale con lo cual vale desde el 13 correcto vale con lo cual este es hoy ayer anteayer el otro el otro y suman siete luego qué está haciendo Apache lo que está haciendo Apache es guardar un registro de ayer y de hoy descomprimido un registro de los últimos 5 días comprimido y los que tengan más de 7 días los borra obviamente tal y como has comentado Además para que ocupen menos los comprime vale correcto esto quiere decir que en la clase de ayer en la clase de ayer eh vamos a ver por aquí hicimos un software empezamos a hacer un software local Host no Cómo se llamaba el software eh medium sig Green no era sig Green Sí vale hicimos el software sig Green que lo que hacía era conectarse a cada uno de los estos cada uno de los caray me sale cada uno de los virtual hosts y lo que hacía era sacarme la información de la distribución de visitas países y lo que fuera no sé si lo veis no sé si lo veis pero de repente china ocupa mucho menos y de repente Ucrania y no me acuerdo cuál otro era el que bloquee ya no están por qué Pues porque ayer Los blo que amos Ah no lo hice con segundo Perdón no con vosotros hice eh hice las analíticas y con segundo hice el software de seguridad para elegir cuándo bloqueo unas ips u otras vale estas estadísticas están muy guays pero técnicamente eh Son un poco incompletas vale en el sentido de que únicamente me da las estadísticas del día anterior cosa que como os digo está bien pero cuando yo hago estadísticas no solo quiero las estadísticas del día actual o Del día anterior Yo quiero las estadísticas momentín Yo quiero las estadísticas de esta semana de este mes de todo el año del año pasado por tanto el Software que empezamos a hacer ayer está Guay por supuesto pero es un software un poco inmediato te permite ver Únicamente lo que está ocurriendo en este momento a continua voy a esta filosofía y voy a extenderla creando una base de datos de registros con esto lo que voy a hacer va a ser intentar Conseguir dos objetivos el primer objetivo que voy a intentar conseguir va a ser guardarme periódicamente los registros para que pueda tener un análisis mucho más detallado de todo lo que está ocurriendo para que no solo pueda seleccionar una semana un mes sino que pueda un año si hace falta o el año pasado y a continuación lo que voy a hacer también es aprovecharme de las ventajas que me da mysql porque yo aquí lo que tengo es un archivo de texto y claro Buscar en un archivo de texto es un poco farragoso pero si os acordáis en bases de datos teníamos peticiones de agrupación de conteo de reordenación y eran geniales y además si me voy a los resultados de aprendizaje de bases de datos hay una serie de resultados de aprendizaje que Estuvimos viendo la semana pasada y es que hay una cosa que os tengo que enseñar aquí vale procedimientos almacenados la semana pasada cuando estuvimos hablando de esto lo puse en rojo porque os dije no os digo nada de esto porque no os he enseñado todavía procedimientos almacenados pero ahora os los voy a enseñar bien así que es bueno saber esta información porque Apache Me da la información o sea no es que voy a despreciar Apache es genial y los logs son geniales voy a complementar lo que me da Apache de esta forma Vamos allá voy a empezar a hacer un software vamos a ver voy a empezar a hacer un software primero bueno ya sabéis como siempre porfa please seleccionado un color así que vosotros diréis yo Mientras voy a ver seleccionado un color no de los que tengo en pantalla vale sino abrir la página y decirme el color que queráis fistel Ah espera Royal Blue a ver fistel qué es No ni sé que es ese color a ver cistel ese color Mola y Royal Blue Es que no sé si además lo tenía ya utilizado porque Royal Blue me suena porque estaba Royal Blue estaba Navy Blue a mí me suena opq r Royal Blue no pero me suena que lo tenía reservado para algo Mira voy cistel que ni siquiera sabía que existía Así que cistel esto es aplicación analytics con mysql vale me voy a github.com me hago un nuevo repositorio y lo llamo jarsa cistel Vale o sea es que ya te digo ni siquiera sabía que existía ese color okay creo ahora en github me voy a clonar fistel un momento que actualizo repositorios okay Ahí lo tenemos bien Ahora a continuación yo lo que quiero fijaos como hablábamos al principio de la tarde de hoy modelo de datos Cuál es el modelo de datos de un archivo de log de Apache Pues el modelo de datos es campo número uno vamos a verlo Uy espera no ves estos es intentos de pirateo qué cabrones que son A ver es que todos son intentos de pirateo es que no me puedo creer es que es una barbaridad Es que esto es la leche voy a Dark Slate blue o a crimson que no te creas tú también vale Pero bueno Okay aquí vale va aquí no Pero espera momentín Sí pero por qué Aquí hay un guion este guion qué guarda ese gu guarda algo y ahora mismo no sé qué es no lo veo a ver un momentín esto es la ip vale esto es la fecha está en gmt + 0 Y nosotros creo que ahora mismo estamos en gmt + 1 pero bueno bien Esto no sé qué es Ah esto es el user agent vale esto es la petición que es 403 404 por aquí esto es el proceso y esto no sé qué es vacío y vacío Ah vale esto es el recurso que se está pidiendo okay Y esto es el user agent Ah y esto está vacío y esto está vacío Y esta es la web que se ha pedido vale a continuación lo que voy a hacer es lo siguiente me voy a crear en php My admin me voy a ir a local Host php my admin me voy a ir a Root y en base al modelo de datos de Apache Me voy a crear una nueva base de datos llamada cistel de momento en local la voy a llamar le voy a poner privilegios con un usuario llamado contraseña fistel de momento continuar Ok vale Y ahora en la base de datos llamada cistel voy a crear una nueva tabla llamada logs así que logs o registros si queréis ya que estamos bien Cuántas columnas tiene cistel tiene logs tiene registros tiene la IP tiene insisto esta columna que no sé qué es y tengo que averiguarlo A ver crimson vamos a old l es que no sé qué es pero bueno Pues no lo sé igual es ipv6 momentín Voy a preguntarle a chat gpt eh que igual chat gpt lo sabe lo digo porque como Definir la estructura de una base de datos May sql no es moco de pavo pues vamos a hacerlo bien desde principio esto Luis es lo que os decía antes de la prematura vale with this apach log What is supposed to be between IP and date in between this gu vamos a ver que me lo diga si me lo di dice tu Place holder Ah identity of the client Ah okay No information is available and user authentication Ah qué Guay vale Okay perfecto Muy bien pues vamos allá Entonces eso quiere decir que ahora me voy a crear una 5 6 7 8 y nu voy a decirle una cosa vamos a apoyarnos en chat gpt Okay perfecto sql to create a Table to accomodate all that Data me debe crear vamos a ver apach logs vale me crea de hecho un ID un identificador fantástico y luego IP identidad usuario Time stamp método endpoint protocolo estatus bytes enviados referrer y user agent fantástico Vale pues vamos a por ello selecciono Esto me voy a base de datos cistel me voy a sql ejecuto continúo y tengo una tabla llamada apach logs donde a partir de aquí voy a empezar a meter cada uno de los elementos vale una vez que tengo esto a partir de aquí yo lo que puedo hacer es empezar a registrar valores cómo pues Quiero crear un python Script vamos a ver okay Now create a python Script that Open an apach log and inserts All of its Data rows into a Table created in mysql with Those fields Vale ahora Quiero un Script de python que ejecutar una vez al día y cuando ejecute ese Script de python una vez al día me meterá todos los registros en la base de datos mysql Y ahora a continuación veremos Qué ventajas tendremos al conseguir eso Qué ventajas y qué retos Vale ahora veremos también y vamos a ver Hay un problema también os digo Y es que claro Haciendo esto realmente voy a mezclar los registros de todos los virtual hosts en todos partes vale bien No pasa nada ahora arreglamos eso Ok Ok vale Ok bien Vamos a por ello vamos a hacer una primera implementación Y a ver qué pasa vale No aparece el copiar No pasa nada me vengo por aquí ahora vale me voy a idle me voy a crear un nuevo archivo voy a configurar para que el tamaño de letra sea más grande vale lo guardo html fistel jarsa fistel vale lo guardo como fistel bien y digo Host local Host user fword F sabis cistel ahora Luego cambiamos esto crearemos un archivo de configuración o algo así vale vamos a ver Ah no se ve idel Ok espera vuelvo a compartir Ayer ya pasó que de vez en cuando se quedaba frito vale confirmados a reiniciar que ayer ya pasó Espera que ahora se me ha ido a mí el chat Ok Vale pues vamos a ver el archivo con el que voy aquí es vamos a verlo es un archivo que en mi caso ayer dejé aquí ubuntu bar elog apach 2 y ayer me dejé este archivo vale Ok ese por ejemplo entonces bar log apach 2 barra de momento barra esto Ah sí espera no lo puedo renombrar jarsa old l access.log Vale pues vamos a probar le doy a ejecutar Okay ha funcionado la primera esto no me pasa siempre con lo cual ahora me voy a local Host me voy a pat logs y tengo la información que estaba hace un momento en el archivo txt la tengo guardada en mysql eso quiere decir que si ejecuto el Script cada día y por tanto si cada día guardo en mysql los datos Del día anterior no perderé los datos Y a lo largo del tiempo podré hacer una estadística mucho más amplia no solo la estadística del día actual o Del día anterior pero os digo más pero os digo más por cierto en el Time stamp podría separarlo Pero bueno da igual vale No pasa nada porque luego con mysql se pueden tratar las fechas Vale entonces vengo por aquí y digo vale Ahora quiero averiguar Cuántas ips diferentes me han visitado para averiguar Cuántas ips diferentes me han visitado para eso mysql es un placer porque vengo aquí a sql y digo Select all no Select IP address coma count IP address from apach loock Group by IP address Pero además quiero eh ti Quiero quiero order by count IP address descendiente Y si yo hago así y si yo hago así con continúo y tengo el listado de las ips Y es más Ahora solo quiero ver las 10 que más me han visitado limit 10 continúo y tengo las 10 que más me han visitado con lo cual luego incluso que sepáis que dentro de php My admin un tesorito secreto oculto dentro de php My admin es que tiene gráficos vale tiene gráficos y puedo seleccionar un gráfico de barra vale esto ya os digo que es un tesoro oculto dentro de php My admin Cuando digo oculto quiero decir que realmente está a la vista de todo el mundo pero mucha gente no se da cuenta de que tienes gráficas dentro de php My admin que vienen muy bien de vez en cuando vale esto quiere decir por lo tanto que yo a partir de este momento pues puedo en primer lugar irme almacenando en My sql los logs y además luego pedirle cosas a los logs va a ser mucho más fácil que pedirle cosas a diferentes archivos de txt de python pero la cosa no acaba aquí porque yo a continuación lo que quiero es decirle al sistema que e quiero también guardarme el Virtual Host porque yo ahora mismo no sé si esto es de crimson si esto es de all days si esto es de dark Slate blue o esto de quién es porque está todo al batiburrillo vale No pasa nada lo que voy a hacer en este caso es que voy a vaciar un momento la tabla ap pelog la he vaciado la volveré a llenar voy a modificar la estructura Así que voy a alterar y después de ID voy a Añadir un campo que se va a llamar virtual Host es un marchar de 255 Vale tengo ahí virtual Host y ahora a continuación voy a Modificar el Script lo voy a modificar de momento un poco manualmente Vale y IP Sí vale Y aquí en balius vamos a ver en vales voy a poner Eh Esto que qué era no me acuerdo era all Sí vale era old l okay Y esto es insert into Apache virtual Host IP address y values String vale preparo el la petición con lo cual o Pongo aquí jok carsa old days vale Okay Ok todo okay Vale pues ahora ejecuto f5 y si no da error me voy a mysql me voy a apach y veo que he metido un nuevo campo que es jarsa L y si es jocars alll quiere decir que eh Ya puedo empezar a plantearme guardar no solo un archivo de registro de Apache sino los archivos correspondientes a todos y cada uno de los virtual hosts vamos a hacer esto vamos a ejecutar esa acción para ello acordaos primero estoy en local Vale ahora lo implantar sobre el servidor por tanto voy a traerme un poco lo que tiene el servidor me lo voy a traer a mi ordenador y vamos a hacer lo siguiente en primer lugar voy a hacer un primer comit vale primera versión añadimos una tabla commit to Main Push y así voy haciendo commits en github y luego tenéis los commits bien a continuación voy a beber bien a continuación me voy a ir al servidor me voy a ir al servidor me voy a ir a bar me voy a ir a no a log Perdón me voy a los Access los que acaban en punto uno y vosotros me diréis Por qué los que acaban en punto un y yo os diré porque son los de ayer o sea no me interesa meter lo de hoy está en proceso quiero meterlo de ayer Así que punto Uno Vale y cojo el punto un vale momentín Okay copio y ahora intento pegarlo aquí no se ha podido pegar vale Por qué bueno no pasa nada escritorio logs Apache Vale entonces ahora me hago una terminal y digo sudo CP todo a bar logs ap2 esto en Windows no os va a pasar Cómo que no existe Ah Sí perdón aquí Oh Ah sí a aquí Bueno no a ver venga va Ay ubuntu server CP all files in folder to another folder venga Sí ya eso es lo que quiero hacer pero parece que no a ver sí bar log Apache 2 esto no bar Ah logs perdón bar log apach 2 okay Ahora sí bien Vamos a verlo barlog apach 2 ahí están Okay Vale están como no se puede escribir no pasa nada no hay ningún problema y entonces ahora yo quiero hacer un archivo de python que espera por aquí python Script find all files in folder containing access.log in file name Vale entonces importo os vale importo os vamos a ver aquí cojo esto Me conecto a la base de datos y digo for Root de files en bar log apach 2 for filing files If punto no me acuerdo If pun Access log infile print archivo encontrado a más file esto de momento lo bloqueo ejecuto archivo encontrado Access log other virtual Host Access light salmon jarsa tomato Dark turquis jocars Blue Access lo que sea vale Ah sí me ha cogido dos vale Ok claro No quiero que estos dos no los quiero vaya vale and get only files ending with Access log 1 Vamos a ver ends with pues ya está fantástico y If file ends with pattern If file ends with pattern ejecutamos ahora mucho mejor una vez que tenemos esto Una vez que tenemos esto el nombre del archivo es file punto eh split mediante el guion y me quedo con el número cero y me dice vamos a verlo y me dice light salmon a ver un momento Ah sí claro light salmon jarsa tomato Dark turquoise Dark sl Blue medium Green scen crimson vale puedo el archivo y puedo el nombre del proyecto el Virtual Host lo cual quiere decir lo cual quiere decir que ahora a continuación digo lo siguiente carpeta es igual a esto de aquí Epa vale virtual Host es igual a esto de aquí ahora a continuación Me cojo todo esto me lo descom vale el Main vamos a ver Esto es una función esto es otra función todo lo que son funciones me lo dejo aquí arriba y ahora no quiero Main Esto me lo llevo y Esto me lo llevo y esto quiere decir que vamos a ver Esto es carpeta más file esto quiere decir que Hola Aquí virtual Host vale virtual Host es hok carsa old lce con lo cual yo le digo Line coma virtual Host okay Y esto es virtual Host se lo paso como parámetro y llamo a momento aquí insert log to db Ah espérate no es aquí vale insert log to db cursor log Data virtual Host cursor log Data virtual Host si esto que he hecho funciona lo que va a hacer es entrar en cada uno de los archivos para cada uno de los archivos quedarse con el nombre del virtual Host y meterlo en la base de datos vamos a ver si funciona vamos a ver si funciona momento espera me aseguro de que la base de datos esté vacía No está vacía voy a vaciarla vale Y ahora a continuación voy a ejecutar no SW file ok No pasa nada porque aquí un momento Okay Ok Okay aquí carpeta más barra más file vale f5 Ok permiso denegado vale No pasa nada hay permiso denegado no hay ningún problema Ok tengo Access log alguno sí que me ha dejado otros no vale Access log no pasa nada si tengo un problema de permisos vale si tengo un problema de permisos voy a vaciar la carpeta voy a vaciar la tabla voy a decir que a ver fb bar log Apache 2 vale voy a decir que sudó no lsl all es el que me da error los demás solo puedo leer vale vamos a ver y esto Solo puedo leer Vale pues sudo ch mod 777 a todo vale con lo cual vuelvo a ejecutar Ok vale bien Data to long ahí hay un problema no pasa nada lo podemos arreglar me voy a patels ya lo tengo todo metido ahora una cosa daos cuenta que solo por hacer esto y acabo de meter 7594 registros vale un solo día son 7594 registros haceros la idea de que la base de datos luego crecerá bastante me voy a cistel y veo que bueno la columna dice que ocupa 16 cas No es cierto a ver cojo le voy a decir optimizar Ok fistel 16 cas ya os digo que no son 16 cas Pero bueno ahora en un momento actualizará y veréis que eso igual se convierte en 700k o algo así una cosa así claro ahora por ejemplo en apach logs le digo vale hay 7000 Pero quiero saber cuántos registros pertenecen a cada virtual Host pues yo voy a sql y digo Select virtual Host coma count virtual Host from apach Group by virtual Host le doy a continuar y tengo los registros que hay en cada uno de los proyectos esto por ejemplo ayer no lo podía hacer porque ayer estaba trabajando cada archivo por separado pero hoy tengo toda la información en mysql con lo cual primero lo tengo todo agrupado y segundo como estoy trabajando en un sistema sql en bases de datos hacer peticiones primero que lo voy a hacer mucho más sencillo y segundo el resultado va a ser mucho más rápido vale por tanto vamos a ver en qué nos pueden ayudar las bases de datos con lo que sabemos y con lo que tenemos que aprender para el proyecto que estamos haciendo vale vamos a hacer un momento