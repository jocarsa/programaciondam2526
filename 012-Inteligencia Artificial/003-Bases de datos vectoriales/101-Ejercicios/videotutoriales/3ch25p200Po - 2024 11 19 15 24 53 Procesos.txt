Vale pues estaba intentando hacer un ataque pero no me dejaba voy a poner Drop login y dropo ostras eh Hola Ah espérate algo pasa vale Hola qué tal le doy a login Vale y Hola qué tal Drop le diy a login momento Hola qué tal Drop le doy a login pero ya he enviado un Drop vale que es un poco el mensaje entonces la idea como os digo es esto y convertirlo como siempre estamos intentando hacer convertirlo en una librería que nos permita atrapar esas inyecciones y prevenirlas claro qué ocurre pues Que obviamente en el momento en el que estamos hablando de seguridad estamos hablando del servidor porque cualquier cosa que hagamos en javascript cualquier persona que se ponga a analizar el código javascript la va a pillar vale por tanto intentar meter librerías de estas en el cliente pues es una tontería tenemos que meterlas allá donde no pueden verlos vale Eso quiere decir que yo ahora a continuación me vengo aquí a dam me voy a segundo me voy a sistemas de gestión empresarial me voy a proyecto y en proyecto voy a crear una nueva versión del proyecto 101 librería de inyección o librería de saneamiento Así que vengo a librería de saneamiento voy a ir a hedit me voy a copiar esta función me voy a dam a segundo a gestión empresarial a proyecto me voy a saneamiento me voy a servidor y voy a crear una carpeta nueva llamada Liv ya tenía una carpeta Liv en el cliente ahora una carpeta en el servidor y voy a crear un archivo nuevo llamado sanear php o el nombre el que queráis realmente Así que vengo por aquí y pego la función de saneamiento a continuación lo que voy a hacer es que en el Index php Y en este caso me va a venir muy bien porque el Index php me hace de concentrador Y eso quiere decir que todas las peticiones desde el cliente vienen a este archivo Index php lo cual quiere decir que todo pasa por aquí Pues yo aquí a continuación le voy a decir mira antes de nada include vamos a ver include Li bar sanear php y antes de hacer nada más voy a decir sané request y si no pasas la prueba y si sanear hace un die no continúes no te conectes a mysql no te conectes a no hagas ninguna instancia De nada vale o sea si aquí sanear te dice Die previene que se ejecute nada de php y de hecho mysql ni vale ni se llega a abrir una conexión con mysql vamos a probarlo Así que vengo por aquí claro aquí en sanear otra cosa que voy a hacer es que tengo una colección pero qué pasa si alguien me pone Drop en minúsculas y la palabra que está esperando es mayúsculas Bueno pues ahora vamos a mejorar vale esta librería vamos a probarlo A ver vamos a ver me voy a 101 a cliente Vale y digo eh Drop usuario qué tal Hola le doy a login vale Y me dice usuario incorrecto pero me ha hecho el Drop vale o sea no me ha hecho el Drop quiero decir que lo ha tirado al servidor lo ha tirado al servidor y ha comprobado si hay un usuario que se llama Drop mal vale porque he metido la palabrita Drop en mysql claro si ahora digo Drop usuario qué tal Hola le doy usaurio os da igual vale le doy a login dice error al entrar a ver no usuario incorrecto espérate aquí no debe haber hecho nada voy a probarlo a ver me voy al servidor vale Ok y digo eh prueba es igual a Drop Hola no vale Voy a decirle ahora Drop espera pero Drop con mayúsculas Drop Hola Eh vale algo pasa porque aquí si lo he metido dónde Toca que debería ser que sí función sanear y en Index php sanear de request vale voy a decir eco Hola para asegurarme de que estoy en el sitio correcto Hola correcto vale bien pues ahora lo que voy a hacer Es que aquí en sanear voy a decir delete Drop y truncate ahora haré algo más seguro vale Ok recargo Ah no permitido Ahora sí vale Y ahora a continuación Bueno me dice no permitido podría dar algún tipo de error podría devolver algún tipo de error Por supuesto un código de error que no sea especialmente verboso vale voy a probar aquí cliente y le digo Drop usuario Hola le doy aquí a login vale me dice usuario vacío me dice usuario vacío y ya digo que me da una Ray vacío pero directamente no debería devolver nada voy a probar a decirle que da y a decirle que resultado es error dos el error dos me lo acabo de inventar ahora mismo Die y Die vale vamos a verlo cliente Drop Hola qué tal login error al entrar H no sé si está llamando el sitio correcto vamos a ver servidor En clave es igual a Drop Hola qué tal vale resultado error ese sí que me está devolviendo un error Por tanto tengo que ver qué es lo que está ocurriendo porque en principio parece como que no esté ejecutando nada desde el cliente tendríamos que revisar el cliente evidentemente vamos a verlo en login js en el login operación Buscar vale tabla usuarios response js console log Data vale tabla usuarios method post console log Data y me parece raro porque en principio sí que lo está sí que lo está transmitiendo vamos a verlo vale login hace esto servidor tabla usuarios pero en Index de B antes de nada voy a comprobar si se está ejecutando vamos a hacer un poco de debug eco vamos a debug aquí pongo algo aquí vale vamos a debu Ok correcto error número dos vale correcto ahora sí que realmente no pero vamos a ver vale ahora bar dump elemento tiki tiki envío vale Y el login lo voy a poner un segundin como text para comprobar que es lo que viene desde el servidor usuario contraseña y eh Stream Buscar vale usuarios pero un momento esto es que me ha hecho un aquí Windows location y Windows location un segundin voy a matar eso escritorio Index va a ser que no vale es buscar y usuarios vale esto es el array el problema Está Ah ya Dónde está el problema vale porque esto Me está llevando a escritorio no sé por qué me está llevando escritorio porque debería llevarme aparte dice acceso correcto Ah claro porque es text vale Sí Okay ya veo lo que pasa ya veo lo que pasa aquí en el Index aquí okay muy bien J son de code vale pues aquí le digo quiero esto de aquí y quiero sanear los datos Okay Vale vamos a probar ahora desbloqueo todo lo que tenía esto es jas OK hago así me dice Ah unexpected token algo sigo haciendo mal unexpected token a sí creo que me he dejado todavía por aquí un bardom Ok vale recargo y error al entrar Vale dentro de 5 segundos vuelve a donde estaba ahora a continuación Ok 5 segundos no porque me lo he dejado desactivado me lo he dejado desactivado Vale ahora a continuación Vale ahora 5 segundos vuelve a recargar OK ahora pongo Drop tabla que me invento y Hola vale si yo le doy a login resultado error 2s Vale ahora sí en el momento en el que pongo Drop delete ahora a ver qué tal Hola le doy a login resultado error 2s resultado error dos y Luego recordad que podríamos volcar el error dos aquí en el toast que hicimos el otro día y podríamos tener un listado de errores donde error 2s equivale a intento de ataque por ejemplo vale Así que así login una cosa es no existe el usuario pero otra cosa es te he detectado un intento de inyección Vale ahora a partir de aquí pues lo que podemos es mejorar la librería de saneamiento siempre se puede mejorar las vale las operaciones de prevención 102 mejorar saneamiento vale porque entonces mejorar saneamiento servidor librería sanear Vale y eh lo que voy a hacer para cada una de las entradas de clave y valor como Esto está en minúsculas claro tendría que el problema no es ponerlo en minúsculas o mayúsculas vale el problema es que si alguien me pone por ejemplo the lit my sql se sigue comiendo eso con lo cual las variaciones de mayúsculas minúsculas serían infinitas Vale pues no hace falta porque puedo hacer lo siguiente vale Y es que entrada es igual a lower clave que básicamente consiste en decir que Esto me lo pasas a minúsculas está lower y está apper que son dos funciones predeterminadas dentro de esto dentro de php vale Lo cual quiere decir que yo ahora a continuación me vengo al 102 Vale y da igual que yo lo haya puesto minúsculas o mayúsculas delete Esto es una prueba y Hola qué tal porque en cuanto le doy a login interna al server error Ah un momentín momentín mín momentín php to lower Case a ver si es que lower era en python momentín porque tengo un bacalado de espera esto no lo quiero str to lower vale perdón Ya decía yo pues debe ser en python en lower est to lower str to lower vale vamos a volver a hacerlo aquí vale login y me dice resultado error 2s da igual que lo haya escrito con mayúsculas y da igual que en php lo haya escrito con minúsculas porque como al final lo va a convertir todo en minúsculas pues da igual vale de esta forma como os digo a continuación Pues yo podría guardar una lista y cuando os digo una lista podría ser una Ray php donde aquí a continuación Pues podría meter más vale por ejemplo Table pues no quiero que nadie me ponga Table en ninguna parte problema durante el uso normal ilícito de una aplicación pues alguien por el motivo que sea puede necesitar poner Table vale si sobre todo si alguien está escribiendo en inglés Hay que tener cuidado porque este tipo de operaciones Pues siempre pueden dar lo que se llamaría falsos positivos vale sin embargo yo siempre he pensado Que más vale poner la aplicación muy restricti muy restrictiva Y si te da un falso positivo pues ya la persona que la está usando te consulta y tú como administrador siempre está a tiempo de levantar un poquito la mano que no al revés vale que no hacer una aplicación muy laxa y que la gente se te cuele por bajo sin darte cuenta Y que por tanto En definitiva pues te estén intentando atacar la aplicación vale esto como vemos pues es una forma un método de eh de intentar lo que se llama sanear que básicamente consiste en el concepto de atrapar todo lo que venga compararlo contra una serie de cosas vale comprobar si cada cosa que viene coincide o no coincide con ese listado de cosas y si coincide en ese caso detectar si alguien por ejemplo me está intentando eh atacar vamos a ver otro tipo de saneamiento vale el ese tipo de saneamiento que voy a ver ahora es un poquito más complicado hay otro tipo de ataques como sabréis que se llaman ataques por Fuerza bruta los ataques por Fuerza bruta lo que hacen es que en lugar de aquí en la en el usuario contraseña meterte un usuario y una contraseña mediante un programa informatizado programa que con python por ejemplo es muy sencillo de hacer pues te empiezan a probar un usuario otro usuario otro usuario a ver si en una de estas acierta vale por tanto mediante la detección de un ataque de Fuerza bruta yo lo que puedo averiguar es Cuántas peticiones por segundo me Está realizando una IP concreta por lo tanto antes de explicaros Cómo detectar ataques de Fuerza bruta lo primero que tengo que hacer es explicaros Cómo registrar las ips y la información del usuario el año pasado de hecho si os acordáis allá por antes de Navidad primer trimestre hicisteis un examen de bases de datos que tapa precisamente del análisis de registros de una aplicación informática pues hoy vamos a ver cómo hacer ese registro para hacer el registro para ello voy a ir aquí a hedit me voy a ir a e segundo me voy a ir a servicios y procesos Tas de programación prácticas de programación segura y voy a hacer una segunda carpeta llamada variable servidor y lo Vais a flipar esto no va aquí y v qué rollo a ver va para arriba y 002 variable servidor vale lo Vais a flipar Porque si yo hago un archivo nuevo vomito variable servidor php Yo vengo por aquí y digo bar doom y Quiero llamar a la super variable a la super global server por supuesto esto lo estoy haciendo en php pero se puede hacer igual en python en node en Java Enterprise en lo que queráis vale es igual en cualquier sistema de servidor Así que vengo por aquí me voy un momento a segundo me voy un momento a servicios y procesos me voy a técnicas de programación segura me voy a variable de servidor Y entonces ocurre esto y es que con la variable de servidor si os fijáis yo puedo saber aquí yo puedo saber todo lo que tiene el servidor como esto es un poco difícil de leer vale porque esto es como os diría yo esto es un vomitado de una array Pues yo a continuación lo que voy a hacer es un for Así que 002 for each y digo for each server as clave valor y entonces voy a poner eco clave valor br y vamos a verlo y entonces aquí lo podéis ver mejor resulta que puedo atrapar la plataforma en la que estoy puedo atrapar el navegador con el cual me están visitando puedo atrapar de mi usuario del usuario que me visita puedo trapar su motor de navegador su sistema de ventanas su sistema operativo su insisto su motor el motor Apple webkit el navegador con el que me está visitando e incluso la versión concreta puedo ver lo que acepta ese navegador puedo ver el fetch site es decir el modo de fetch puedo ver el server address y puedo ver el Remote address es la ip de la máquina que me está visitando puedo ver dónde tengo el document rot puedo ver si me está visitando por http o https puedo ver el admin o sea el correo del servidor no es mucho problema porque soy yo mismo vale puedo ver el puerto remoto puedo ver qu URL estoy inspeccionando así que puedo verlo Prácticamente todo e incluso puedo ver el request Time vale en época unix es decir los segundos que han pasado y en float vale los microsegundos que han pasado en la era unix bien Eso quiere decir que yo a continuación lo que puedo hacer es todo esto y meterlo dónde Vale pues esta es la cuestión Eh no os voy a dar una respuesta universalmente válida acerca de dónde meter esto porque hay una alternativa que consiste en meterlo en la base de datos si yo lo meto en la base de datos lo que va a ocurrir os lo digo ya creedme si no lo podemos probar y lo veréis en el transcurso de un poco de tiempo es que el 99% del contenido de la base de datos sean los registros lo podemos también meter en un archivo pero claro luego cuando queremos hacer un recuento de cosas pues el hecho de que est un archivo hace que el recuento sea más complejo Que si lo metemos en una base de datos mysql que luego hacer búsquedas Como por ejemplo Dime cuántas veces he intentado entrar este usuario pues sea peor vale yo de momento lo que voy a hacer es que lo voy a meter dentro de la base de datos Así que para ello me voy a ir un momento a la base de datos me voy a ir a php my admin me voy a ir a Root me voy a ir a crimson me voy a crear una nueva tabla la voy a llamar registros Y esa nueva tabla tendrá un identificador y tendrá una fecha un apoc lo voy a llamar y voy a decir que quiero saber la IP del cliente que me visita momento aquí Quiero saber el user agent Quiero saber el navegador que tiene ese usuario Quiero saber qué más quiero saber la página que está visitando vale el Berry Ferrer y el requestor pues no voy aquí a ttp referrer momenti Ah no aquí pues voy al request Story vale Quiero la URL y yo creo que ya yo creo que ya algo seguro que me dejo pero no pasa nada si luego me dejo algo pues lo meto y ya está vale Así que esto es un entero que voy a ponerle 20 caracteres la ip es un bar charar voy a poner 255 porque puede ser ipv4 puede ser ipv6 navegador definitivamente le voy a poner un barchart URL le voy a poner un barchart y de esta forma ahora a continuación veréis que esta es la parte de base de datos ahora a continuación lo que haré es crear el Script para que ocurra lo que ocurra en el sistema se quede registrado en la tabla de registros y veréis como esa tabla de registros pues quieras que no se va a ir poblando poquito a medida que realizamos cualquier operación vale de momento le voy a decir que quiero guardar y ya tengo aquí una tabla de registros preparada para guardar toda la información que provenga de los usuarios bien